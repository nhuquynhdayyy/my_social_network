<!-- chat/templates/chat/manage_group.html -->

{% extends "posts/base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-7">
            
            <div class="d-flex align-items-center mb-4">
                <img src="{{ conversation.avatar.url }}" class="rounded-circle me-3 border" width="60" height="60" style="object-fit: cover;">
                <h2 class="mb-0">Qu·∫£n l√Ω nh√≥m: {{ conversation.name }}</h2>
            </div>
            
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
            
            <!-- 1. C√†i ƒë·∫∑t Admin (Ch·ªâ hi·ªán cho Admin) -->
            {% if is_group_admin %}
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning text-dark">
                    <strong>‚öôÔ∏è C√†i ƒë·∫∑t qu·∫£n tr·ªã</strong>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <div class="form-check form-switch">
                            {{ settings_form.admin_only_management }}
                            <label class="form-check-label" for="{{ settings_form.admin_only_management.id_for_label }}">
                                {{ settings_form.admin_only_management.label }}
                            </label>
                        </div>
                        <button type="submit" name="toggle_admin_mode" class="btn btn-primary mt-3">L∆∞u c√†i ƒë·∫∑t</button>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- 2. Danh s√°ch y√™u c·∫ßu ch·ªù duy·ªát -->
            {% if is_group_admin and pending_requests %}
            <div class="card mb-4 border-info">
                <div class="card-header bg-info text-white">
                    <strong>üîî Y√™u c·∫ßu tham gia ch·ªù duy·ªát ({{ pending_requests|length }})</strong>
                </div>
                <ul class="list-group list-group-flush">
                    {% for req in pending_requests %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ req.user_to_add.get_full_name }}</strong>
                            <div class="text-muted small">M·ªùi b·ªüi: {{ req.invited_by.get_full_name }}</div>
                        </div>
                        <div>
                            <a href="{% url 'chat:handle_request' request_id=req.id action='approve' %}" class="btn btn-success btn-sm">Duy·ªát</a>
                            <a href="{% url 'chat:handle_request' request_id=req.id action='reject' %}" class="btn btn-outline-danger btn-sm">T·ª´ ch·ªëi</a>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <!-- 3. C·∫≠p nh·∫≠t th√¥ng tin nh√≥m -->
            <div class="card mb-4">
                <div class="card-header">Th√¥ng tin nh√≥m</div>
                <div class="card-body">
                    {% if conversation.admin_only_management and not is_group_admin %}
                        <div class="alert alert-secondary mb-0">
                            üîí Nh√≥m n√†y ƒëang b·∫≠t ch·∫ø ƒë·ªô <strong>ch·ªâ Qu·∫£n tr·ªã vi√™n</strong> m·ªõi ƒë∆∞·ª£c thay ƒë·ªïi t√™n v√† ·∫£nh ƒë·∫°i di·ªán.
                        </div>
                    {% else %}
                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            {{ update_info_form.as_p }}
                            <button type="submit" name="update_group_info" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
                        </form>
                    {% endif %}
                </div>
            </div>

            <!-- 4. Th√™m th√†nh vi√™n -->
            <div class="card">
                <div class="card-header">Th√™m th√†nh vi√™n m·ªõi</div>
                <div class="card-body">
                    {% if conversation.admin_only_management and not is_group_admin %}
                        <div class="alert alert-warning py-2">
                            <small>‚ö†Ô∏è Nh√≥m ƒëang b·∫≠t ki·ªÉm duy·ªát. Th√†nh vi√™n b·∫°n m·ªùi s·∫Ω c·∫ßn Qu·∫£n tr·ªã vi√™n ph√™ duy·ªát.</small>
                        </div>
                    {% endif %}

                    <form method="post">
                        {% csrf_token %}
                        {{ add_members_form.as_p }}
                        <button type="submit" name="add_members" class="btn btn-success">
                            {% if conversation.admin_only_management and not is_group_admin %}
                                G·ª≠i y√™u c·∫ßu th√™m
                            {% else %}
                                Th√™m th√†nh vi√™n
                            {% endif %}
                        </button>
                    </form>
                </div>
            </div>
            
            <hr class="my-4">
            
            <!-- BUTTONS CU·ªêI TRANG -->
            <div class="d-flex justify-content-between">
                <div>
                    <a href="{% url 'chat:conversation_detail' conversation.id %}" class="btn btn-secondary">&laquo; Quay l·∫°i</a>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmLeaveModal">
                        R·ªùi kh·ªèi nh√≥m
                    </button>
                    
                    <!-- === N√öT X√ìA NH√ìM (Ch·ªâ Admin th·∫•y) === -->
                    {% if is_group_admin %}
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteGroupModal">
                        üóëÔ∏è X√≥a nh√≥m vƒ©nh vi·ªÖn
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal x√°c nh·∫≠n R·ªùi nh√≥m -->
<div class="modal fade" id="confirmLeaveModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">X√°c nh·∫≠n r·ªùi kh·ªèi nh√≥m</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën r·ªùi kh·ªèi nh√≥m **"{{ conversation.name }}"** kh√¥ng?
        {% if is_group_admin and conversation.participants.count > 1 %}
            <div class="alert alert-warning mt-3">L∆∞u √Ω: B·∫°n ƒëang l√† qu·∫£n tr·ªã vi√™n. Sau khi b·∫°n r·ªùi ƒëi, quy·ªÅn qu·∫£n tr·ªã s·∫Ω ƒë∆∞·ª£c chuy·ªÉn cho m·ªôt th√†nh vi√™n kh√°c.</div>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
        <form method="post" action="{% url 'chat:leave_group' conversation.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">R·ªùi nh√≥m</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- === MODAL X√ÅC NH·∫¨N X√ìA NH√ìM === -->
{% if is_group_admin %}
<div class="modal fade" id="confirmDeleteGroupModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">‚ö†Ô∏è C·∫¢NH B√ÅO: X√≥a nh√≥m vƒ©nh vi·ªÖn</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>B·∫°n ƒëang chu·∫©n b·ªã x√≥a nh√≥m <strong>"{{ conversation.name }}"</strong>.</p>
        <p class="text-danger fw-bold">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>
        <p>To√†n b·ªô tin nh·∫Øn v√† d·ªØ li·ªáu c·ªßa nh√≥m s·∫Ω b·ªã x√≥a s·∫°ch kh·ªèi h·ªá th·ªëng cho t·∫•t c·∫£ th√†nh vi√™n.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy, t√¥i ·∫•n nh·∫ßm</button>
        <!-- Form x√≥a nh√≥m (name="delete_group") -->
        <form method="post">
            {% csrf_token %}
            <button type="submit" name="delete_group" class="btn btn-danger fw-bold">T√¥i ch·∫Øc ch·∫Øn, X√≥a ngay</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% endblock content %}
{% block extra_js %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        new TomSelect('select[multiple]', {
            plugins: ['remove_button'],
            create: false,
            placeholder: 'T√¨m v√† ch·ªçn th√†nh vi√™n...'
            dropdownParent: 'body'
        });
    });
</script>
{% endblock extra_js %}