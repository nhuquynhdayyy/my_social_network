{% extends "posts/base.html" %}

{% block chat_widget %}
{% endblock %}

{% block content %}

<style>
    .ts-dropdown, .ts-control {
        z-index: 9999 !important; /* ƒê·∫£m b·∫£o cao h∆°n Modal (z-index 1055) */
    }
    
    /* T√πy ch·ªânh cho ƒë·∫πp gi·ªëng b√™n detail (Optional) */
    .ts-control {
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 0.95rem;
    }
    /* =================================================================
       PH·∫¶N 1: THU NH·ªé SIDEBAR CH√çNH 
       ================================================================= */
    .sidebar { width: 72px !important; padding: 12px 12px !important; border-right: 1px solid #dbdbdb; }
    .sidebar-nav li a span { display: none !important; }
    .sidebar-nav li a { justify-content: center !important; padding: 12px 0 !important; }
    .sidebar-nav .nav-icon { margin-right: 0 !important; width: 28px; height: 28px; }
    .sidebar-brand { display: none !important; }
    .main-content { margin-left: 72px !important; padding: 0 !important; width: calc(100% - 72px) !important; }

    /* =================================================================
       PH·∫¶N 2: GIAO DI·ªÜN DANH S√ÅCH CHAT
       ================================================================= */
    body { background-color: #fff; }
    
    .chat-layout {
        display: flex;
        height: 100vh;
        max-width: 100%;
        background: #fff;
    }

    /* --- C·ªòT TR√ÅI (FULL) --- */
    .chat-sidebar {
        width: 350px;
        border-right: 1px solid #dbdbdb;
        display: flex;
        flex-direction: column;
        background: #fff;
    }

    .sidebar-header {
        height: 75px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        border-bottom: 1px solid #dbdbdb;
    }
    .sidebar-title { font-weight: 700; font-size: 1.2rem; margin: 0; }
    
    .header-actions { display: flex; gap: 15px; align-items: center; }
    
    /* Icon Button Style */
    .btn-header-icon {
        background: none; border: none; padding: 0; cursor: pointer; color: #000;
        display: flex; align-items: center;
    }

    /* THANH T√åM KI·∫æM (·∫®n m·∫∑c ƒë·ªãnh) */
    .search-bar-container {
        display: none; padding: 10px 15px; background: #fff; border-bottom: 1px solid #f0f0f0;
    }
    .search-bar-container input {
        width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; background: #efefef; outline: none;
    }

    .conv-list { flex: 1; overflow-y: auto; }
    
    .conv-item {
        display: flex; align-items: center; padding: 12px 20px;
        cursor: pointer; text-decoration: none; color: #000;
        transition: background 0.1s;
    }
    .conv-item:hover { background-color: #fafafa; }
    
    .conv-avatar { width: 56px; height: 56px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
    .conv-info { flex: 1; overflow: hidden; }
    .conv-name { font-size: 0.95rem; font-weight: 500; }
    .conv-last { font-size: 0.85rem; color: #8e8e8e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* --- C·ªòT PH·∫¢I (M√ÄN H√åNH CH·ªú) --- */
    .chat-empty {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .btn-primary-ig {
        background-color: #0095f6; color: white; border: none;
        padding: 7px 16px; border-radius: 8px; font-weight: 600;
    }

    /* SEARCH USER MODAL */
    .search-result-item {
        display: flex; align-items: center; padding: 10px;
        border-bottom: 1px solid #eee; text-decoration: none; color: #000;
    }
    .search-result-item:hover { background-color: #f0f2f5; }
    .search-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }

    /* CSS CHO MODAL T·∫†O NH√ìM ƒê·∫∏P H∆†N */
    .group-modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .group-modal-header {
        border-bottom: 1px solid #dbdbdb;
        padding: 15px 20px;
    }
    .group-modal-body {
        padding: 20px;
    }
    .form-group-label {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 5px;
        color: #262626;
    }
    .form-control-custom {
        background-color: #fafafa;
        border: 1px solid #dbdbdb;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 0.95rem;
    }
    .form-control-custom:focus {
        border-color: #a8a8a8;
        box-shadow: none;
        background-color: #fff;
    }
    .notification-panel {
        left: 73px !important; /* Sidebar chat r·ªông 72px + 1px border = 73px */
    }

    /* ƒê·∫£m b·∫£o panel ƒë√® l√™n danh s√°ch chat nh∆∞ng n·∫±m d∆∞·ªõi sidebar */
    .chat-layout {
        position: relative; 
        z-index: 1;
    }
</style>

<div class="chat-layout">
    <!-- C·ªòT TR√ÅI -->
    <div class="chat-sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title">{{ user.username }}</span>
            
            <div class="header-actions">
                <!-- 1. ICON T√åM KI·∫æM -->
                <button class="btn-header-icon" id="toggle-search-list-btn" title="T√¨m ki·∫øm ƒëo·∫°n chat">
                    <svg aria-label="Search" fill="currentColor" height="24" role="img" viewBox="0 0 24 24" width="24"><path d="M19 10.5A8.5 8.5 0 1 1 10.5 2a8.5 8.5 0 0 1 8.5 8.5Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path><line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="16.511" x2="22" y1="16.511" y2="22"></line></svg>
                </button>

                <!-- 2. ICON SO·∫†N TIN M·ªöI -->
                <button class="btn-header-icon" data-bs-toggle="modal" data-bs-target="#newMsgModal" title="So·∫°n tin m·ªõi">
                    <svg aria-label="New message" fill="currentColor" height="24" role="img" viewBox="0 0 24 24" width="24">
                        <path d="M12.202 3.203H5.25a3 3 0 0 0-3 3V18.75a3 3 0 0 0 3 3h12.5a3 3 0 0 0 3-3v-6.94l-8.546-8.607zm6.81 1.252l-6.814 6.814V4.46l6.814-6.814zm-5.602 11.235l-2.768-2.768 8.845-8.845 2.768 2.768-8.845 8.845z"></path>
                        <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- THANH INPUT T√åM KI·∫æM -->
        <div class="search-bar-container" id="list-search-bar">
            <input type="text" id="filter-list-input" placeholder="T√¨m ng∆∞·ªùi ho·∫∑c nh√≥m...">
        </div>
        
        <div class="conv-list" id="conversation-list-wrapper">
            {% for conv in conversations %}
            <a href="{% url 'chat:conversation_detail' conv.id %}" class="conv-item">
                {% if conv.type == 'GROUP' %}
                    <img src="{{ conv.avatar.url }}" class="conv-avatar" alt="Group">
                    <div class="conv-info">
                        <div class="conv-name">{{ conv.name }}</div>
                        <div class="conv-last">
                            {% if conv.last_message %}
                                {% if conv.last_message.sender == request.user %}B·∫°n: {% endif %}{{ conv.last_message.text|default:"File ƒë√≠nh k√®m" }}
                            {% else %}Nh√≥m m·ªõi{% endif %}
                        </div>
                    </div>
                {% else %}
                    {% for participant in conv.participants.all %}
                        {% if participant != request.user %}
                        <img src="{{ participant.avatar.url }}" class="conv-avatar" alt="{{ participant.username }}">
                        <div class="conv-info">
                            <div class="conv-name">{{ participant.first_name }} {{ participant.last_name }}</div>
                            <div class="conv-last">
                                {% if conv.last_message %}
                                    {% if conv.last_message.sender == request.user %}B·∫°n: {% endif %}{{ conv.last_message.text|default:"File ƒë√≠nh k√®m" }}
                                {% else %}B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán{% endif %}
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </a>
            {% empty %}
                <div class="text-center mt-5 text-muted">Ch∆∞a c√≥ tin nh·∫Øn n√†o</div>
            {% endfor %}
            <p id="no-result-msg" class="text-center text-muted mt-3 small d-none">Kh√¥ng t√¨m th·∫•y cu·ªôc tr√≤ chuy·ªán n√†o.</p>
        </div>
    </div>

    <!-- C·ªòT PH·∫¢I (CH·ªú) -->
    <div class="chat-empty">
        <svg aria-label="Direct" fill="currentColor" height="96" role="img" viewBox="0 0 96 96" width="96"><circle cx="48" cy="48" fill="none" r="47" stroke="currentColor" stroke-miterlimit="10" stroke-width="2"></circle><path d="M47.8 3.8c-24.3 0-44 19.7-44 44s19.7 44 44 44 44-19.7 44-44-44-44-44-44zm0 84.8c-22.5 0-40.8-18.3-40.8-40.8S25.3 7 47.8 7 88.6 25.3 88.6 47.8 70.3 88.6 47.8 88.6z"></path><path d="M74.3 33.5L26.8 22.3a2.4 2.4 0 00-3.1 3.1l11.2 47.5a2.4 2.4 0 004.5 0l6.7-22.1 22.1-6.7a2.4 2.4 0 000-4.6zM54.7 46.9l-16.1 4.9 4.9-16.1 23.3-8-12.1 19.2z"></path></svg>
        <h3 class="fw-light mt-3">Tin nh·∫Øn c·ªßa b·∫°n</h3>
        <p class="text-muted">G·ª≠i ·∫£nh v√† tin nh·∫Øn ri√™ng t∆∞ cho b·∫°n b√®.</p>
        <button class="btn btn-primary-ig mt-2" data-bs-toggle="modal" data-bs-target="#newMsgModal">G·ª≠i tin nh·∫Øn</button>
    </div>
</div>

<!-- ============================================= -->
<!-- MODAL T√åM KI·∫æM NG∆Ø·ªúI D√ôNG (NEW MESSAGE)       -->
<!-- ============================================= -->
<div class="modal fade" id="newMsgModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content group-modal-content">
            <div class="modal-header group-modal-header">
                <h5 class="modal-title fw-bold" style="font-size: 1.1rem;">Tin nh·∫Øn m·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body group-modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control form-control-custom" id="userSearchInput" placeholder="T√¨m ki·∫øm ng∆∞·ªùi d√πng..." autocomplete="off">
                </div>
                <div id="searchResultList" style="max-height: 300px; overflow-y: auto;">
                    <p class="text-center text-muted mt-3 small">Nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm...</p>
                </div>
            </div>
            <!-- FOOTER CH·ª®A N√öT T·∫†O NH√ìM -->
            <div class="modal-footer border-0 justify-content-center pt-0">
                <!-- Thay ƒë·ªïi: data-bs-toggle v√† target ƒë·ªÉ m·ªü Modal t·∫°o nh√≥m -->
                <button class="btn btn-link text-decoration-none fw-bold" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                    üë• T·∫°o nh√≥m chat m·ªõi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================= -->
<!-- MODAL T·∫†O NH√ìM (M·ªöI TH√äM V√ÄO)                 -->
<!-- ============================================= -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content group-modal-content">
            <form method="post" enctype="multipart/form-data" action="{% url 'chat:create_group' %}">
                {% csrf_token %}
                <div class="modal-header group-modal-header bg-light">
                    <h5 class="modal-title fw-bold" style="font-size: 1.1rem;">T·∫°o nh√≥m tr√≤ chuy·ªán</h5>
                    <!-- N√∫t back ƒë·ªÉ quay l·∫°i modal t√¨m ki·∫øm n·∫øu mu·ªën -->
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body group-modal-body">
                    <!-- T√™n nh√≥m -->
                    <div class="mb-3">
                        <label class="form-group-label">T√™n nh√≥m</label>
                        {{ group_creation_form.name }}
                    </div>

                    <!-- ·∫¢nh ƒë·∫°i di·ªán -->
                    <div class="mb-3">
                        <label class="form-group-label">·∫¢nh ƒë·∫°i di·ªán</label>
                        {{ group_creation_form.avatar }}
                    </div>

                    <!-- Ch·ªçn th√†nh vi√™n -->
                    <div class="mb-3">
                        <label class="form-group-label">Ch·ªçn th√†nh vi√™n</label>
                        <div class="small text-muted mb-1">(Ch·ªçn √≠t nh·∫•t 2 ng∆∞·ªùi)</div>
                        <!-- Render field participants, class form-control ƒë√£ ƒë∆∞·ª£c set trong forms.py -->
                        {{ group_creation_form.participants }}
                    </div>
                </div>

                <div class="modal-footer border-0 bg-light rounded-bottom">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-primary btn-sm px-4 fw-bold">T·∫°o nh√≥m</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- CSS cho TomSelect ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp trong modal -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

{% endblock content %}


{% block extra_js %}
<script>
    // --- ƒêO·∫†N M√É M·ªöI: HI·ªÇN TH·ªä TH√îNG B√ÅO T·ª™ SERVER (DJANGO MESSAGES) ---
    document.addEventListener("DOMContentLoaded", function() {
        {% if messages %}
            {% for message in messages %}
                // Chuy·ªÉn ƒë·ªïi tag c·ªßa Django sang m√†u c·ªßa Bootstrap
                // Django d√πng 'error', Bootstrap d√πng 'danger' cho m√†u ƒë·ªè
                var type = "{{ message.tags }}";
                if (type === 'error') type = 'danger'; 
                
                // G·ªçi h√†m showToast ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ·ªü base.html
                if (typeof showToast === 'function') {
                    showToast("{{ message|safe }}", type);
                } else {
                    alert("{{ message|safe }}"); // Fallback n·∫øu showToast ch∆∞a load k·ªãp
                }
            {% endfor %}
        {% endif %}
    });
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
// --- 1. X·ª¨ L√ù L·ªåC DANH S√ÅCH CHAT ---
        const toggleBtn = document.getElementById('toggle-search-list-btn');
        const searchBar = document.getElementById('list-search-bar');
        const filterInput = document.getElementById('filter-list-input');
        const convItems = document.querySelectorAll('.conv-item');
        const noResultMsg = document.getElementById('no-result-msg');

        // B·∫≠t t·∫Øt thanh t√¨m ki·∫øm
        toggleBtn.addEventListener('click', function() {
            if (searchBar.style.display === 'block') {
                searchBar.style.display = 'none';
                filterInput.value = ''; // X√≥a ch·ªØ
                convItems.forEach(item => item.style.display = 'flex');
                noResultMsg.classList.add('d-none');
            } else {
                searchBar.style.display = 'block';
                filterInput.focus();
            }
        });

        // L·ªçc danh s√°ch khi g√µ
        filterInput.addEventListener('keyup', function() {
            const query = this.value.toLowerCase().trim();
            let hasResult = false;
            convItems.forEach(item => {
                const name = item.querySelector('.conv-name').innerText.toLowerCase();
                if (name.includes(query)) {
                    item.style.display = 'flex';
                    hasResult = true;
                } else {
                    item.style.display = 'none';
                }
            });
            if (!hasResult) noResultMsg.classList.remove('d-none');
            else noResultMsg.classList.add('d-none');
        });

        // --- 2. X·ª¨ L√ù T√åM KI·∫æM NG∆Ø·ªúI D√ôNG (MODAL NEW MESSAGE) ---
        const userSearchInput = document.getElementById('userSearchInput');
        if(userSearchInput){
            userSearchInput.addEventListener('keyup', function() {
                let query = this.value.trim();
                let resultList = document.getElementById('searchResultList');
                if(query.length < 1) {
                    resultList.innerHTML = '<p class="text-center text-muted mt-3 small">Nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm...</p>'; return;
                }
                fetch(`{% url 'chat:api_search_users' %}?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    resultList.innerHTML = '';
                    if(data.users.length > 0) {
                        data.users.forEach(user => {
                            let avatarSrc = user.avatar_url ? user.avatar_url : '/media/default.jpg';
                            
                            resultList.innerHTML += `
                                <a href="${user.start_conversation_url}" class="search-result-item">
                                    <img src="${avatarSrc}" class="search-avatar" onerror="this.src='https://via.placeholder.com/40'">
                                    <div>
                                        <div class="fw-bold">${user.username}</div>
                                        <div class="text-muted small">${user.full_name}</div>
                                    </div>
                                </a>
                            `;
                        });
                    } else {
                        resultList.innerHTML = '<p class="text-center text-muted mt-3">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng.</p>';
                    }
                });
            });
        }

        // --- 3. KH·ªûI T·∫†O TOM SELECT CHO MODAL T·∫†O NH√ìM ---
        // Ch√∫ng ta c·∫ßn kh·ªüi t·∫°o n√≥ khi modal m·ªü ra ho·∫∑c kh·ªüi t·∫°o lu√¥n n·∫øu element t·ªìn t·∫°i
        const participantsSelect = document.getElementById('id_participants');
        if (participantsSelect) {
            new TomSelect('#id_participants', {
                plugins: ['remove_button'],
                create: false,
                placeholder: 'T√¨m v√† ch·ªçn th√†nh vi√™n...',
                maxItems: null,
                dropdownParent: 'body' // Quan tr·ªçng ƒë·ªÉ dropdown hi·ªÉn th·ªã ƒë√® l√™n modal
            });
        }
        
    const searchInput = document.getElementById('conversationSearchInput');
    const searchResultsContainer = document.getElementById('search-results-container');
    const searchResultsList = document.getElementById('searchResultsList');
    const originalListContainer = document.getElementById('conversation-list-container');
    const clearSearchBtn = document.getElementById('clear-search-btn');
    
    // TH√äM ·ªû ƒê√ÇY: L·∫•y n√∫t "So·∫°n tin m·ªõi"
    const composeBtn = document.getElementById('compose-new-message-btn');

    let searchTimeout;

    // TH√äM ·ªû ƒê√ÇY: G·∫Øn h√†nh ƒë·ªông cho n√∫t "So·∫°n tin m·ªõi"
    composeBtn.addEventListener('click', function() {
        // 1. ƒê∆∞a con tr·ªè v√†o √¥ t√¨m ki·∫øm
        searchInput.focus();

        // 2. ·∫®n danh s√°ch c≈© v√† hi·ªán khu v·ª±c t√¨m ki·∫øm
        originalListContainer.style.display = 'none';
        searchResultsContainer.style.display = 'block';

        // 3. Hi·ªÉn th·ªã m·ªôt th√¥ng b√°o h∆∞·ªõng d·∫´n
        if (searchInput.value.trim() === '') {
            searchResultsList.innerHTML = '<p class="text-center text-muted p-3">B·∫Øt ƒë·∫ßu t√¨m ki·∫øm b·∫±ng c√°ch g√µ t√™n ng∆∞·ªùi d√πng.</p>';
        }
    });


    searchInput.addEventListener('keyup', function() {
        clearTimeout(searchTimeout);
        const query = searchInput.value.trim();

        if (query.length === 0) {
            searchResultsContainer.style.display = 'none';
            originalListContainer.style.display = 'block';
            clearSearchBtn.style.display = 'none';
            return;
        }

        clearSearchBtn.style.display = 'block';
        originalListContainer.style.display = 'none';
        searchResultsContainer.style.display = 'block';
        searchResultsList.innerHTML = '<p class="text-center text-muted p-3">ƒêang t√¨m...</p>';

        searchTimeout = setTimeout(() => {
            fetch(`{% url 'chat:api_search_users' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    searchResultsList.innerHTML = '';
                    if (data.users && data.users.length > 0) {
                        data.users.forEach(user => {
                            searchResultsList.innerHTML += `
                                <a href="${user.start_conversation_url}" class="list-group-item list-group-item-action">
                                    <div class="d-flex align-items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-person-circle text-secondary me-3" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/></svg>
                                        <div>
                                            <h5 class="mb-0">${user.full_name}</h5>
                                            <small class="text-muted">@${user.username}</small>
                                        </div>
                                    </div>
                                </a>`;
                        });
                    } else {
                        searchResultsList.innerHTML = `<p class="text-center text-muted p-3">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o kh·ªõp v·ªõi "${query}".</p>`;
                    }
                });
        }, 300);
    });

    clearSearchBtn.addEventListener('click', function() {
        searchInput.value = '';
        searchInput.focus(); // ƒê∆∞a con tr·ªè tr·ªü l·∫°i √¥ t√¨m ki·∫øm
        searchResultsList.innerHTML = '<p class="text-center text-muted p-3">B·∫Øt ƒë·∫ßu t√¨m ki·∫øm b·∫±ng c√°ch g√µ t√™n ng∆∞·ªùi d√πng.</p>';
        // Kh√¥ng hi·ªán l·∫°i danh s√°ch g·ªëc, ƒë·ªÉ ng∆∞·ªùi d√πng ti·∫øp t·ª•c t√¨m ki·∫øm
    });
});
</script>
{% endblock extra_js %}