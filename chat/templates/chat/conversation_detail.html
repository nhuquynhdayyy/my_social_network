{% extends "posts/base.html" %}
{% load post_extras %}

{% block chat_widget %}
{% endblock %}

{% block content %}
<style>
    .ts-control {
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 0.9rem;
    }
    .ts-dropdown {
        z-index: 9999 !important; /* ƒê·∫£m b·∫£o menu g·ª£i √Ω n·ªïi l√™n tr√™n c√πng */
    }
    /* 1. THU NH·ªé SIDEBAR CH√çNH WEBSITE */
    .sidebar { width: 72px !important; padding: 12px 12px !important; border-right: 1px solid #dbdbdb; }
    .sidebar-nav li a span { display: none !important; }
    .sidebar-nav li a { justify-content: center !important; padding: 12px 0 !important; }
    .sidebar-nav .nav-icon { margin-right: 0 !important; width: 28px; height: 28px; }
    .sidebar-brand { display: none !important; }
    .main-content { margin-left: 72px !important; padding: 0 !important; width: calc(100% - 72px) !important; }

    /* 2. LAYOUT CHAT 3 C·ªòT */
    body { background-color: #fff; overflow: hidden; }
    .chat-layout { display: flex; height: 100vh; background: #fff; }

    /* --- C·ªòT 1: LIST CHAT --- */
    .chat-list-sidebar { width: 350px; border-right: 1px solid #dbdbdb; display: flex; flex-direction: column; background: #fff; }
    .chat-list-header { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; border-bottom: 1px solid #dbdbdb; }
    /* Thanh t√¨m ki·∫øm ·∫©n/hi·ªán */
    .search-bar-container { display: none; padding: 10px 16px; background: #fff; border-bottom: 1px solid #f0f0f0; }
    .search-bar-container input { width: 100%; padding: 6px 12px; border-radius: 8px; border: 1px solid #ddd; background: #efefef; outline: none; }
    
    .conv-list-container { flex: 1; overflow-y: auto; }
    .conv-item { display: flex; align-items: center; padding: 10px 16px; text-decoration: none; color: #000; transition: 0.2s; }
    .conv-item:hover { background-color: #fafafa; }
    .conv-item.active { background-color: #efefef; }
    .conv-avatar { width: 48px; height: 48px; border-radius: 50%; margin-right: 12px; object-fit: cover; }
    .conv-info { flex: 1; overflow: hidden; }
    .conv-name { font-size: 0.9rem; font-weight: 500; }
    .conv-last { font-size: 0.8rem; color: #8e8e8e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* --- C·ªòT 2: MAIN CHAT AREA --- */
    .chat-main-area { flex: 1; display: flex; flex-direction: column; background: #fff; position: relative; min-width: 0; }
    .chat-header { height: 60px; border-bottom: 1px solid #dbdbdb; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0; }
    .chat-body { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; }
    .chat-footer { padding: 12px 16px; border-top: 1px solid #dbdbdb; flex-shrink: 0; }
    
    /* TIN NH·∫ÆN & ACTIONS */
    .msg-row { display: flex; margin-bottom: 8px; align-items: flex-end; position: relative; }
    .msg-row:hover .msg-actions-group { opacity: 1; visibility: visible; } 
    .msg-row.sent { flex-direction: row-reverse; }
    
    .msg-avatar-tiny { width: 28px; height: 28px; border-radius: 50%; margin: 0 8px; align-self: flex-end; object-fit: cover; }

    .msg-bubble { max-width: 65%; padding: 8px 12px; border-radius: 18px; font-size: 0.9rem; line-height: 1.4; word-wrap: break-word; position: relative; }
    .msg-row.sent .msg-bubble { background-color: #0084ff; color: white; border-bottom-right-radius: 4px; }
    .msg-row.received .msg-bubble { background-color: #f0f0f0; color: #000; border-bottom-left-radius: 4px; }

    /* Action Group (Smile, Edit, Delete) */
    .msg-actions-group {
        opacity: 0; visibility: hidden; transition: 0.2s;
        display: flex; align-items: center; gap: 5px; margin: 0 8px; align-self: center;
    }
    .btn-action-tiny {
        background: #f0f2f5; border: none; border-radius: 50%; width: 28px; height: 28px;
        display: flex; align-items: center; justify-content: center; cursor: pointer; color: #65676b; font-size: 0.9rem;
    }
    .btn-action-tiny:hover { background-color: #e4e6eb; }

    /* Reaction Popup */
    .reaction-popup {
        display: none; position: absolute; bottom: 100%; background: white; border-radius: 20px;
        padding: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 100; white-space: nowrap; gap: 5px;
    }
    .msg-row.sent .reaction-popup { right: 0; }
    .msg-row.received .reaction-popup { left: 0; }
    .reaction-popup.show { display: flex; }
    .reaction-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
    .reaction-btn:hover { transform: scale(1.3); }

    /* Reaction Display (D∆∞·ªõi tin nh·∫Øn) */
    .msg-reaction-display {
        position: absolute; bottom: -10px; background: #fff; border-radius: 10px; padding: 1px 5px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.15); font-size: 0.75rem; border: 1px solid #f0f0f0; display: flex; gap: 2px; z-index: 1;
    }
    .msg-row.sent .msg-reaction-display { right: 0; }
    .msg-row.received .msg-reaction-display { left: 0; }

    /* Edit Box */
    .edit-box { display: none; width: 65%; }
    .edit-box textarea { width: 100%; border-radius: 10px; padding: 5px; border: 1px solid #ccc; font-size: 0.9rem; }

    /* --- C·ªòT 3: RIGHT SIDEBAR (INFO) --- */
    .chat-right-sidebar { width: 0; overflow: hidden; border-left: 1px solid #dbdbdb; background: #fff; transition: width 0.3s ease; display: flex; flex-direction: column; }
    .chat-right-sidebar.open { width: 320px; }
    .right-sidebar-content { width: 320px; height: 100%; overflow-y: auto; padding: 20px; }
    .info-header { text-align: center; margin-bottom: 20px; }
    .info-avatar { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px; object-fit: cover; }
    .info-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
    .info-actions { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
    
    /* S·ª≠a l·∫°i class n√†y ƒë·ªÉ d√πng l√†m n√∫t k√≠ch ho·∫°t modal */
    .action-btn-circle { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #000; font-size: 0.8rem; cursor: pointer; background: none; border: none; }
    
    .btn-circle-icon { width: 36px; height: 36px; background: #f0f2f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; font-size: 1.2rem; }
    
    /* Accordion Style */
    .accordion-fb .accordion-item { border: none; border-bottom: 1px solid #f0f0f0; }
    .accordion-fb .accordion-button { padding: 15px 0; background: none; box-shadow: none; font-weight: 600; color: #000; }
    .accordion-fb .accordion-button:not(.collapsed) { background: none; color: #000; }
    .accordion-fb .accordion-body { padding: 10px 0; }

    .btn-icon-only { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #0095f6; padding: 5px; }
    .btn-icon-only:hover { opacity: 0.7; }
    
    /* Search Result Item (Modal) */
    .search-result-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; text-decoration: none; color: #000; }
    .search-result-item:hover { background-color: #f0f2f5; }
    .search-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }

    /* CSS CHO MODAL T·∫†O NH√ìM ƒê·∫∏P H∆†N */
    .group-modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .group-modal-header {
        border-bottom: 1px solid #dbdbdb;
        padding: 15px 20px;
    }
    .group-modal-body {
        padding: 20px;
    }
    .form-group-label {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 5px;
        color: #262626;
    }
    .notification-panel {
        left: 73px !important; /* Sidebar chat r·ªông 72px + 1px border = 73px */
    }

    /* ƒê·∫£m b·∫£o panel ƒë√® l√™n danh s√°ch chat nh∆∞ng n·∫±m d∆∞·ªõi sidebar */
    .chat-layout {
        position: relative; 
        z-index: 1;
    }
</style>

<div class="chat-layout">
    <!-- C·ªòT 1: DANH S√ÅCH CHAT -->
    <div class="chat-list-sidebar">
        <div class="chat-list-header">
            <h5 class="mb-0 fw-bold">{{ user.username }}</h5>
            <div class="d-flex align-items-center gap-2">
                <!-- ICON 1: T√åM KI·∫æM (K√≠nh l√∫p) -->
                <button class="btn-icon-only text-dark" id="toggle-search-btn" title="T√¨m ki·∫øm" style="padding: 8px;">
                    <svg aria-label="Search" fill="currentColor" height="24" role="img" viewBox="0 0 24 24" width="24">
                        <path d="M19 10.5A8.5 8.5 0 1 1 10.5 2a8.5 8.5 0 0 1 8.5 8.5Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                        <line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="16.511" x2="22" y1="16.511" y2="22"></line>
                    </svg>
                </button>
        
                <!-- ICON 2: TIN NH·∫ÆN M·ªöI (C√¢y b√∫t trong h√¨nh vu√¥ng) -->
                <button class="btn-icon-only text-dark" data-bs-toggle="modal" data-bs-target="#newMsgModal" title="Tin nh·∫Øn m·ªõi" style="padding: 8px;">
                    <svg aria-label="New message" fill="currentColor" height="24" role="img" viewBox="0 0 24 24" width="24">
                        <path d="M12.202 3.203H5.25a3 3 0 0 0-3 3V18.75a3 3 0 0 0 3 3h12.5a3 3 0 0 0 3-3v-6.94l-8.546-8.607zm6.81 1.252l-6.814 6.814V4.46l6.814-6.814zm-5.602 11.235l-2.768-2.768 8.845-8.845 2.768 2.768-8.845 8.845z"></path>
                        <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="search-bar-container" id="chat-search-bar">
            <input type="text" id="filter-conv-input" placeholder="T√¨m ng∆∞·ªùi ho·∫∑c nh√≥m...">
        </div>
        <div class="conv-list-container" id="js-conv-list">
             <div class="text-center mt-3"><div class="spinner-border spinner-border-sm"></div></div>
        </div>
    </div>

    <!-- C·ªòT 2: KHUNG CHAT CH√çNH -->
    <div class="chat-main-area">
        <div class="chat-header">
            <div class="d-flex align-items-center">
                {% if conversation.type == 'GROUP' %}
                    <img src="{{ conversation.avatar.url }}" class="rounded-circle me-2" width="40" height="40" style="object-fit: cover;">
                    <div>
                        <div class="fw-bold">{{ conversation.name }}</div>
                        <div class="small text-muted">{{ conversation.participants.count }} th√†nh vi√™n</div>
                    </div>
                {% else %}
                    <a href="{% url 'accounts:profile' username=other_participant.username %}" class="d-flex align-items-center text-decoration-none text-dark">
                        <img src="{{ other_participant.avatar.url }}" class="rounded-circle me-2" width="40" height="40" style="object-fit: cover;">
                        <div class="fw-bold">{{ other_participant.first_name }} {{ other_participant.last_name }}</div>
                    </a>
                {% endif %}
            </div>
                <button class="btn-icon-only text-dark" id="toggle-right-sidebar" title="Th√¥ng tin ƒëo·∫°n chat" style="padding: 8px;">
                    <svg aria-label="Conversation Information" fill="currentColor" height="24" role="img" viewBox="0 0 24 24" width="24">
                        <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8 8.009 8.009 0 0 1-8 8Zm0-5.5a1 1 0 0 1-1-1v-4a1 1 0 0 1 2 0v4a1 1 0 0 1-1 1Zm0-7a1 1 0 1 1 1 1 1 1 0 0 1-1-1Z"></path>
                    </svg>
                </button>
        </div>

        <div class="chat-body" id="message-container">
            {% for message in messages %}
                {% if not message.sender %}
                    <div class="text-center my-2 text-muted small" style="font-size: 0.8rem;">{{ message.text }}</div>
                {% else %}
                    <div class="msg-row {% if message.sender == user %}sent{% else %}received{% endif %}" id="msg-row-{{ message.id }}">
                        
                        {% if message.sender != user and conversation.type == 'GROUP' %}
                            <img src="{{ message.sender.avatar.url }}" class="msg-avatar-tiny" title="{{ message.sender.username }}">
                        {% endif %}

                        <!-- Bubble -->
                        <div class="msg-bubble" id="msg-bubble-{{ message.id }}">
                             {% if message.file %}
                                <div class="mb-2">
                                    {% if message.is_image %}
                                        <img src="{{ message.file.url }}" class="img-fluid rounded">
                                    {% elif message.is_video %}
                                        <video src="{{ message.file.url }}" controls class="img-fluid rounded"></video>
                                    {% else %}
                                        <a href="{{ message.file.url }}" target="_blank" class="text-break text-decoration-underline text-white">üìé {{ message.file.name }}</a>
                                    {% endif %}
                                </div>
                            {% endif %}
                            <span class="msg-text-content">{{ message.text|linebreaksbr }}</span>

                            <!-- Display Reactions -->
                            <div id="reaction-display-{{ message.id }}" class="msg-reaction-display {% if message.reactions.count == 0 %}d-none{% endif %}">
                                {% with stats=message.reactions.all %}
                                    {% if stats %}‚ù§Ô∏è {{ stats.count }}{% endif %}
                                {% endwith %}
                            </div>
                        </div>

                        <!-- Edit Box (·∫®n m·∫∑c ƒë·ªãnh) -->
                        {% if message.sender == user %}
                        <div class="edit-box" id="edit-box-{{ message.id }}">
                            <textarea id="edit-input-{{ message.id }}" rows="2">{{ message.text }}</textarea>
                            <div class="d-flex justify-content-end mt-1 gap-1">
                                <button class="btn btn-sm btn-secondary py-0" onclick="cancelEdit('{{ message.id }}')">H·ªßy</button>
                                <button class="btn btn-sm btn-primary py-0" onclick="submitEdit('{{ message.id }}')">L∆∞u</button>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Actions Group (Smile, Edit, Delete) -->
                        <div class="msg-actions-group">
                            <div class="position-relative">
                                <button class="btn-action-tiny" onclick="toggleReactionPopup('{{ message.id }}')">‚ò∫</button>
                                <!-- Popup Emoji -->
                                <div class="reaction-popup" id="reaction-popup-{{ message.id }}">
                                    <button class="reaction-btn" onclick="reactToMsg('{{ message.id }}', 'LOVE')">‚ù§Ô∏è</button>
                                    <button class="reaction-btn" onclick="reactToMsg('{{ message.id }}', 'HAHA')">üòÇ</button>
                                    <button class="reaction-btn" onclick="reactToMsg('{{ message.id }}', 'WOW')">üòÆ</button>
                                    <button class="reaction-btn" onclick="reactToMsg('{{ message.id }}', 'SAD')">üò¢</button>
                                    <button class="reaction-btn" onclick="reactToMsg('{{ message.id }}', 'ANGRY')">üò°</button>
                                    <button class="reaction-btn" onclick="reactToMsg('{{ message.id }}', 'LIKE')">üëç</button>
                                </div>
                            </div>
                            
                            {% if message.sender == user %}
                                <button class="btn-action-tiny" onclick="showEdit('{{ message.id }}')">‚úé</button>
                                <button class="btn-action-tiny text-danger" onclick="deleteMsg('{{ message.id }}')">üóë</button>
                            {% endif %}
                        </div>

                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <div class="chat-footer">
            <form id="message-form" method="post" enctype="multipart/form-data" action="{% url 'chat:send_message_api' conversation.id %}" class="d-flex align-items-center w-100">
                {% csrf_token %}
                <label for="chat-file-input" class="btn-icon-only me-2" style="cursor: pointer;">üì∑</label>
                <input type="file" name="file" id="chat-file-input" class="d-none">
                <input type="text" name="text" class="form-control rounded-pill border-0 bg-light" placeholder="Nh·∫Øn tin..." autocomplete="off">
                <button type="submit" class="btn-icon-only ms-2 text-primary fw-bold" style="font-size: 1rem;">G·ª≠i</button>
            </form>
            <div id="file-preview-container" class="d-none small text-muted mt-1 ps-5">
                ƒê√£ ch·ªçn: <span id="file-name-preview" class="fw-bold"></span>
                <button type="button" id="clear-file-btn" class="btn btn-sm btn-link text-danger p-0 ms-2">X√≥a</button>
            </div>
        </div>
    </div>

    <!-- C·ªòT 3: RIGHT SIDEBAR (TH√îNG TIN) -->
    <div class="chat-right-sidebar" id="right-sidebar">
        <div class="right-sidebar-content">
            <div class="info-header">
                {% if conversation.type == 'GROUP' %}
                    <img src="{{ conversation.avatar.url }}" class="info-avatar">
                    <div class="info-name">{{ conversation.name }}</div>
                {% else %}
                    <img src="{{ other_participant.avatar.url }}" class="info-avatar">
                    <div class="info-name">{{ other_participant.first_name }} {{ other_participant.last_name }}</div>
                    <div class="text-muted small">@{{ other_participant.username }}</div>
                {% endif %}
            </div>

            <div class="info-actions">
                {% if conversation.type == 'PRIVATE' %}
                    <a href="{% url 'accounts:profile' username=other_participant.username %}" class="action-btn-circle">
                        <div class="btn-circle-icon">üë§</div> <span>Trang c√° nh√¢n</span>
                    </a>
                    
                    <!-- THAY ƒê·ªîI: S·ª≠ d·ª•ng Modal thay v√¨ chuy·ªÉn h∆∞·ªõng -->
                    <button type="button" class="action-btn-circle" data-bs-toggle="modal" data-bs-target="#createGroupModal" data-preselect-user="{{ other_participant.id }}">
                        <div class="btn-circle-icon">üë•</div> <span>T·∫°o nh√≥m</span>
                    </button>
                {% endif %}
            </div>

            {% if conversation.type == 'GROUP' %}
            <div class="accordion accordion-fb" id="chatInfoAccordion">
                <!-- T√πy ch·ªânh ƒëo·∫°n chat -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCustomize">
                            T√πy ch·ªânh ƒëo·∫°n chat
                        </button>
                    </h2>
                    <div id="collapseCustomize" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            {% if conversation.admin_only_management and not is_group_admin %}
                                <div class="alert alert-secondary py-1 small">üîí Ch·ªâ Admin ƒë∆∞·ª£c thay ƒë·ªïi.</div>
                            {% else %}
                                <form method="post" enctype="multipart/form-data" action="{% url 'chat:manage_group' conversation.id %}">
                                    {% csrf_token %}
                                    <div class="mb-2">
                                        <label class="form-label small text-muted">T√™n nh√≥m</label>
                                        {{ update_info_form.name }}
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small text-muted">·∫¢nh nh√≥m</label>
                                        {{ update_info_form.avatar }}
                                    </div>
                                    <button type="submit" name="update_group_info" class="btn btn-primary btn-sm w-100">L∆∞u</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Th√†nh vi√™n -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMembers">
                            Th√†nh vi√™n nh√≥m
                        </button>
                    </h2>
                    <div id="collapseMembers" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <button class="btn btn-light btn-sm w-100 mb-3 fw-bold text-start" type="button" data-bs-toggle="collapse" data-bs-target="#addMemberForm">+ Th√™m ng∆∞·ªùi</button>
                            <div class="collapse mb-3" id="addMemberForm">
                                <form method="post" action="{% url 'chat:manage_group' conversation.id %}">
                                    {% csrf_token %}
                                    <small class="text-muted d-block mb-1">Ch·ªçn ng∆∞·ªùi:</small>
                                    {{ add_members_form.new_members }}
                                    <button type="submit" name="add_members" class="btn btn-success btn-sm w-100 mt-2">Th√™m</button>
                                </form>
                            </div>
                            <ul class="list-unstyled">
                                {% for member in participants %}
                                <li class="d-flex justify-content-between align-items-center mb-2">
                                    <!-- 1. Avatar v√† T√™n -->
                                    <div class="d-flex align-items-center">
                                        <img src="{{ member.avatar.url }}" class="rounded-circle me-2" width="32" height="32" style="object-fit: cover;">
                                        <div>
                                            <div class="small fw-bold">
                                                <a href="{% url 'accounts:profile' username=member.username %}" class="text-decoration-none text-dark">
                                                    {{ member.first_name }} {{ member.last_name }}
                                                </a>
                                            </div>
                                            {% if member == conversation.admin %}
                                                <div class="badge bg-secondary" style="font-size: 0.6rem;">QTV</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                
                                    <!-- 2. N√∫t 3 ch·∫•m (Menu h√†nh ƒë·ªông) -->
                                    {% if member != request.user %}
                                        <div class="dropdown">
                                            <button class="btn btn-light btn-sm rounded-circle d-flex align-items-center justify-content-center"
                                                    style="width: 32px; height: 32px;"
                                                    type="button"
                                                    data-bs-toggle="dropdown"
                                                    aria-expanded="false">
                                                <svg aria-label="More" fill="currentColor" height="16" role="img" viewBox="0 0 24 24" width="16">
                                                    <circle cx="12" cy="12" r="1.5"></circle>
                                                    <circle cx="12" cy="6" r="1.5"></circle>
                                                    <circle cx="12" cy="18" r="1.5"></circle>
                                                </svg>
                                            </button>
                                            
                                            <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                                <li>
                                                    <a class="dropdown-item" href="{% url 'chat:start_conversation' user_id=member.id %}">
                                                        üí¨ Nh·∫Øn tin
                                                    </a>
                                                </li>
                                                {% if is_group_admin or not conversation.admin_only_management %}
                                                    {% if member != conversation.admin %}
                                                        <li>
                                                            <a class="dropdown-item text-danger fw-bold" 
                                                            href="{% url 'chat:remove_member' conversation.id member.id %}" 
                                                            onclick="return confirm('X√≥a th√†nh vi√™n n√†y?')">
                                                            üóëÔ∏è X√≥a kh·ªèi nh√≥m
                                                            </a>
                                                        </li>
                                                    {% endif %}
                                                {% endif %}
                                            </ul>
                                        </div>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                            {% if is_group_admin and pending_requests %}
                             <div class="mt-3 border-top pt-2">
                                 <h6 class="small fw-bold text-warning">Y√™u c·∫ßu ch·ªù duy·ªát:</h6>
                                 {% for req in pending_requests %}
                                     <div class="d-flex justify-content-between align-items-center mb-1">
                                         <small>{{ req.user_to_add.username }}</small>
                                         <div>
                                             <a href="{% url 'chat:handle_request' req.id 'approve' %}" class="btn btn-success btn-sm py-0 px-1">‚úì</a>
                                             <a href="{% url 'chat:handle_request' req.id 'reject' %}" class="btn btn-danger btn-sm py-0 px-1">‚úï</a>
                                         </div>
                                     </div>
                                 {% endfor %}
                             </div>
                             {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Quy·ªÅn ri√™ng t∆∞ -->
                <div class="accordion-item">
                     <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePrivacy">
                            Quy·ªÅn ri√™ng t∆∞ & H·ªó tr·ª£
                        </button>
                    </h2>
                    <div id="collapsePrivacy" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            {% if is_group_admin %}
                            <form method="post" action="{% url 'chat:manage_group' conversation.id %}" class="mb-3">
                                {% csrf_token %}
                                <div class="form-check form-switch">
                                    {{ settings_form.admin_only_management }}
                                    <label class="form-check-label small" for="{{ settings_form.admin_only_management.id_for_label }}">Ki·ªÉm duy·ªát th√†nh vi√™n</label>
                                </div>
                                <button type="submit" name="toggle_admin_mode" class="btn btn-outline-secondary btn-sm mt-1 w-100">L∆∞u c√†i ƒë·∫∑t</button>
                            </form>
                            {% endif %}

                            <form method="post" action="{% url 'chat:leave_group' conversation.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-light text-danger w-100 text-start fw-bold mb-1" onclick="return confirm('R·ªùi nh√≥m?');">üö™ R·ªùi kh·ªèi nh√≥m</button>
                            </form>

                            {% if is_group_admin %}
                            <form method="post" action="{% url 'chat:manage_group' conversation.id %}">
                                {% csrf_token %}
                                <button type="submit" name="delete_group" class="btn btn-light text-danger w-100 text-start fw-bold" onclick="return confirm('X√≥a vƒ©nh vi·ªÖn nh√≥m n√†y?');">‚ö†Ô∏è X√≥a nh√≥m</button>
                            </form>
                            {% endif %}
                        </div>
                     </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ============================================= -->
<!-- MODAL T√åM KI·∫æM NG∆Ø·ªúI D√ôNG                     -->
<!-- ============================================= -->
<div class="modal fade" id="newMsgModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content group-modal-content">
            <div class="modal-header group-modal-header">
                <h5 class="modal-title fw-bold" style="font-size: 1.1rem;">Tin nh·∫Øn m·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body group-modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control form-control-custom" id="userSearchInput" placeholder="T√¨m ki·∫øm ng∆∞·ªùi d√πng..." autocomplete="off">
                </div>
                <div id="searchResultList" style="max-height: 300px; overflow-y: auto;">
                    <p class="text-center text-muted mt-3 small">Nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm...</p>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center pt-0">
                <button class="btn btn-link text-decoration-none fw-bold" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                    üë• T·∫°o nh√≥m chat m·ªõi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================= -->
<!-- MODAL T·∫†O NH√ìM                                -->
<!-- ============================================= -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content group-modal-content">
            <form method="post" enctype="multipart/form-data" action="{% url 'chat:create_group' %}">
                {% csrf_token %}
                <div class="modal-header group-modal-header bg-light">
                    <h5 class="modal-title fw-bold" style="font-size: 1.1rem;">T·∫°o nh√≥m tr√≤ chuy·ªán</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body group-modal-body">
                    <div class="mb-3">
                        <label class="form-group-label">T√™n nh√≥m</label>
                        {{ group_creation_form.name }}
                    </div>
                    <div class="mb-3">
                        <label class="form-group-label">·∫¢nh ƒë·∫°i di·ªán</label>
                        {{ group_creation_form.avatar }}
                    </div>
                    <div class="mb-3">
                        <label class="form-group-label">Ch·ªçn th√†nh vi√™n</label>
                        <div class="small text-muted mb-1">(Ch·ªçn √≠t nh·∫•t 2 ng∆∞·ªùi)</div>
                        {{ group_creation_form.participants }}
                    </div>
                </div>

                <div class="modal-footer border-0 bg-light rounded-bottom">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-primary btn-sm px-4 fw-bold">T·∫°o nh√≥m</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal X√≥a Tin Nh·∫Øn -->
<div class="modal fade" id="deleteMessageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header border-bottom-0 pb-0 justify-content-center">
                <h5 class="modal-title fw-bold" style="font-size: 1.1rem;">X√≥a tin nh·∫Øn?</h5>
            </div>
            <div class="modal-body text-center text-muted p-2">
                B·∫°n mu·ªën x√≥a tin nh·∫Øn n√†y ·ªü ph√≠a ai?
            </div>
            <div class="modal-footer flex-column border-top-0 p-2 gap-2">
                <button type="button" class="btn btn-primary w-100 fw-bold" id="btnDeleteEveryone">Thu h·ªìi v·ªõi m·ªçi ng∆∞·ªùi</button>
                <button type="button" class="btn btn-light w-100 fw-bold text-primary border" id="btnDeleteMe">Ch·ªâ x√≥a ·ªü ph√≠a t√¥i</button>
                <button type="button" class="btn btn-link text-decoration-none text-secondary btn-sm" data-bs-dismiss="modal">H·ªßy</button>
            </div>
        </div>
    </div>
</div>

<style>
    .message-bubble-container {
        position: relative;
        display: flex; 
        align-items: center; 
        gap: 10px; 
    }

    .message-timestamp {
        font-size: 0.65rem;
        color: #aaa;
        opacity: 0;
        transition: opacity 0.2s ease;
        white-space: nowrap;
        margin-top: 5px;
        text-align: center;
        min-width: 40px; 
    }

    .message-bubble-container:hover .message-timestamp { opacity: 1; }

    .message-bubble {
        max-width: 100%; 
        word-wrap: break-word;
        position: relative; 
    }

    /* Popup Reaction */
    .reaction-popup {
        display: none;
        position: absolute;
        top: -45px;
        width: max-content; 
        min-width: 200px;   
        background-color: white;
        border-radius: 50px;
        padding: 5px 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 100;
        gap: 8px;
        align-items: center;
    }
    .message-bubble-container:hover .reaction-popup {
        display: flex;
        animation: fadeIn 0.2s ease-in-out;
    }
    .justify-content-end .reaction-popup { right: 0; left: auto; }
    .justify-content-start .reaction-popup { left: 0; right: auto; }

    .reaction-popup .btn {
        font-size: 1.4rem; padding: 0; border: none; background: none;
        transition: transform 0.2s;
    }
    .reaction-popup .btn:hover { transform: scale(1.5); }

    /* Th·ªëng k√™ reaction */
    .reaction-stats-display {
        position: absolute;
        bottom: -10px;
        right: 0; 
        background-color: #fff;
        border: 1px solid #eef0f2;
        border-radius: 12px;
        padding: 2px 6px;
        font-size: 0.7rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        display: flex; align-items: center; gap: 2px; z-index: 1;
    }
    
    .justify-content-end .reaction-stats-display { right: 0; left: auto; }
    .justify-content-start .reaction-stats-display { left: 0; right: auto; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<script>
function formatSmartTime(timestampStr) {
    if (!timestampStr) return "";
    try {
        const parts = timestampStr.split(', ');
        if (parts.length < 2) return timestampStr; 
        const timePart = parts[0]; 
        const datePart = parts[1]; 
        const today = new Date();
        const d = String(today.getDate()).padStart(2, '0');
        const m = String(today.getMonth() + 1).padStart(2, '0'); 
        const y = today.getFullYear();
        const todayStr = `${d}-${m}-${y}`;
        if (datePart === todayStr) return timePart;
        return timestampStr.replace(/-/g, '/');
    } catch (e) { return timestampStr; }
}

document.addEventListener('DOMContentLoaded', function() {
// 1. Sidebar Toggle
    const toggleBtn = document.getElementById('toggle-right-sidebar');
    const sidebar = document.getElementById('right-sidebar');
    toggleBtn.addEventListener('click', () => sidebar.classList.toggle('open'));

    // 2. Load List Chat
    const currentConvId = "{{ conversation.id }}";
    let allConversations = [];
    
    function renderList(list) {
        const listEl = document.getElementById('js-conv-list');
        listEl.innerHTML = '';
        if(list.length === 0) { listEl.innerHTML = '<p class="text-center text-muted mt-3 small">Kh√¥ng t√¨m th·∫•y.</p>'; return; }
        list.forEach(conv => {
            const isActive = (conv.conversation_id == currentConvId) ? 'active' : '';
            listEl.innerHTML += `
                <a href="${conv.detail_url}" class="conv-item ${isActive}">
                    <img src="${conv.avatar_url}" class="conv-avatar">
                    <div class="conv-info">
                        <div class="conv-name">${conv.name}</div>
                        <div class="conv-last">${conv.last_message || '...'}</div>
                    </div>
                </a>
            `;
        });
    }

    fetch("{% url 'chat:api_get_conversations' %}")
    .then(res => {
        if (!res.ok) {
            throw new Error('L·ªói m·∫°ng ho·∫∑c l·ªói Server (500)');
        }
        return res.json();
    })
    .then(data => {
        allConversations = data.conversations;
        renderList(allConversations);
    })
    .catch(error => {
        console.error('L·ªói t·∫£i danh s√°ch chat:', error);
        // T·∫Øt v√≤ng xoay v√† hi·ªán th√¥ng b√°o l·ªói
        const listEl = document.getElementById('js-conv-list');
        listEl.innerHTML = '<p class="text-center text-danger mt-3 small">L·ªói t·∫£i danh s√°ch.</p>';
    });

    // 3. Search Chat (Left Sidebar)
    const toggleSearchBtn = document.getElementById('toggle-search-btn');
    const searchBar = document.getElementById('chat-search-bar');
    const filterInput = document.getElementById('filter-conv-input');
    
    toggleSearchBtn.addEventListener('click', () => {
        if(searchBar.style.display === 'block') {
            searchBar.style.display = 'none';
            filterInput.value = '';
            renderList(allConversations);
        } else {
            searchBar.style.display = 'block';
            filterInput.focus();
        }
    });

    filterInput.addEventListener('keyup', function() {
        const query = this.value.toLowerCase().trim();
        const filtered = allConversations.filter(c => c.name.toLowerCase().includes(query));
        renderList(filtered);
    });

    // 4. Scroll Bottom
    const msgContainer = document.getElementById('message-container');
    msgContainer.scrollTop = msgContainer.scrollHeight;

    // 5. File Preview
    const fileInput = document.getElementById('chat-file-input');
    const filePreview = document.getElementById('file-preview-container');
    const fileName = document.getElementById('file-name-preview');
    const clearFileBtn = document.getElementById('clear-file-btn');

    fileInput.addEventListener('change', function() {
        if(this.files.length) {
            filePreview.classList.remove('d-none');
            fileName.innerText = this.files[0].name;
        }
    });
    
    clearFileBtn.addEventListener('click', function() {
        fileInput.value = '';
        filePreview.classList.add('d-none');
    });

    // 6. Search User (Modal New Message)
    document.getElementById('userSearchInput').addEventListener('keyup', function() {
        let query = this.value.trim();
        let resultList = document.getElementById('searchResultList');
        if(query.length < 1) { resultList.innerHTML = '<p class="text-center text-muted mt-3 small">Nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm...</p>'; return; }
        
        fetch(`{% url 'chat:api_search_users' %}?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            resultList.innerHTML = '';
            if(data.users.length > 0) {
                data.users.forEach(user => {
                    let avatarSrc = user.avatar_url ? user.avatar_url : '/media/default.jpg';
                            
                            resultList.innerHTML += `
                                <a href="${user.start_conversation_url}" class="search-result-item">
                                    <img src="${avatarSrc}" class="search-avatar" onerror="this.src='https://via.placeholder.com/40'">
                                    <div>
                                        <div class="fw-bold">${user.username}</div>
                                        <div class="text-muted small">${user.full_name}</div>
                                    </div>
                                </a>
                            `;
                    
            });
            }
        });
    });

    const messageContainer = document.getElementById('message-container');
    
    messageContainer.addEventListener('click', function(event) {
        const button = event.target.closest('.message-reaction-choice-btn');
        if (button) {
            const messageId = button.dataset.messageId;
            const reactionType = button.dataset.reactionType;
            reactToMessage(messageId, reactionType);
        }
    });

    messageContainer.scrollTop = messageContainer.scrollHeight;

    const messageForm = document.getElementById('message-form');
    const csrftoken = getCookie('csrftoken');

    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const textInput = document.querySelector('[name="text"]');
        const text = textInput.value;
        const url = this.action;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken,
            },
            body: `text=${encodeURIComponent(text)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                const displayTime = formatSmartTime(data.timestamp);

                const messageHtml = `
                <div class="msg-row sent" id="msg-row-${data.message_id}">
                    
                    <!-- Bong b√≥ng tin nh·∫Øn -->
                    <div class="msg-bubble" id="msg-bubble-${data.message_id}">
                        <!-- N·∫øu c√≥ file (·∫£nh/video) tr·∫£ v·ªÅ t·ª´ API th√¨ x·ª≠ l√Ω th√™m ·ªü ƒë√¢y, t·∫°m th·ªùi hi·ªÉn th·ªã text -->
                        <span class="msg-text-content">${data.text}</span>

                        <!-- Hi·ªÉn th·ªã Reaction (m·∫∑c ƒë·ªãnh ·∫©n) -->
                        <div id="reaction-display-${data.message_id}" class="msg-reaction-display d-none"></div>
                    </div>

                    <!-- H·ªôp tho·∫°i S·ª≠a tin nh·∫Øn (m·∫∑c ƒë·ªãnh ·∫©n) -->
                    <div class="edit-box" id="edit-box-${data.message_id}">
                        <textarea id="edit-input-${data.message_id}" rows="2">${data.text}</textarea>
                        <div class="d-flex justify-content-end mt-1 gap-1">
                            <button class="btn btn-sm btn-secondary py-0" onclick="cancelEdit('${data.message_id}')">H·ªßy</button>
                            <button class="btn btn-sm btn-primary py-0" onclick="submitEdit('${data.message_id}')">L∆∞u</button>
                        </div>
                    </div>

                    <!-- Nh√≥m n√∫t h√†nh ƒë·ªông (M·∫∑t c∆∞·ªùi, S·ª≠a, X√≥a) -->
                    <div class="msg-actions-group">
                        <div class="position-relative">
                            <button class="btn-action-tiny" onclick="toggleReactionPopup('${data.message_id}')">‚ò∫</button>
                            <!-- Popup Emoji -->
                            <div class="reaction-popup" id="reaction-popup-${data.message_id}">
                                <button class="reaction-btn" onclick="reactToMsg('${data.message_id}', 'LOVE')">‚ù§Ô∏è</button>
                                <button class="reaction-btn" onclick="reactToMsg('${data.message_id}', 'HAHA')">üòÇ</button>
                                <button class="reaction-btn" onclick="reactToMsg('${data.message_id}', 'WOW')">üòÆ</button>
                                <button class="reaction-btn" onclick="reactToMsg('${data.message_id}', 'SAD')">üò¢</button>
                                <button class="reaction-btn" onclick="reactToMsg('${data.message_id}', 'ANGRY')">üò°</button>
                                <button class="reaction-btn" onclick="reactToMsg('${data.message_id}', 'LIKE')">üëç</button>
                            </div>
                        </div>
                        
                        <button class="btn-action-tiny" onclick="showEdit('${data.message_id}')">‚úé</button>
                        <button class="btn-action-tiny text-danger" onclick="deleteMsg('${data.message_id}')">üóë</button>
                    </div>

                </div>`;
                
                messageContainer.insertAdjacentHTML('beforeend', messageHtml);
                textInput.value = '';
                messageContainer.scrollTop = messageContainer.scrollHeight; 
            }
        });
    });
});

function reactToMessage(messageId, reactionType) {
    fetch(`/chat/api/message/react/${messageId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ reaction_type: reactionType })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'ok') updateReactionStatsUI(messageId, data.reaction_stats, data.total_reactions);
        else alert('L·ªói: ' + data.message);
    });
}

function updateReactionStatsUI(messageId, stats, total) {
    const statsContainer = document.getElementById(`message-reaction-stats-${messageId}`);
    if (!statsContainer) return;
    
    if (total > 0) {
        let iconsHTML = '';
        if (stats.LIKE) iconsHTML += '<span>üëç</span>';
        if (stats.LOVE) iconsHTML += '<span>‚ù§Ô∏è</span>';
        if (stats.HAHA) iconsHTML += '<span>üòÇ</span>';
        if (stats.WOW) iconsHTML += '<span>üòÆ</span>';
        if (stats.SAD) iconsHTML += '<span>üò¢</span>';
        if (stats.ANGRY) iconsHTML += '<span>üò°</span>';
        statsContainer.innerHTML = `${iconsHTML} <span class="reaction-count">${total}</span>`;
        statsContainer.style.display = 'flex'; 
    } else {
        statsContainer.innerHTML = '';
        statsContainer.style.display = 'none'; 
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

let messageIdToDelete = null;
let deleteMsgModal; 
document.addEventListener('DOMContentLoaded', function() {
    deleteMsgModal = new bootstrap.Modal(document.getElementById('deleteMessageModal'));
});
const btnDeleteEveryone = document.getElementById('btnDeleteEveryone');
const btnDeleteMe = document.getElementById('btnDeleteMe');

function deleteMessage(messageId) {
    messageIdToDelete = messageId;
    const msgElement = document.getElementById(`message-${messageId}`);
    const isMyMessage = msgElement.classList.contains('justify-content-end');
    if (isMyMessage) btnDeleteEveryone.style.display = 'block';
    else btnDeleteEveryone.style.display = 'none';
    deleteMsgModal.show();
}

function executeDelete(type) {
    if (!messageIdToDelete) return;
    btnDeleteEveryone.disabled = true;
    btnDeleteMe.disabled = true;

    fetch(`/chat/api/message/delete/${messageIdToDelete}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ delete_type: type })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'ok') {
            const msgDiv = document.getElementById(`message-${data.message_id}`);
            if (msgDiv) msgDiv.remove();
            deleteMsgModal.hide();
        } else alert('L·ªói: ' + data.message);
    })
    .catch(err => console.error(err))
    .finally(() => {
        btnDeleteEveryone.disabled = false;
        btnDeleteMe.disabled = false;
        messageIdToDelete = null;
    });
}

if (btnDeleteEveryone) btnDeleteEveryone.addEventListener('click', () => executeDelete('everyone'));
if (btnDeleteMe) btnDeleteMe.addEventListener('click', () => executeDelete('me'));

function showEditForm(messageId) { document.getElementById(`edit-form-${messageId}`).style.display = 'block'; }
function hideEditForm(messageId) { document.getElementById(`edit-form-${messageId}`).style.display = 'none'; }
function submitEdit(messageId) {
    const newText = document.getElementById(`edit-text-${messageId}`).value;
    fetch(`/chat/api/message/edit/${messageId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({text: newText})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'ok') {
            const messageDiv = document.getElementById(`message-${data.message_id}`);
            messageDiv.querySelector('.message-text').innerText = data.new_text;
            hideEditForm(messageId);
        } else alert('L·ªói: ' + data.message);
    });
}
/* --- FUNCTIONS CHO REACTION, EDIT, DELETE --- */
function getCookie(name) {
    let v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
    return v ? v[2] : null;
}
const reactionIcons = {'LIKE': 'üëç', 'LOVE': '‚ù§Ô∏è', 'HAHA': 'üòÇ', 'WOW': 'üòÆ', 'SAD': 'üò¢', 'ANGRY': 'üò°'};

function toggleReactionPopup(msgId) {
    const popup = document.getElementById(`reaction-popup-${msgId}`);
    document.querySelectorAll('.reaction-popup').forEach(p => { if(p!==popup) p.classList.remove('show'); });
    popup.classList.toggle('show');
}

function reactToMsg(msgId, type) {
    fetch(`/chat/api/message/react/${msgId}/`, {
        method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json'},
        body: JSON.stringify({reaction_type: type})
    }).then(res=>res.json()).then(data=>{
        if(data.status==='ok') {
            const display = document.getElementById(`reaction-display-${msgId}`);
            if(data.total_reactions > 0) {
                display.classList.remove('d-none');
                let html = '';
                for (const [rType, count] of Object.entries(data.reaction_stats)) {
                    if(count > 0 && reactionIcons[rType]) html += `${reactionIcons[rType]} `;
                }
                if(data.total_reactions > 1) html += `<span class="ms-1">${data.total_reactions}</span>`;
                else if (html === '') html = '‚ù§Ô∏è';
                display.innerHTML = html;
            } else {
                display.classList.add('d-none');
            }
            toggleReactionPopup(msgId);
        }
    });
}

function deleteMsg(msgId) {
    if(!confirm('X√≥a tin nh·∫Øn n√†y?')) return;
    fetch(`/chat/api/message/delete/${msgId}/`, {
        method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}
    }).then(res=>res.json()).then(data=>{ if(data.status==='ok') document.getElementById(`msg-row-${msgId}`).remove(); });
}

function showEdit(msgId) {
    document.getElementById(`msg-bubble-${msgId}`).style.display = 'none';
    document.getElementById(`edit-box-${msgId}`).style.display = 'block';
}
function cancelEdit(msgId) {
    document.getElementById(`msg-bubble-${msgId}`).style.display = 'block';
    document.getElementById(`edit-box-${msgId}`).style.display = 'none';
}
function submitEdit(msgId) {
    const text = document.getElementById(`edit-input-${msgId}`).value;
    fetch(`/chat/api/message/edit/${msgId}/`, {
        method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json'},
        body: JSON.stringify({text: text})
    }).then(res=>res.json()).then(data=>{
        if(data.status==='ok') {
            document.querySelector(`#msg-bubble-${msgId} .msg-text-content`).innerText = data.new_text;
            cancelEdit(msgId);
        }
    });
}

function scrollToBottom() {
        const msgContainer = document.getElementById('message-container');
        msgContainer.scrollTop = msgContainer.scrollHeight;
    }

    // H√†m l·∫•y ID c·ªßa tin nh·∫Øn cu·ªëi c√πng ƒëang hi·ªÉn th·ªã tr√™n m√†n h√¨nh
    function getLastMessageId() {
        const messages = document.querySelectorAll('.msg-row');
        if (messages.length > 0) {
            const lastMsg = messages[messages.length - 1];
            // ID c·ªßa div l√† "msg-row-123", ta c·∫ßn l·∫•y s·ªë 123
            return lastMsg.id.replace('msg-row-', '');
        }
        return 0;
    }

    // H√†m g·ªçi API l·∫•y tin nh·∫Øn m·ªõi
    function fetchNewMessages() {
        const lastId = getLastMessageId();
        const convId = "{{ conversation.id }}";
        
        fetch(`/chat/api/get-new-messages/${convId}/?last_message_id=${lastId}`)
        .then(response => response.json())
        .then(data => {
            if (data.messages.length > 0) {
                const container = document.getElementById('message-container');
                
                data.messages.forEach(msg => {
                    // Ki·ªÉm tra xem tin nh·∫Øn n√†y ƒë√£ t·ªìn t·∫°i ch∆∞a ƒë·ªÉ tr√°nh tr√πng l·∫∑p
                    if (!document.getElementById(`msg-row-${msg.message_id}`)) {
                        
                        // X√°c ƒë·ªãnh class CSS (G·ª≠i hay Nh·∫≠n)
                        const rowClass = msg.is_me ? 'sent' : 'received';
                        
                        // HTML hi·ªÉn th·ªã tin nh·∫Øn (gi·ªëng c·∫•u tr√∫c b·∫°n ƒë√£ s·ª≠a ·ªü b∆∞·ªõc tr∆∞·ªõc)
                        // Ch√∫ √Ω: Ph·∫ßn avatar ch·ªâ hi·ªán n·∫øu l√† 'received' v√† l√† nh√≥m (t√πy logic c·ªßa b·∫°n)
                        let avatarHtml = '';
                        if (!msg.is_me && "{{ conversation.type }}" === "GROUP") {
                             avatarHtml = `<img src="${msg.sender_avatar}" class="msg-avatar-tiny" title="${msg.sender_username}">`;
                        }

                        const msgHtml = `
                        <div class="msg-row ${rowClass}" id="msg-row-${msg.message_id}">
                            ${avatarHtml}
                            <div class="msg-bubble" id="msg-bubble-${msg.message_id}">
                                <span class="msg-text-content">${msg.text ? msg.text : ''}</span>
                                ${msg.file_url ? `<br><a href="${msg.file_url}" target="_blank" class="small text-decoration-underline">üìé File ƒë√≠nh k√®m</a>` : ''}
                                <div id="reaction-display-${msg.message_id}" class="msg-reaction-display d-none"></div>
                            </div>
                            
                            <!-- Action Group -->
                            <div class="msg-actions-group">
                                <div class="position-relative">
                                    <button class="btn-action-tiny" onclick="toggleReactionPopup('${msg.message_id}')">‚ò∫</button>
                                    <div class="reaction-popup" id="reaction-popup-${msg.message_id}">
                                        <button class="reaction-btn" onclick="reactToMsg('${msg.message_id}', 'LOVE')">‚ù§Ô∏è</button>
                                        <button class="reaction-btn" onclick="reactToMsg('${msg.message_id}', 'HAHA')">üòÇ</button>
                                        <button class="reaction-btn" onclick="reactToMsg('${msg.message_id}', 'WOW')">üòÆ</button>
                                        <button class="reaction-btn" onclick="reactToMsg('${msg.message_id}', 'SAD')">üò¢</button>
                                        <button class="reaction-btn" onclick="reactToMsg('${msg.message_id}', 'ANGRY')">üò°</button>
                                        <button class="reaction-btn" onclick="reactToMsg('${msg.message_id}', 'LIKE')">üëç</button>
                                    </div>
                                </div>
                                ${msg.is_me ? `
                                <button class="btn-action-tiny" onclick="showEdit('${msg.message_id}')">‚úé</button>
                                <button class="btn-action-tiny text-danger" onclick="deleteMsg('${msg.message_id}')">üóë</button>
                                ` : ''}
                            </div>
                        </div>`;
                        
                        container.insertAdjacentHTML('beforeend', msgHtml);
                    }
                });
                
                // Sau khi th√™m tin m·ªõi, cu·ªôn xu·ªëng d∆∞·ªõi c√πng
                scrollToBottom();
            }
        })
        .catch(err => console.error("L·ªói c·∫≠p nh·∫≠t tin nh·∫Øn:", err));
    }

    // Ch·∫°y h√†m ki·ªÉm tra m·ªói 2 gi√¢y (2000ms)
    setInterval(fetchNewMessages, 2000);
    
// ƒê√≥ng popup khi click ra ngo√†i
document.addEventListener('click', function(e) {
    if (!e.target.closest('.msg-actions-group')) document.querySelectorAll('.reaction-popup').forEach(p => p.classList.remove('show'));
});
</script>
{% endblock content %}

{% block extra_js %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Kh·ªüi t·∫°o TomSelect cho Modal T·∫°o Nh√≥m
        const participantsSelect = document.getElementById('id_participants');
        let tsInstance = null;
        
        if (participantsSelect) {
             tsInstance = new TomSelect('#id_participants', {
                plugins: ['remove_button'],
                create: false,
                placeholder: 'T√¨m v√† ch·ªçn th√†nh vi√™n...',
                maxItems: null,
                dropdownParent: 'body' 
            });
        }
        
        // Logic ƒë·ªÉ ch·ªçn tr∆∞·ªõc user khi b·∫•m t·ª´ sidebar
        const modalEl = document.getElementById('createGroupModal');
        modalEl.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute('data-preselect-user');
            
            if (userId && tsInstance) {
                // Th√™m user v√†o selection
                tsInstance.addItem(userId);
            }
        });
    });
</script>
{% endblock extra_js %}