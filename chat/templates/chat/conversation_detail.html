{% extends "posts/base.html" %}
{% load post_extras %}

{% block content %}
<style>
    /* =================================================================
       PH·∫¶N 1: THU NH·ªé SIDEBAR CH√çNH C·ª¶A WEBSITE
       ================================================================= */
    /* √âp sidebar ch√≠nh thu nh·ªè l·∫°i ch·ªâ c√≤n icon */
    .sidebar {
        width: 72px !important; 
        padding: 12px 12px !important;
        border-right: 1px solid #dbdbdb;
    }
    .sidebar-nav li a span { display: none !important; } /* ·∫®n ch·ªØ */
    .sidebar-nav li a {
        justify-content: center !important;
        padding: 12px 0 !important;
    }
    .sidebar-nav .nav-icon {
        margin-right: 0 !important;
        width: 28px; height: 28px;
    }
    .sidebar-brand { display: none !important; } /* ·∫®n logo ch·ªØ */
    
    /* K√©o n·ªôi dung ch√≠nh sang tr√°i l·∫•p ch·ªó tr·ªëng */
    .main-content {
        margin-left: 72px !important;
        padding: 0 !important;
        width: calc(100% - 72px) !important;
    }

    /* =================================================================
       PH·∫¶N 2: GIAO DI·ªÜN CHAT (LAYOUT CHIA ƒê√îI)
       ================================================================= */
    body { background-color: #fff; }

    .chat-layout {
        display: flex;
        height: 100vh; /* Full chi·ªÅu cao m√†n h√¨nh */
        background: #fff;
    }

    /* --- C·ªòT TR√ÅI: DANH S√ÅCH & T√åM KI·∫æM --- */
    .chat-list-sidebar {
        width: 350px;
        border-right: 1px solid #dbdbdb;
        display: flex;
        flex-direction: column;
        background: #fff;
    }

    .chat-list-header {
        height: 75px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        border-bottom: 1px solid #dbdbdb;
    }
    .chat-list-header h5 { margin: 0; font-weight: bold; font-size: 1.2rem; }
    
    .header-actions { display: flex; gap: 15px; align-items: center; }
    .btn-header-icon {
        background: none; border: none; padding: 0; cursor: pointer; color: #000;
        display: flex; align-items: center;
    }

    /* THANH T√åM KI·∫æM (·∫®n m·∫∑c ƒë·ªãnh) */
    .search-bar-container {
        display: none; padding: 10px 15px; background: #fff; border-bottom: 1px solid #f0f0f0;
    }
    .search-bar-container input {
        width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; background: #efefef; outline: none;
    }

    .conv-list-container { flex: 1; overflow-y: auto; }

    .conv-item {
        display: flex; align-items: center; padding: 10px 20px;
        text-decoration: none; color: #000; transition: 0.2s;
    }
    .conv-item:hover { background-color: #fafafa; }
    .conv-item.active { background-color: #efefef; }
    
    .conv-avatar { width: 56px; height: 56px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
    .conv-info { flex: 1; overflow: hidden; }
    .conv-name { font-size: 0.95rem; font-weight: 500; }
    .conv-last { font-size: 0.85rem; color: #8e8e8e; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

    /* --- C·ªòT PH·∫¢I: KHUNG CHAT CH√çNH --- */
    .chat-main-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
        position: relative;
    }

    /* Header Chat */
    .chat-header {
        height: 75px;
        border-bottom: 1px solid #dbdbdb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
    }
    .header-user { display: flex; align-items: center; text-decoration: none; color: #000; }
    .header-avatar { width: 44px; height: 44px; border-radius: 50%; margin-right: 12px; object-fit: cover; }
    .btn-icon-only { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px; }

    /* N·ªôi dung tin nh·∫Øn */
    .chat-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .msg-row {
        display: flex; margin-bottom: 5px; 
        align-items: center; position: relative;
    }
    .msg-row:hover .msg-actions-group { opacity: 1; visibility: visible; }

    .msg-row.sent { flex-direction: row-reverse; }
    .msg-row.received { flex-direction: row; }

    .msg-avatar-tiny { width: 30px; height: 30px; border-radius: 50%; margin: 0 8px; align-self: flex-end; }

    .msg-bubble {
        max-width: 60%;
        padding: 10px 14px;
        border-radius: 18px;
        font-size: 0.95rem;
        line-height: 1.4;
        word-wrap: break-word;
        position: relative;
    }

    .msg-row.sent .msg-bubble { background-color: #0084ff; color: white; border-bottom-right-radius: 4px; }
    .msg-row.received .msg-bubble { background-color: #f0f0f0; color: #000; border-bottom-left-radius: 4px; }

    /* N√∫t ch·ª©c nƒÉng (Reaction, Edit, Delete) */
    .msg-actions-group {
        opacity: 0; visibility: hidden; transition: 0.2s;
        display: flex; align-items: center; gap: 5px;
        margin: 0 10px;
    }
    .btn-action-tiny {
        background: #f5f5f5; border: none; border-radius: 50%;
        width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
        cursor: pointer; color: #65676b; font-size: 0.9rem;
    }
    .btn-action-tiny:hover { background-color: #e4e6eb; }

    /* Popup Reaction */
    .reaction-popup {
        display: none; position: absolute; bottom: 100%; 
        background: white; border-radius: 20px; padding: 5px; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 100;
        white-space: nowrap;
    }
    .msg-row.sent .reaction-popup { right: 0; }
    .msg-row.received .reaction-popup { left: 0; }
    .reaction-popup.show { display: flex; gap: 5px; animation: popIn 0.2s ease; }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .reaction-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
    .reaction-btn:hover { transform: scale(1.3); }

    /* Hi·ªÉn th·ªã Reaction ƒë√£ th·∫£ */
    .msg-reaction-display {
        position: absolute; bottom: -12px; 
        background: #fff; border-radius: 10px; padding: 2px 6px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.15); font-size: 0.8rem;
        border: 2px solid #fff; display: flex; gap: 2px;
    }
    .msg-row.sent .msg-reaction-display { right: 0; }
    .msg-row.received .msg-reaction-display { left: 0; }

    /* H·ªôp s·ª≠a tin nh·∫Øn */
    .edit-box { display: none; width: 100%; max-width: 60%; }
    .edit-box textarea { width: 100%; border-radius: 10px; padding: 5px; border: 1px solid #ccc; font-size: 0.9rem; }
    
    /* Footer nh·∫≠p li·ªáu */
    .chat-footer { padding: 10px 20px; display: flex; align-items: center; border-top: 1px solid #dbdbdb; }
    .chat-input-wrapper { flex: 1; background: #f0f0f0; border-radius: 20px; padding: 8px 15px; display: flex; align-items: center; }
    .chat-input { background: transparent; border: none; outline: none; flex: 1; }
    .btn-send { color: #0084ff; font-weight: bold; background: none; border: none; margin-left: 10px; }

    /* Search User Modal Item */
    .search-result-item {
        display: flex; align-items: center; padding: 10px;
        border-bottom: 1px solid #eee; text-decoration: none; color: #000;
    }
    .search-result-item:hover { background-color: #f0f2f5; }
    .search-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
</style>

<div class="chat-layout">
    <!-- C·ªòT DANH S√ÅCH B·∫†N B√à -->
    <div class="chat-list-sidebar">
        <!-- Header -->
        <div class="chat-list-header">
            <h5>{{ user.username }}</h5>
            <div class="header-actions">
                <!-- N√∫t T√¨m ki·∫øm h·ªôi tho·∫°i (K√≠nh l√∫p) -->
                <button class="btn-header-icon" id="toggle-search-btn" title="T√¨m ki·∫øm ƒëo·∫°n chat">
                    <svg aria-label="Search" fill="currentColor" height="24" role="img" viewBox="0 0 24 24" width="24"><path d="M19 10.5A8.5 8.5 0 1 1 10.5 2a8.5 8.5 0 0 1 8.5 8.5Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path><line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="16.511" x2="22" y1="16.511" y2="22"></line></svg>
                </button>
                <!-- N√∫t So·∫°n tin m·ªõi (C√¢y b√∫t trong h√¨nh vu√¥ng) -->
                <button class="btn-header-icon" data-bs-toggle="modal" data-bs-target="#newMsgModal" title="So·∫°n tin m·ªõi">
                    <svg aria-label="New message" fill="currentColor" height="24" role="img" viewBox="0 0 24 24" width="24"><path d="M12.202 3.203H5.25a3 3 0 0 0-3 3V18.75a3 3 0 0 0 3 3h12.5a3 3 0 0 0 3-3v-6.94l-8.546-8.607zm6.81 1.252l-6.814 6.814V4.46l6.814-6.814zm-5.602 11.235l-2.768-2.768 8.845-8.845 2.768 2.768-8.845 8.845z"></path><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"></path></svg>
                </button>
            </div>
        </div>
        
        <!-- Thanh input t√¨m ki·∫øm (·∫©n hi·ªán) -->
        <div class="search-bar-container" id="chat-search-bar">
            <input type="text" id="filter-conv-input" placeholder="T√¨m ng∆∞·ªùi ho·∫∑c nh√≥m...">
        </div>

        <!-- Danh s√°ch h·ªôi tho·∫°i -->
        <div class="conv-list-container" id="js-conv-list">
            <div class="text-center mt-3"><div class="spinner-border spinner-border-sm text-muted"></div></div>
        </div>
    </div>

    <!-- KHUNG CHAT CH√çNH -->
    <div class="chat-main-area">
        <!-- Header Chat -->
        <div class="chat-header">
            <div class="d-flex align-items-center">
                {% if conversation.type == 'GROUP' %}
                    <img src="{{ conversation.avatar.url }}" class="header-avatar">
                    <span class="fw-bold">{{ conversation.name }}</span>
                {% else %}
                    <a href="{% url 'accounts:profile' username=other_participant.username %}" class="header-user">
                        <img src="{{ other_participant.avatar.url }}" class="header-avatar">
                        <span class="fw-bold">{{ other_participant.first_name }} {{ other_participant.last_name }}</span>
                    </a>
                {% endif %}
            </div>

            <!-- N√∫t (i) qu·∫£n l√Ω -->
            <div class="dropdown">
                <button class="btn-icon-only" type="button" data-bs-toggle="dropdown">
                    <svg aria-label="View Info" fill="currentColor" height="24" viewBox="0 0 24 24" width="24"><circle cx="12" cy="12" fill="none" r="10.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></circle><line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="12" x2="12" y1="10.068" y2="17.568"></line><circle cx="12" cy="7.068" r=".5"></circle></svg>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow border-0 p-2" style="border-radius: 12px; width: 280px;">
                    {% if conversation.type == 'GROUP' %}
                        <li><h6 class="dropdown-header">Th√†nh vi√™n & Nh√≥m</h6></li>
                        <li><button class="dropdown-item rounded" data-bs-toggle="modal" data-bs-target="#membersModal">üë• Xem th√†nh vi√™n</button></li>
                        <li><a class="dropdown-item rounded" href="{% url 'chat:manage_group' conversation.id %}">‚öôÔ∏è Qu·∫£n l√Ω nh√≥m</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form method="post" action="{% url 'chat:leave_group' conversation.id %}">
                                {% csrf_token %}
                                <button class="dropdown-item rounded text-danger fw-bold">R·ªùi nh√≥m</button>
                            </form>
                        </li>
                    {% else %}
                         <li><h6 class="dropdown-header">T√πy ch·ªçn</h6></li>
                         <li><a class="dropdown-item rounded" href="{% url 'accounts:profile' username=other_participant.username %}">üë§ Xem trang c√° nh√¢n</a></li>
                         <li><a class="dropdown-item rounded" href="{% url 'chat:create_group' %}?with_user={{ other_participant.id }}">üë• T·∫°o nh√≥m v·ªõi ng∆∞·ªùi n√†y</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <!-- Body Chat -->
        <div class="chat-body" id="message-container">
            {% for message in messages %}
                {% if not message.sender %}
                    <div class="text-center my-2 text-muted small">{{ message.text }}</div>
                {% else %}
                    <div class="msg-row {% if message.sender == user %}sent{% else %}received{% endif %}" id="msg-row-{{ message.id }}">
                        
                        {% if message.sender != user and conversation.type == 'GROUP' %}
                            <img src="{{ message.sender.avatar.url }}" class="msg-avatar-tiny" title="{{ message.sender.first_name }}">
                        {% endif %}

                        <div class="msg-bubble" id="msg-bubble-{{ message.id }}">
                            {% if message.file %}
                                <div class="mb-2">
                                    {% if message.is_image %}
                                        <img src="{{ message.file.url }}" class="img-fluid rounded">
                                    {% elif message.is_video %}
                                        <video src="{{ message.file.url }}" controls class="img-fluid rounded"></video>
                                    {% else %}
                                        <a href="{{ message.file.url }}" target="_blank" class="text-white text-decoration-underline">üìé {{ message.file.name }}</a>
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                            <span class="msg-text-content">{{ message.text|linebreaksbr }}</span>

                            <!-- Hi·ªÉn th·ªã Reaction -->
                            <div id="reaction-display-{{ message.id }}" class="msg-reaction-display {% if message.reactions.count == 0 %}d-none{% endif %}">
                                {% with stats=message.reactions.all %}
                                    {% if stats %}‚ù§Ô∏è {{ stats.count }}{% endif %}
                                {% endwith %}
                            </div>
                        </div>

                        <!-- Form Edit -->
                        {% if message.sender == user %}
                        <div class="edit-box" id="edit-box-{{ message.id }}">
                            <textarea id="edit-input-{{ message.id }}" rows="2">{{ message.text }}</textarea>
                            <div class="d-flex justify-content-end mt-1 gap-1">
                                <button class="btn btn-sm btn-secondary" onclick="cancelEdit('{{ message.id }}')">H·ªßy</button>
                                <button class="btn btn-sm btn-primary" onclick="submitEdit('{{ message.id }}')">L∆∞u</button>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Actions -->
                        <div class="msg-actions-group">
                            <div class="position-relative">
                                <button class="btn-action-tiny" onclick="toggleReactionPopup('{{ message.id }}')">‚ò∫</button>
                                <div class="reaction-popup" id="reaction-popup-{{ message.id }}">
                                    <button class="reaction-btn" onclick="reactToMsg('{{ message.id }}', 'LOVE')">‚ù§Ô∏è</button>
                                    <button class="reaction-btn" onclick="reactToMsg('{{ message.id }}', 'HAHA')">üòÇ</button>
                                    <button class="reaction-btn" onclick="reactToMsg('{{ message.id }}', 'WOW')">üòÆ</button>
                                    <button class="reaction-btn" onclick="reactToMsg('{{ message.id }}', 'SAD')">üò¢</button>
                                    <button class="reaction-btn" onclick="reactToMsg('{{ message.id }}', 'ANGRY')">üò°</button>
                                    <button class="reaction-btn" onclick="reactToMsg('{{ message.id }}', 'LIKE')">üëç</button>
                                </div>
                            </div>
                            {% if message.sender == user %}
                                <button class="btn-action-tiny" onclick="showEdit('{{ message.id }}')">‚úé</button>
                                <button class="btn-action-tiny text-danger" onclick="deleteMsg('{{ message.id }}')">üóëÔ∏è</button>
                            {% endif %}
                        </div>

                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- Footer -->
        <div class="chat-footer">
            <form id="message-form" method="post" enctype="multipart/form-data" action="{% url 'chat:send_message_api' conversation.id %}" class="w-100 d-flex align-items-center">
                {% csrf_token %}
                <div class="chat-input-wrapper">
                    <label for="chat-file-input" style="cursor: pointer; margin-right: 10px;">
                        <svg aria-label="Add Photo" fill="currentColor" height="24" viewBox="0 0 24 24" width="24"><path d="M16.555 5.336l-1.636-2.583A2.002 2.002 0 0013.23 1.5H10.77a2.002 2.002 0 00-1.69.753L7.445 5.336A2.005 2.005 0 015.77 6.5H2.5A2.5 2.5 0 000 9v11a2.5 2.5 0 002.5 2.5h19a2.5 2.5 0 002.5-2.5V9a2.5 2.5 0 00-2.5-2.5h-3.27a2.005 2.005 0 01-1.675-1.164zM22 19.998L2.002 20v-11h3.768l1.636-2.583a.002.002 0 01.002-.002h9.184l1.637 2.585H22v11z"></path><circle cx="12" cy="13" r="4.5"></circle></svg>
                    </label>
                    <input type="file" name="file" id="chat-file-input" class="d-none" accept="image/*,video/*">
                    <input type="text" name="text" class="chat-input" placeholder="Nh·∫Øn tin..." autocomplete="off">
                </div>
                <button type="submit" class="btn-send">G·ª≠i</button>
            </form>
        </div>
        
        <div id="file-preview-container" class="px-4 py-2 bg-light d-none small">
            ƒêang ch·ªçn: <span id="file-name-preview" class="fw-bold"></span> 
            <button type="button" class="btn-close btn-sm ms-2" id="clear-file-btn"></button>
        </div>
    </div>
</div>

<!-- Modal Search User (New Message) -->
<div class="modal fade" id="newMsgModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Tin nh·∫Øn m·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control border-0 border-bottom mb-2" id="userSearchInput" placeholder="T√¨m ki·∫øm ng∆∞·ªùi d√πng...">
                <div id="searchResultList" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                 <a href="{% url 'chat:create_group' %}" class="text-primary fw-bold text-decoration-none">T·∫°o nh√≥m chat m·ªõi</a>
            </div>
        </div>
    </div>
</div>

<!-- MODAL MEMBERS (GROUP) - ƒê√É C√ì BADGE V√Ä N√öT X√ìA -->
{% if conversation.type == 'GROUP' %}
<div class="modal fade" id="membersModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header border-bottom-0">
        <h5 class="modal-title fw-bold">Th√†nh vi√™n ({{ participants.count }})</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-0">
        <ul class="list-group list-group-flush">
          {% for member in participants %}
            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                <!-- Th√¥ng tin th√†nh vi√™n -->
                <div class="d-flex align-items-center">
                    <img src="{{ member.avatar.url }}" class="rounded-circle me-3" width="44" height="44" style="object-fit: cover;">
                    <div>
                        <div class="fw-bold text-dark">
                            {{ member.first_name }} {{ member.last_name }}
                            <!-- BADGE QTV -->
                            {% if conversation.admin == member %}
                                <span class="badge bg-primary ms-1" style="font-size: 0.7rem;">QTV</span>
                            {% endif %}
                        </div>
                        <div class="small text-muted">@{{ member.username }}</div>
                    </div>
                </div>

                <!-- N√∫t H√†nh ƒë·ªông -->
                <div class="d-flex align-items-center gap-2">
                    {% if member != request.user %}
                        <a href="{% url 'chat:start_conversation' user_id=member.id %}" class="btn btn-light btn-sm rounded-circle" title="Nh·∫Øn tin">üí¨</a>
                    {% endif %}

                    <!-- N√öT X√ìA TH√ÄNH VI√äN (CH·ªà HI·ªÜN KHI B·∫†N L√Ä ADMIN) -->
                    {% if conversation.admin == request.user and member != request.user %}
                        <a href="{% url 'chat:remove_member' conversation.id member.id %}" 
                           class="btn btn-light btn-sm rounded-circle text-danger" 
                           title="X√≥a kh·ªèi nh√≥m"
                           onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën m·ªùi {{ member.username }} ra kh·ªèi nh√≥m?');">
                            üóëÔ∏è
                        </a>
                    {% endif %}
                </div>
            </li>
          {% endfor %}
        </ul>
      </div>
       <!-- Footer Modal -->
      <div class="modal-footer border-top-0 justify-content-center">
         <form method="post" action="{% url 'chat:leave_group' conversation.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger w-100 fw-bold" onclick="return confirm('R·ªùi nh√≥m?');">R·ªùi kh·ªèi nh√≥m n√†y</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageContainer = document.getElementById('message-container');
    messageContainer.scrollTop = messageContainer.scrollHeight;

    // 1. LOAD DANH S√ÅCH CHAT
    const currentConvId = "{{ conversation.id }}";
    let allConversations = []; 

    fetch("{% url 'chat:api_get_conversations' %}")
    .then(res => res.json())
    .then(data => {
        allConversations = data.conversations;
        renderConvList(allConversations);
    });

    function renderConvList(list) {
        const listEl = document.getElementById('js-conv-list');
        listEl.innerHTML = '';
        if(list.length === 0) {
            listEl.innerHTML = '<p class="text-center text-muted mt-3 small">Kh√¥ng t√¨m th·∫•y.</p>';
            return;
        }
        list.forEach(conv => {
            const isActive = (conv.conversation_id == currentConvId) ? 'active' : '';
            const html = `
                <a href="${conv.detail_url}" class="conv-item ${isActive}">
                    <img src="${conv.avatar_url}" class="conv-avatar">
                    <div class="conv-info">
                        <div class="conv-name">${conv.name}</div>
                        <div class="conv-last">${conv.last_message || 'B·∫Øt ƒë·∫ßu'}</div>
                    </div>
                </a>
            `;
            listEl.insertAdjacentHTML('beforeend', html);
        });
    }

    // 2. TOGGLE SEARCH BAR & FILTER
    const toggleSearchBtn = document.getElementById('toggle-search-btn');
    const searchBar = document.getElementById('chat-search-bar');
    const filterInput = document.getElementById('filter-conv-input');

    if(toggleSearchBtn) {
        toggleSearchBtn.addEventListener('click', function() {
            if (searchBar.style.display === 'block') {
                searchBar.style.display = 'none';
                filterInput.value = '';
                renderConvList(allConversations);
            } else {
                searchBar.style.display = 'block';
                filterInput.focus();
            }
        });
    }

    if(filterInput) {
        filterInput.addEventListener('keyup', function() {
            const query = this.value.toLowerCase().trim();
            const filtered = allConversations.filter(conv => conv.name.toLowerCase().includes(query));
            renderConvList(filtered);
        });
    }

    // 3. SEARCH USER (MODAL)
    document.getElementById('userSearchInput').addEventListener('keyup', function() {
        let query = this.value.trim();
        let resultList = document.getElementById('searchResultList');
        if(query.length < 1) { resultList.innerHTML = ''; return; }
        
        fetch(`{% url 'chat:api_search_users' %}?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            resultList.innerHTML = '';
            data.users.forEach(user => {
                resultList.innerHTML += `
                    <a href="${user.start_conversation_url}" class="d-flex align-items-center p-2 text-decoration-none text-dark hover-bg-light">
                        <img src="/static/images/default.jpg" class="rounded-circle me-2" width="40" height="40" onerror="this.src='https://via.placeholder.com/40'">
                        <span class="fw-bold">${user.username}</span>
                    </a>`;
            });
        });
    });

    // 4. SEND MESSAGE
    const msgForm = document.getElementById('message-form');
    const fileInput = document.getElementById('chat-file-input');
    
    fileInput.addEventListener('change', function() {
        if(this.files.length) {
            document.getElementById('file-name-preview').textContent = this.files[0].name;
            document.getElementById('file-preview-container').classList.remove('d-none');
        }
    });
    document.getElementById('clear-file-btn').addEventListener('click', function() {
        fileInput.value = ''; document.getElementById('file-preview-container').classList.add('d-none');
    });

    msgForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        if(!formData.get('text') && !formData.get('file').name) return;
        fetch(this.action, {
            method: 'POST', body: formData, headers: {'X-CSRFToken': '{{ csrf_token }}'}
        }).then(res => res.json()).then(data => { if(data.status==='ok') location.reload(); });
    });
});

/* --- HELPER FUNCTIONS --- */
function getCookie(name) {
    let v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
    return v ? v[2] : null;
}

const reactionIcons = {
    'LIKE': 'üëç', 'LOVE': '‚ù§Ô∏è', 'HAHA': 'üòÇ',
    'WOW': 'üòÆ', 'SAD': 'üò¢', 'ANGRY': 'üò°'
};

function reactToMsg(msgId, type) {
    fetch(`/chat/api/message/react/${msgId}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json'},
        body: JSON.stringify({reaction_type: type})
    }).then(res=>res.json()).then(data=>{
        if(data.status==='ok') {
            const display = document.getElementById(`reaction-display-${msgId}`);
            if(data.total_reactions > 0) {
                display.classList.remove('d-none');
                let html = '';
                for (const [rType, count] of Object.entries(data.reaction_stats)) {
                    if(count > 0 && reactionIcons[rType]) html += `${reactionIcons[rType]} `;
                }
                if(data.total_reactions > 1) html += `<span class="ms-1">${data.total_reactions}</span>`;
                else if (html === '') html = '‚ù§Ô∏è';
                display.innerHTML = html;
            } else {
                display.classList.add('d-none');
            }
            toggleReactionPopup(msgId);
        }
    });
}

function deleteMsg(msgId) {
    if(!confirm('X√≥a tin nh·∫Øn n√†y?')) return;
    fetch(`/chat/api/message/delete/${msgId}/`, {
        method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}
    }).then(res=>res.json()).then(data=>{ if(data.status==='ok') document.getElementById(`msg-row-${msgId}`).remove(); });
}

function showEdit(msgId) {
    document.getElementById(`msg-bubble-${msgId}`).style.display = 'none';
    document.getElementById(`edit-box-${msgId}`).style.display = 'block';
}
function cancelEdit(msgId) {
    document.getElementById(`msg-bubble-${msgId}`).style.display = 'block';
    document.getElementById(`edit-box-${msgId}`).style.display = 'none';
}
function submitEdit(msgId) {
    const text = document.getElementById(`edit-input-${msgId}`).value;
    fetch(`/chat/api/message/edit/${msgId}/`, {
        method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json'},
        body: JSON.stringify({text: text})
    }).then(res=>res.json()).then(data=>{
        if(data.status==='ok') {
            document.querySelector(`#msg-bubble-${msgId} .msg-text-content`).innerText = data.new_text;
            cancelEdit(msgId);
        }
    });
}
function toggleReactionPopup(msgId) {
    const popup = document.getElementById(`reaction-popup-${msgId}`);
    document.querySelectorAll('.reaction-popup').forEach(p => { if(p!==popup) p.classList.remove('show'); });
    popup.classList.toggle('show');
}
document.addEventListener('click', function(e) {
    if (!e.target.closest('.msg-actions-group')) document.querySelectorAll('.reaction-popup').forEach(p => p.classList.remove('show'));
});
</script>
{% endblock content %}