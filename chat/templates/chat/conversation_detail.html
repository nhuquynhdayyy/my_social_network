{% extends "posts/base.html" %}
{% load post_extras %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex align-items-center">
            
            <!-- === B·∫ÆT ƒê·∫¶U PH·∫¶N TH√äM M·ªöI: N√öT QUAY L·∫†I === -->
            <a href="{% url 'chat:conversation_list' %}" class="btn btn-light me-3" title="Quay l·∫°i danh s√°ch">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"/>
                </svg>
            </a>
            <!-- === K·∫æT TH√öC PH·∫¶N TH√äM M·ªöI === -->

            <!-- Ph·∫ßn header hi·ªÉn th·ªã th√¥ng tin chat (ƒë√£ c√≥ t·ª´ tr∆∞·ªõc) -->
            {% if conversation.type == 'GROUP' %}
                <!-- Giao di·ªán cho Group Chat -->
                <img src="{{ conversation.avatar.url }}" class="rounded-circle me-3" width="40" height="40" alt="{{ conversation.name }}">
                <div>
                    <h4 class="mb-0">{{ conversation.name }}</h4>
                    <small class="text-muted">
                        Th√†nh vi√™n: {% for p in conversation.participants.all %}{{ p.first_name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                    </small>
                </div>
            {% else %}
                <!-- Giao di·ªán cho Chat C√° nh√¢n -->
                <img src="{{ other_participant.avatar.url }}" class="rounded-circle me-3" width="40" height="40" alt="{{ other_participant.username }}">
                <h4 class="mb-0">Tr√≤ chuy·ªán v·ªõi {{ other_participant.first_name }} {{ other_participant.last_name }}</h4>
            {% endif %}
        </div>

        <div class="card-body" id="message-container" style="height: 60vh; overflow-y: auto;">
            {% for message in messages %}
                <div id="message-{{ message.id }}" class="mb-3 d-flex {% if message.sender == user %}justify-content-end{% else %}justify-content-start{% endif %}">
                    <div class="d-flex align-items-end {% if message.sender == user %}flex-row-reverse{% endif %}">
                        
                        <!-- Hi·ªÉn th·ªã Avatar c·ªßa ng∆∞·ªùi g·ª≠i (ch·ªâ trong nh√≥m v√† kh√¥ng ph·∫£i tin c·ªßa m√¨nh) -->
                        {% if conversation.type == 'GROUP' and message.sender != user %}
                        <img src="{{ message.sender.avatar.url }}" class="rounded-circle" width="30" height="30" alt="{{ message.sender.username }}" title="{{ message.sender.username }}"
                             style="margin-left: 8px; margin-right: 8px;">
                        {% endif %}

                        <div class="message-bubble-container">
                            <div class="message-bubble p-2 rounded {% if message.sender == user %}bg-primary text-white{% else %}bg-light{% endif %}" style="max-width: 70%;">
                                
                                <!-- Hi·ªÉn th·ªã T√™n ng∆∞·ªùi g·ª≠i (ch·ªâ trong nh√≥m v√† kh√¥ng ph·∫£i tin c·ªßa m√¨nh) -->
                                {% if conversation.type == 'GROUP' and message.sender != user %}
                                <div class="fw-bold" style="font-size: 0.8rem;">{{ message.sender.first_name }}</div>
                                {% endif %}

                                <p class="mb-0 message-text">{{ message.text }}</p>
                                <small class="text-muted d-block text-end {% if message.sender == user %}text-white-50{% endif %}">
                                    {{ message.timestamp|date:"H:i" }}
                                </small>
                                
                                {% if message.sender == user %}
                                <div class="message-actions">
                                    <button class="btn btn-sm btn-light py-0 px-1" onclick="showEditForm('{{ message.id }}')">S·ª≠a</button>
                                    <button class="btn btn-sm btn-danger py-0 px-1" onclick="deleteMessage('{{ message.id }}')">X√≥a</button>
                                </div>
                                <div id="edit-form-{{ message.id }}" style="display: none;">
                                    <textarea class="form-control form-control-sm mt-1" id="edit-text-{{ message.id }}">{{ message.text }}</textarea>
                                    <button class="btn btn-sm btn-success mt-1" onclick="submitEdit('{{ message.id }}')">L∆∞u</button>
                                    <button class="btn btn-sm btn-secondary mt-1" onclick="hideEditForm('{{ message.id }}')">H·ªßy</button>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Ph·∫ßn Reaction gi·ªØ nguy√™n -->
                            <div id="message-reaction-stats-{{ message.id }}" class="reaction-stats-display">
                                {% with stats=message.reactions.values.count %}
                                    {% if stats > 0 %}
                                        <span>üëç</span>
                                        <span class="reaction-count">{{ stats }}</span>
                                    {% endif %}
                                {% endwith %}
                            </div>
                            <div class="reaction-popup">
                                <button class="btn message-reaction-choice-btn" data-message-id="{{ message.id }}" data-reaction-type="LIKE">üëç</button>
                                <button class="btn message-reaction-choice-btn" data-message-id="{{ message.id }}" data-reaction-type="LOVE">‚ù§Ô∏è</button>
                                <button class="btn message-reaction-choice-btn" data-message-id="{{ message.id }}" data-reaction-type="HAHA">üòÇ</button>
                                <button class="btn message-reaction-choice-btn" data-message-id="{{ message.id }}" data-reaction-type="WOW">üòÆ</button>
                                <button class="btn message-reaction-choice-btn" data-message-id="{{ message.id }}" data-reaction-type="SAD">üò¢</button>
                                <button class="btn message-reaction-choice-btn" data-message-id="{{ message.id }}" data-reaction-type="ANGRY">üò°</button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="card-footer">
            <form id="message-form" method="post" action="{% url 'chat:send_message_api' conversation.id %}">
                {% csrf_token %}
                <div class="input-group">
                    {{ form.text }}
                    <button class="btn btn-primary" type="submit">G·ª≠i</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .message-bubble-container { position: relative; }
    .message-bubble-container:hover .reaction-popup { display: flex; }
    .reaction-popup { display: none; position: absolute; top: -35px; left: 10px; background-color: white; border-radius: 20px; padding: 4px 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10; gap: 5px; }
    .reaction-popup .btn { font-size: 1.2rem; padding: 0; border: none; background: none; transition: transform 0.1s; }
    .reaction-popup .btn:hover { transform: scale(1.3); }
    .reaction-stats-display { position: absolute; bottom: -10px; right: 5px; background-color: #f8f9fa; border-radius: 10px; padding: 1px 6px; font-size: 0.75rem; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .message-actions { display: none; }
    .message-bubble:hover .message-actions { display: inline-block; margin-left: 10px; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageContainer = document.getElementById('message-container');
    const messageForm = document.getElementById('message-form');
    const csrftoken = getCookie('csrftoken');

    messageContainer.scrollTop = messageContainer.scrollHeight;

    messageContainer.addEventListener('click', function(event) {
        const button = event.target.closest('.message-reaction-choice-btn');
        if (button) {
            const messageId = button.dataset.messageId;
            const reactionType = button.dataset.reactionType;
            reactToMessage(messageId, reactionType);
        }
    });

    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const textInput = document.querySelector('[name="text"]');
        const text = textInput.value.trim();
        if (!text) return;

        const url = this.action;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken,
            },
            body: `text=${encodeURIComponent(text)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                location.reload();
            } else {
                alert("G·ª≠i tin nh·∫Øn th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.");
            }
        });
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function reactToMessage(messageId, reactionType) {
    fetch(`/chat/api/message/react/${messageId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ reaction_type: reactionType })
    }).then(response => response.json()).then(data => {
        if (data.status === 'ok') {
            updateReactionStatsUI(messageId, data.reaction_stats, data.total_reactions);
        } else { alert('L·ªói: ' + data.message); }
    });
}

function updateReactionStatsUI(messageId, stats, total) {
    const statsContainer = document.getElementById(`message-reaction-stats-${messageId}`);
    if (!statsContainer) return;
    if (total > 0) {
        let iconsHTML = '';
        if (stats.LIKE) iconsHTML += '<span>üëç</span>';
        if (stats.LOVE) iconsHTML += '<span>‚ù§Ô∏è</span>';
        if (stats.HAHA) iconsHTML += '<span>üòÇ</span>';
        if (stats.WOW) iconsHTML += '<span>üòÆ</span>';
        if (stats.SAD) iconsHTML += '<span>üò¢</span>';
        if (stats.ANGRY) iconsHTML += '<span>üò°</span>';
        statsContainer.innerHTML = `${iconsHTML} <span class="reaction-count">${total}</span>`;
    } else {
        statsContainer.innerHTML = '';
    }
}

function deleteMessage(messageId) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a tin nh·∫Øn n√†y?')) return;
    fetch(`/chat/api/message/delete/${messageId}/`, {
        method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}
    }).then(response => response.json()).then(data => {
        if (data.status === 'ok') { document.getElementById(`message-${data.message_id}`).remove(); }
        else { alert('L·ªói: ' + data.message); }
    });
}

function showEditForm(messageId) {
    document.getElementById(`edit-form-${messageId}`).style.display = 'block';
    document.getElementById(`message-${messageId}`).querySelector('.message-text').style.display = 'none';
}

function hideEditForm(messageId) {
     document.getElementById(`edit-form-${messageId}`).style.display = 'none';
     document.getElementById(`message-${messageId}`).querySelector('.message-text').style.display = 'block';
}

function submitEdit(messageId) {
    const newText = document.getElementById(`edit-text-${messageId}`).value;
    fetch(`/chat/api/message/edit/${messageId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({text: newText})
    }).then(response => response.json()).then(data => {
        if (data.status === 'ok') {
            const messageDiv = document.getElementById(`message-${data.message_id}`);
            messageDiv.querySelector('.message-text').innerText = data.new_text;
            hideEditForm(messageId);
        } else { alert('L·ªói: ' + data.message); }
    });
}
</script>
{% endblock content %}