{% extends "posts/base.html" %}
{% load post_extras %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <!-- Header -->
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a href="{% url 'chat:conversation_list' %}" class="btn btn-light me-3" title="Quay l·∫°i danh s√°ch">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"/></svg>
                </a>
                {% if conversation.type == 'GROUP' %}
                    <img src="{{ conversation.avatar.url }}" class="rounded-circle me-3" width="40" height="40" alt="{{ conversation.name }}">
                    <div>
                        <h4 class="mb-0">{{ conversation.name }}</h4>
                    </div>
                {% else %}
                    <img src="{{ other_participant.avatar.url }}" class="rounded-circle me-3" width="40" height="40" alt="{{ other_participant.username }}">
                    <h4 class="mb-0"> {{ other_participant.first_name }} {{ other_participant.last_name }}</h4>
                {% endif %}
            </div>
            <div>
                {% if conversation.type == 'GROUP' %}
                    <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#membersModal">Xem th√†nh vi√™n</button>
                    <a href="{% url 'chat:manage_group' conversation.id %}" class="btn btn-outline-primary btn-sm">T√πy ch·ªânh nh√≥m</a>
                {% elif conversation.type == 'PRIVATE' %}
                    <a href="{% url 'chat:create_group' %}?with_user={{ other_participant.id }}" class="btn btn-outline-primary btn-sm" title="T·∫°o nh√≥m v·ªõi {{ other_participant.first_name }}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-plus-fill" viewBox="0 0 16 16">
                          <path d="M1 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                          <path fill-rule="evenodd" d="M13.5 5a.5.5 0 0 1 .5.5V7h1.5a.5.5 0 0 1 0 1H14v1.5a.5.5 0 0 1-1 0V8h-1.5a.5.5 0 0 1 0-1H13V5.5a.5.5 0 0 1 .5-.5z"/>
                        </svg>
                        T·∫°o nh√≥m
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- Ph·∫ßn th√¢n chat -->
        <div class="card-body" id="message-container" style="height: 60vh; overflow-y: auto;">
            {% for message in messages %}
                {% if not message.sender %}
                <div class="text-center my-3">
                    <span class="text-muted small px-2 py-1" style="background-color: #f0f2f5; border-radius: 10px;">
                        {{ message.text }}
                    </span>
                </div>
                {% else %}
                <div id="message-{{ message.id }}" class="mb-3 d-flex {% if message.sender == user %}justify-content-end{% else %}justify-content-start{% endif %}">
                    <div class="d-flex align-items-end {% if message.sender == user %}flex-row-reverse{% endif %}">
                        {% if conversation.type == 'GROUP' and message.sender != user %}
                        <img src="{{ message.sender.avatar.url }}" class="rounded-circle" width="30" height="30" alt="{{ message.sender.username }}" title="{{ message.sender.username }}"
                             style="margin-left: 8px; margin-right: 8px;">
                        {% endif %}

                        <div class="message-bubble-container">
                            <div class="message-bubble p-2 rounded {% if message.sender == user %}bg-primary text-white{% else %}bg-light{% endif %}" style="max-width: 70%;">
                                {% if conversation.type == 'GROUP' and message.sender != user %}
                                <div class="fw-bold" style="font-size: 0.8rem;">{{ message.sender.first_name }}</div>
                                {% endif %}

                                {% if message.file %}
                                    <div class="mb-1">
                                        {% if message.is_image %}
                                            <img src="{{ message.file.url }}" class="img-fluid rounded" style="max-height: 300px; width: auto;" alt="Sent image">
                                        {% elif message.is_video %}
                                            <video src="{{ message.file.url }}" controls class="img-fluid rounded" style="max-height: 300px; width: auto;"></video>
                                        {% else %}
                                            <a href="{{ message.file.url }}" target="_blank" class="text-decoration-none {% if message.sender == user %}text-white{% else %}text-body{% endif %}">
                                                üìé {{ message.file.name }}
                                            </a>
                                        {% endif %}
                                    </div>
                                {% endif %}

                                {% if message.text %}
                                    <p class="mb-0 message-text">{{ message.text|linebreaksbr }}</p>
                                {% endif %}
                                
                                <small class="text-muted d-block text-end {% if message.sender == user %}text-white-50{% endif %}">{{ message.timestamp|date:"H:i" }}</small>
                                
                                {% if message.sender == user %}
                                <div class="message-actions">
                                    {% if message.text %}<button class="btn btn-sm btn-light py-0 px-1" onclick="showEditForm('{{ message.id }}')">S·ª≠a</button>{% endif %}
                                    <button class="btn btn-sm btn-danger py-0 px-1" onclick="deleteMessage('{{ message.id }}')">X√≥a</button>
                                </div>
                                <div id="edit-form-{{ message.id }}" style="display: none;">
                                    <textarea class="form-control form-control-sm mt-1" id="edit-text-{{ message.id }}">{{ message.text }}</textarea>
                                    <button class="btn btn-sm btn-success mt-1" onclick="submitEdit('{{ message.id }}')">L∆∞u</button>
                                    <button class="btn btn-sm btn-secondary mt-1" onclick="hideEditForm('{{ message.id }}')">H·ªßy</button>
                                </div>
                                {% endif %}
                            </div>

                            <div id="message-reaction-stats-{{ message.id }}" class="reaction-stats-display">
                                {% with stats=message.reactions.values.count %}
                                    {% if stats > 0 %}
                                        <span>üëç</span>
                                        <span class="reaction-count">{{ stats }}</span>
                                    {% endif %}
                                {% endwith %}
                            </div>
                            
                            <!-- === S·ª¨A L·∫†I PH·∫¶N N√ÄY ƒê·ª¶ 6 ICON === -->
                            <div class="reaction-popup">
                                <button class="btn message-reaction-choice-btn" data-message-id="{{ message.id }}" data-reaction-type="LIKE">üëç</button>
                                <button class="btn message-reaction-choice-btn" data-message-id="{{ message.id }}" data-reaction-type="LOVE">‚ù§Ô∏è</button>
                                <button class="btn message-reaction-choice-btn" data-message-id="{{ message.id }}" data-reaction-type="HAHA">üòÇ</button>
                                <button class="btn message-reaction-choice-btn" data-message-id="{{ message.id }}" data-reaction-type="WOW">üòÆ</button>
                                <button class="btn message-reaction-choice-btn" data-message-id="{{ message.id }}" data-reaction-type="SAD">üò¢</button>
                                <button class="btn message-reaction-choice-btn" data-message-id="{{ message.id }}" data-reaction-type="ANGRY">üò°</button>
                            </div>
                            <!-- ==================================== -->
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- Footer g·ª≠i tin nh·∫Øn -->
        <div class="card-footer">
            <form id="message-form" method="post" enctype="multipart/form-data" action="{% url 'chat:send_message_api' conversation.id %}">
                {% csrf_token %}
                <div class="input-group align-items-center bg-white rounded-pill border px-2 py-1">
                    <label for="chat-file-input" class="btn btn-link text-secondary m-0 p-2" style="cursor: pointer;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-image" viewBox="0 0 16 16">
                            <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                            <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                        </svg>
                    </label>
                    <input type="file" name="file" id="chat-file-input" class="d-none" accept="image/*,video/*">
                    <input type="text" name="text" class="form-control border-0 shadow-none" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
                    <button class="btn btn-link text-primary m-0 p-2 text-decoration-none fw-bold" type="submit">G·ª≠i</button>
                </div>
                <div id="file-preview-container" class="mt-2 d-none ms-3">
                     <span class="badge bg-secondary position-relative">
                        <span id="file-name-preview">filename.jpg</span>
                        <button type="button" class="btn-close btn-close-white ms-2" id="clear-file-btn" style="font-size: 0.5rem;"></button>
                    </span>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal hi·ªÉn th·ªã danh s√°ch th√†nh vi√™n (Gi·ªØ nguy√™n) -->
{% if conversation.type == 'GROUP' %}
<div class="modal fade" id="membersModal" tabindex="-1" aria-labelledby="membersModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold" id="membersModalLabel">Th√†nh vi√™n ({{ participants.count }})</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group list-group-flush">
          {% for member in participants %}
            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-3 border-bottom-0">
                <div class="d-flex align-items-center">
                    <img src="{{ member.avatar.url }}" class="rounded-circle me-3 border" width="48" height="48" style="object-fit: cover;">
                    <div>
                        <div class="d-flex align-items-center">
                            <a href="{% url 'accounts:profile' username=member.username %}" class="text-decoration-none fw-bold text-dark" style="font-size: 1rem;">
                                {{ member.first_name }} {{ member.last_name }}
                            </a>
                            {% if member == conversation.admin %}
                                <span class="badge bg-primary bg-opacity-10 text-primary ms-2 rounded-pill" style="font-size: 0.65rem; padding: 4px 8px;">Qu·∫£n tr·ªã vi√™n</span>
                            {% endif %}
                        </div>
                        <div class="text-muted small">@{{ member.username }}</div>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    {% if member != request.user %}
                        <a href="{% url 'chat:start_conversation' user_id=member.id %}" class="btn btn-light btn-sm rounded-circle d-flex align-items-center justify-content-center text-muted" title="Nh·∫Øn tin ri√™ng" style="width: 36px; height: 36px; background-color: #f0f2f5;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-chat-dots-fill" viewBox="0 0 16 16"><path d="M16 8c0 3.866-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.584.296-1.925.864-4.181 1.234-.2.032-.352-.176-.273-.362.354-.836.674-1.95.77-2.966C.744 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7zM5 8a1 1 0 1 0-2 0 1 1 0 0 0 2 0zm4 0a1 1 0 1 0-2 0 1 1 0 0 0 2 0zm4 0a1 1 0 1 0-2 0 1 1 0 0 0 2 0z"/></svg>
                        </a>
                    {% endif %}
                    {% if member != request.user and member != conversation.admin %}
                        {% if is_group_admin or not conversation.admin_only_management %}
                            <a href="{% url 'chat:remove_member' conversation_id=conversation.id user_id=member.id %}" class="btn btn-light btn-sm rounded-circle d-flex align-items-center justify-content-center text-danger" title="X√≥a kh·ªèi nh√≥m" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën m·ªùi {{ member.username }} ra kh·ªèi nh√≥m?');" style="width: 36px; height: 36px; background-color: #f0f2f5;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/></svg>
                            </a>
                        {% endif %}
                    {% endif %}
                </div>
            </li>
          {% endfor %}
        </ul>
      </div>
      <div class="modal-footer border-0 pt-0">
        <form method="post" action="{% url 'chat:leave_group' conversation.id %}" class="w-100">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger w-100 rounded-pill fw-bold" onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën r·ªùi kh·ªèi nh√≥m n√†y kh√¥ng?');">R·ªùi kh·ªèi nh√≥m</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<style>
    .message-bubble-container { position: relative; }
    .message-bubble-container:hover .reaction-popup { display: flex; }
    .reaction-popup { display: none; position: absolute; top: -35px; left: 10px; background-color: white; border-radius: 20px; padding: 4px 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10; gap: 5px; }
    .reaction-popup .btn { font-size: 1.2rem; padding: 0; border: none; background: none; transition: transform 0.1s; }
    .reaction-popup .btn:hover { transform: scale(1.3); }
    .reaction-stats-display { position: absolute; bottom: -10px; right: 5px; background-color: #f8f9fa; border-radius: 10px; padding: 1px 6px; font-size: 0.75rem; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .message-actions { display: none; }
    .message-bubble:hover .message-actions { display: inline-block; margin-left: 10px; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageContainer = document.getElementById('message-container');
    const messageForm = document.getElementById('message-form');
    const csrftoken = getCookie('csrftoken');
    
    const fileInput = document.getElementById('chat-file-input');
    const filePreviewContainer = document.getElementById('file-preview-container');
    const fileNamePreview = document.getElementById('file-name-preview');
    const clearFileBtn = document.getElementById('clear-file-btn');

    messageContainer.scrollTop = messageContainer.scrollHeight;

    fileInput.addEventListener('change', function() {
        if (this.files && this.files.length > 0) {
            fileNamePreview.textContent = this.files[0].name;
            filePreviewContainer.classList.remove('d-none');
        }
    });

    clearFileBtn.addEventListener('click', function() {
        fileInput.value = '';
        filePreviewContainer.classList.add('d-none');
    });

    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const textInput = document.querySelector('[name="text"]');
        const text = textInput.value.trim();
        const file = fileInput.files[0];

        if (!text && !file) return;

        const url = this.action;
        const formData = new FormData();
        formData.append('text', text);
        if (file) {
            formData.append('file', file);
        }

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                location.reload(); 
            } else {
                alert("G·ª≠i tin nh·∫Øn th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.");
            }
        });
    });

    messageContainer.addEventListener('click', function(event) {
        const button = event.target.closest('.message-reaction-choice-btn');
        if (button) {
            const messageId = button.dataset.messageId;
            const reactionType = button.dataset.reactionType;
            reactToMessage(messageId, reactionType);
        }
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function reactToMessage(messageId, reactionType) {
    fetch(`/chat/api/message/react/${messageId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ reaction_type: reactionType })
    }).then(response => response.json()).then(data => {
        if (data.status === 'ok') {
            updateReactionStatsUI(messageId, data.reaction_stats, data.total_reactions);
        } else { alert('L·ªói: ' + data.message); }
    });
}
function updateReactionStatsUI(messageId, stats, total) {
    const statsContainer = document.getElementById(`message-reaction-stats-${messageId}`);
    if (!statsContainer) return;
    if (total > 0) {
        let iconsHTML = '';
        if (stats.LIKE) iconsHTML += '<span>üëç</span>';
        if (stats.LOVE) iconsHTML += '<span>‚ù§Ô∏è</span>';
        if (stats.HAHA) iconsHTML += '<span>üòÇ</span>';
        if (stats.WOW) iconsHTML += '<span>üòÆ</span>';
        if (stats.SAD) iconsHTML += '<span>üò¢</span>';
        if (stats.ANGRY) iconsHTML += '<span>üò°</span>';
        statsContainer.innerHTML = `${iconsHTML} <span class="reaction-count">${total}</span>`;
    } else {
        statsContainer.innerHTML = '';
    }
}
function deleteMessage(messageId) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a tin nh·∫Øn n√†y?')) return;
    fetch(`/chat/api/message/delete/${messageId}/`, {
        method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}
    }).then(response => response.json()).then(data => {
        if (data.status === 'ok') { document.getElementById(`message-${data.message_id}`).remove(); }
        else { alert('L·ªói: ' + data.message); }
    });
}
function showEditForm(messageId) {
    document.getElementById(`edit-form-${messageId}`).style.display = 'block';
    document.getElementById(`message-${messageId}`).querySelector('.message-text').style.display = 'none';
}
function hideEditForm(messageId) {
     document.getElementById(`edit-form-${messageId}`).style.display = 'none';
     document.getElementById(`message-${messageId}`).querySelector('.message-text').style.display = 'block';
}
function submitEdit(messageId) {
    const newText = document.getElementById(`edit-text-${messageId}`).value;
    fetch(`/chat/api/message/edit/${messageId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({text: newText})
    }).then(response => response.json()).then(data => {
        if (data.status === 'ok') {
            const messageDiv = document.getElementById(`message-${data.message_id}`);
            messageDiv.querySelector('.message-text').innerText = data.new_text;
            hideEditForm(messageId);
        } else { alert('L·ªói: ' + data.message); }
    });
}
</script>
{% endblock content %}