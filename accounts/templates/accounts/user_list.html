<!-- accounts/templates/accounts/user_list.html -->
{% extends "posts/base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <h2 class="mb-0">Tìm kiếm bạn bè</h2>
        </div>
        <!-- === PHẦN THANH TÌM KIẾM === -->
        <div class="col-md-6">
            <form method="GET" action="." class="d-flex">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search text-muted" viewBox="0 0 16 16">
                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                        </svg>
                    </span>
                    <input type="text" name="q" class="form-control border-start-0" placeholder="Nhập tên hoặc username..." value="{{ query|default:'' }}" autocomplete="off">
                    <button class="btn btn-primary" type="submit">Tìm</button>
                    
                    {% if query %}
                        <!-- Nút xóa tìm kiếm để quay lại danh sách đầy đủ -->
                        <a href="{% url 'accounts:user_list' %}" class="btn btn-outline-secondary">Xóa lọc</a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        {% for u in users %}
        <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body d-flex align-items-center">
                    <a href="{% url 'accounts:profile' username=u.username %}">
                        <img src="{{ u.avatar.url }}" class="rounded-circle me-3" width="60" height="60" alt="{{ u.username }}" style="object-fit: cover;">
                    </a>
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-1" style="font-size: 1rem;">
                            <a href="{% url 'accounts:profile' username=u.username %}" class="text-decoration-none text-dark fw-bold">{{ u.first_name }} {{ u.last_name }}</a>
                        </h5>
                        <p class="card-subtitle mb-2 text-muted small">@{{ u.username }}</p>

                        <!-- Nhóm các nút hành động lại với nhau -->
                        <div class="mt-2 d-flex flex-wrap gap-2">
                            <!-- Logic hiển thị nút bạn bè -->
                            {% if u.id in friend_ids %}
                                <button class="btn btn-success btn-sm" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/></svg>
                                    Bạn bè
                                </button>
                            {% elif u.id in sent_request_ids %}
                                <button class="btn btn-secondary btn-sm" disabled>Đã gửi lời mời</button>
                            {% elif u.id in received_request_ids %}
                                <a href="{% url 'accounts:friend_requests' %}" class="btn btn-info btn-sm text-white">Phản hồi</a>
                            {% else %}
                                <a href="{% url 'accounts:add_friend' username=u.username %}" class="btn btn-primary btn-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-person-plus-fill" viewBox="0 0 16 16"><path d="M1 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path fill-rule="evenodd" d="M13.5 5a.5.5 0 0 1 .5.5V7h1.5a.5.5 0 0 1 0 1H14v1.5a.5.5 0 0 1-1 0V8h-1.5a.5.5 0 0 1 0-1H13V5.5a.5.5 0 0 1 .5-.5z"/></svg>
                                    Thêm bạn
                                </a>
                            {% endif %}
    
                            <!-- Nút nhắn tin -->
                            <a href="{% url 'chat:start_conversation' user_id=u.id %}" class="btn btn-outline-primary btn-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-chat-dots-fill" viewBox="0 0 16 16"><path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/><path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6-.097 1.016-.417 2.13-.771 2.966-.079.186.074.394.273.362 2.256-.37 3.597-.938 4.18-1.234A9.06 9.06 0 0 0 8 15z"/></svg>
                                Nhắn tin
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 mt-4">
            <div class="text-center p-5 bg-white rounded shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-search text-muted mb-3" viewBox="0 0 16 16">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                </svg>
                {% if query %}
                    <h5 class="text-muted">Không tìm thấy kết quả nào cho "<strong>{{ query }}</strong>"</h5>
                    <p class="text-muted">Hãy thử tìm kiếm với từ khóa khác.</p>
                    <a href="{% url 'accounts:user_list' %}" class="btn btn-outline-primary mt-2">Xem tất cả mọi người</a>
                {% else %}
                    <h5 class="text-muted">Không có người dùng nào để hiển thị.</h5>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock content %}