<!-- accounts/templates/accounts/user_list.html -->
{% extends "posts/base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Tìm kiếm bạn bè</h2>
    <div class="row">
        {% for u in users %}
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body d-flex align-items-center">
                    <img src="{{ u.avatar.url }}" class="rounded-circle me-3" width="60" height="60" alt="{{ u.username }}">
                    <div>
                        <h5 class="card-title">
                            <a href="{% url 'accounts:profile' username=u.username %}" class="text-decoration-none">{{ u.first_name }} {{ u.last_name }}</a>
                        </h5>
                        <h6 class="card-subtitle mb-2 text-muted">@{{ u.username }}</h6>
                        
                        {% comment %} <!-- Logic hiển thị nút -->
                        {% if u.id in friend_ids %}
                            <span class="badge bg-success">Bạn bè</span>
                        {% elif u.id in sent_request_ids %}
                            <button class="btn btn-secondary btn-sm" disabled>Đã gửi yêu cầu</button>
                        {% elif u.id in received_request_ids %}
                            <!-- Sau này sẽ làm nút Chấp nhận/Từ chối ở đây -->
                            <a href="#" class="btn btn-info btn-sm">Phản hồi yêu cầu</a>
                        {% else %}
                            <!-- SỬA Ở ĐÂY: Thêm 'accounts:' -->
                            <a href="{% url 'accounts:add_friend' username=u.username %}" class="btn btn-primary btn-sm">Thêm bạn bè</a>
                        {% endif %} {% endcomment %}

                        <!-- Nhóm các nút hành động lại với nhau -->
                        <div class="mt-2">
                            <!-- Logic hiển thị nút bạn bè -->
                            {% if u.id in friend_ids %}
                                <span class="badge bg-success">Bạn bè</span>
                            {% elif u.id in sent_request_ids %}
                                <button class="btn btn-secondary btn-sm" disabled>Đã gửi yêu cầu</button>
                            {% elif u.id in received_request_ids %}
                                <a href="#" class="btn btn-info btn-sm">Phản hồi yêu cầu</a>
                            {% else %}
                                <a href="{% url 'accounts:add_friend' username=u.username %}" class="btn btn-primary btn-sm">Thêm bạn bè</a>
                            {% endif %}
    
                            <!-- === NÚT NHẮN TIN ĐÃ ĐƯỢC THÊM VÀO ĐÂY === -->
                            <!-- Nút này sẽ luôn hiển thị, cho phép nhắn tin ngay cả khi chưa là bạn bè. -->
                            <!-- Nó sẽ gọi đến URL 'start_conversation' của app 'chat' với user_id tương ứng. -->
                            <a href="{% url 'chat:start_conversation' user_id=u.id %}" class="btn btn-outline-primary btn-sm ms-2">
                                Nhắn tin
                            </a>
                            <!-- ============================================= -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <p class="text-center text-muted">Không tìm thấy người dùng nào.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock content %}