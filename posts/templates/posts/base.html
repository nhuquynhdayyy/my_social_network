<!-- posts/templates/posts/base.html (ƒê√É S·ª¨A L·ªñI) -->
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>MySocial</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Th√™m Google Font cho Logo (Gi·ªëng Instagram) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">


    <!-- === CSS T·ªîNG H·ª¢P CHO TO√ÄN B·ªò TRANG === -->
    <style>
      body {
        background-color: #fafafa;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 244px;
        background-color: #ffffff;
        border-right: 1px solid #dbdbdb;
        padding: 8px 12px 20px;
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease;
        z-index: 1000;
      }

      .sidebar-brand {
        font-family: 'Lobster', cursive;
        font-size: 2rem;
        text-decoration: none;
        color: #000000;
        padding: 25px 12px 35px;
      }

      .sidebar-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .sidebar-nav li a {
        display: flex;
        align-items: center;
        padding: 12px;
        margin: 4px 0;
        border-radius: 8px;
        text-decoration: none;
        color: #000000;
        font-weight: 500;
        transition: background-color 0.2s ease-in-out;
      }

      .sidebar-nav li a:hover {
        background-color: #f2f2f2;
      }

      .sidebar-nav .nav-icon {
        width: 24px;
        height: 24px;
        margin-right: 16px;
      }
      
      .sidebar-footer {
        margin-top: auto;
      }

      .main-content {
        /* Ch·ªâ th√™m margin-left n·∫øu ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p v√† c√≥ sidebar */
        {% if user.is_authenticated or request.path == '/accounts/login/' or request.path == '/accounts/register/' %}
        margin-left: 244px;
        {% else %}
        margin-left: 0;
        {% endif %}
        padding: 20px;
        transition: margin-left 0.3s ease;
        position: relative;
      }
      /* === CSS CHO REACTION TR√äN B√åNH LU·∫¨N (ƒê√É B·ªä THI·∫æU) === */
      .comment-reaction-container {
          /* ƒê√¢y l√† d√≤ng quan tr·ªçng nh·∫•t, bi·∫øn container th√†nh khung tham chi·∫øu */
          position: relative;
          /* T·∫†O V√ôNG ƒê·ªÜM V√î H√åNH ·ªû TR√äN ƒê·ªÇ B·∫ÆT S·ª∞ KI·ªÜN R√ä CHU·ªòT */
          padding-top: 1rem;
          /* K√âO CONTAINER V·ªÄ V·ªä TR√ç C≈®, TR√ÅNH X√î L·ªÜCH GIAO DI·ªÜN */
          margin-top: -1rem;
      }

      .comment-reaction-popup {
          display: none; /* M·∫∑c ƒë·ªãnh ·∫©n ƒëi */
          position: absolute;
          bottom: 1.8rem; /* V·ªã tr√≠ ph√≠a tr√™n n√∫t "Th√≠ch" */
          left: -10px;
          background-color: white;
          border-radius: 20px;
          padding: 5px 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          white-space: nowrap;
          z-index: 1010; /* ƒê·∫∑t z-index cao h∆°n sidebar ƒë·ªÉ ch·∫Øc ch·∫Øn n·ªïi l√™n tr√™n */
          gap: 5px;
      }

      /* Khi di chu·ªôt v√†o container, hi·ªÉn th·ªã popup con c·ªßa n√≥ */
      .comment-reaction-container:hover .comment-reaction-popup {
          display: flex;
      }

      .comment-reaction-popup .btn {
          font-size: 1.5rem;
          padding: 0;
          border: none;
          background: none;
          transition: transform 0.1s;
      }

      .comment-reaction-popup .btn:hover {
          transform: scale(1.2);
      }

      /* === CSS: CHO REACTION TR√äN B√ÄI VI·∫æT (POST) - ƒê√É S·ª¨A L·∫†I CHO M∆Ø·ª¢T === */
      .post-reaction-container {
          position: relative;
          /* T·∫†O V√ôNG ƒê·ªÜM V√î H√åNH ·ªû TR√äN ƒê·ªÇ B·∫ÆT S·ª∞ KI·ªÜN R√ä CHU·ªòT */
          padding-top: 1rem;
          /* K√âO CONTAINER V·ªÄ V·ªä TR√ç C≈®, TR√ÅNH X√î L·ªÜCH GIAO DI·ªÜN */
          margin-top: -1rem;
      }

      .post-reaction-popup {
          display: none;
          position: absolute;
          bottom: 2.2rem; /* ƒêi·ªÅu ch·ªânh ƒë·ªÉ n·∫±m ngay tr√™n n√∫t "Th√≠ch" c·ªßa b√†i vi·∫øt */
          left: 0;
          background-color: white;
          border-radius: 20px;
          padding: 5px 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          white-space: nowrap;
          z-index: 1010;
          gap: 5px;
      }

      /* Khi di chu·ªôt v√†o container, hi·ªÉn th·ªã popup */
      .post-reaction-container:hover .post-reaction-popup {
          display: flex; 
      }

      .post-reaction-popup .btn {
          font-size: 1.8rem;
          padding: 0;
          border: none;
          background: none;
          transition: transform 0.1s;
      }

      .post-reaction-popup .btn:hover {
          transform: scale(1.2);
      }
      .chat-open-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #007bff; /* V√≠ d·ª• m√†u */
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
        display: flex; /* ƒê·∫£m b·∫£o n√∫t hi·ªÉn th·ªã */
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        z-index: 1000;
      }
      /* === CSS cho Chat Widget (B·ªä THI·∫æU) === */
      .chat-widget-container {
          position: fixed;
          bottom: 25px;
          right: 25px;
          z-index: 1050;
      }
      .chat-popup {
          display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
          position: absolute;
          bottom: 80px; /* V·ªã tr√≠ ph√≠a tr√™n n√∫t m·ªü */
          right: 0;
          width: 320px;
          border-radius: 10px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
          background-color: white;
          flex-direction: column; /* S·∫Øp x·∫øp header, body, footer theo chi·ªÅu d·ªçc */
      }
      .chat-popup-header {
          background-color: #0d6efd;
          color: white;
          padding: 10px 15px;
          border-top-left-radius: 10px;
          border-top-right-radius: 10px;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      .chat-popup-header h4 {
          margin: 0;
          font-size: 1.1rem;
      }
      .chat-popup-header .header-buttons {
          display: flex;
          align-items: center;
          gap: 10px;
      }
      .chat-popup-body {
          padding: 0;
          max-height: 400px; /* Gi·ªõi h·∫°n chi·ªÅu cao v√† cho ph√©p cu·ªôn */
          overflow-y: auto;
      }
      .chat-popup-body .conversation-item {
          display: flex;
          align-items: center;
          padding: 10px;
          border-bottom: 1px solid #eee;
          text-decoration: none;
          color: #212529;
          transition: background-color 0.2s;
      }
      .chat-popup-body .conversation-item:last-child {
          border-bottom: none;
      }
      .chat-popup-body .conversation-item:hover {
          background-color: #f1f1f1;
      }
      .chat-popup-body .conversation-item .last-message {
          font-size: 0.85rem;
          color: #6c757d;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }
      .chat-action-btn {
          background: none;
          border: none;
          color: white;
          cursor: pointer;
          padding: 0;
          font-size: 1.2rem;
      }
      #search-users-view .search-header {
          padding: 10px;
          border-bottom: 1px solid #eee;
          display: flex;
          align-items: center;
          gap: 10px;
      }
      #search-users-view input {
          border-radius: 20px;
      }
    </style>
  </head>
  <body>
    <!-- B·ªçc to√†n b·ªô sidebar trong ƒëi·ªÅu ki·ªán user ƒë√£ ƒëƒÉng nh·∫≠p -->
    {% if user.is_authenticated %}
    <div class="sidebar">
      <!-- Ph·∫ßn logo -->
      <a class="sidebar-brand" href="{% url 'posts:home' %}">MySocial</a>
      
      <!-- Ph·∫ßn ƒëi·ªÅu h∆∞·ªõng ch√≠nh -->
      <nav class="sidebar-nav flex-grow-1">
        <ul>
          <li>
            <a href="{% url 'posts:home' %}">
              <svg class="nav-icon" aria-label="Home" fill="currentColor" viewBox="0 0 24 24"><path d="M22 23h-6.001a1 1 0 0 1-1-1v-5.455a2.997 2.997 0 0 0-2.2-2.822 2.997 2.997 0 0 0-3.6 2.822V22a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V11.543a1.002 1.002 0 0 1 .31-.724l10-9.543a1.001 1.001 0 0 1 1.38 0l10 9.543a1.002 1.002 0 0 1 .31.724V22a1 1 0 0 1-1 1Z"></path></svg>
              <span>Trang ch·ªß</span>
            </a>
          </li>
          <li>
            <a href="{% url 'accounts:user_list' %}">
              <svg class="nav-icon" aria-label="Search" fill="currentColor" viewBox="0 0 24 24"><path d="M19 10.5A8.5 8.5 0 1 1 10.5 2a8.5 8.5 0 0 1 8.5 8.5Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path><line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="16.511" x2="22" y1="16.511" y2="22"></line></svg>
              <span>T√¨m b·∫°n</span>
            </a>
          </li>
          <li>
            <a href="{% url 'accounts:friend_requests' %}">
              <svg class="nav-icon" aria-label="Friend Requests" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 14v6m-3-3h6"></path></svg>
              <span>L·ªùi m·ªùi</span>
            </a>
          </li>
          <li>
            <a href="{% url 'chat:conversation_list' %}">
              <svg class="nav-icon" aria-label="Messages" fill="currentColor" viewBox="0 0 24 24"><path d="M1.334 11.125a.85.85 0 0 0 0 1.75l6.51 1.823a1.5 1.5 0 0 0 1.138-.135l4.316-3.237a.5.5 0 0 1 .632.632l-4.316 3.237a1.5 1.5 0 0 0-.135 1.138l1.823 6.51a.85.85 0 0 0 1.62.25l4.334-21.666a.85.85 0 0 0-1.1-1.1L1.085 9.504a.85.85 0 0 0 .25 1.62Z"></path></svg>
              <span>Tin nh·∫Øn</span>
            </a>
          </li>
          <li>
             <a href="{% url 'notifications:notification_list' %}">
              <svg class="nav-icon" aria-label="Notifications" fill="currentColor" viewBox="0 0 24 24"><path d="M16.5 6.4a5.25 5.25 0 0 0-10.5 0 5.25 5.25 0 0 0 1.5 3.65A11.43 11.43 0 0 1 12 21.9a11.43 11.43 0 0 1 4.5-11.85A5.25 5.25 0 0 0 16.5 6.4Z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path></svg>
              <span>Th√¥ng b√°o</span>
            </a>
          </li>
           <li>
            <a href="{% url 'accounts:profile' username=user.username %}">
              <img src="{{ user.avatar.url }}" alt="{{ user.username }}" width="24" height="24" class="rounded-circle nav-icon"/>
              <span>Trang c√° nh√¢n</span>
            </a>
          </li>
        </ul>
      </nav>

      <!-- Ph·∫ßn ch√¢n sidebar: ƒêƒÉng xu·∫•t -->
      <div class="sidebar-footer">
        <nav class="sidebar-nav">
          <ul>
            <li>
              <a href="{% url 'accounts:logout' %}">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                <span>ƒêƒÉng xu·∫•t</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
    {% else %}
    <!-- === B·∫ÆT ƒê·∫¶U PH·∫¶N M·ªöI: SIDEBAR KHI CH∆ØA ƒêƒÇNG NH·∫¨P === -->
    <div class="sidebar">
        <a class="sidebar-brand" href="#">MySocial</a>
        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="{% url 'accounts:login' %}">
                        <!-- Icon Log In -->
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        <span>ƒêƒÉng nh·∫≠p</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'accounts:register' %}">
                        <!-- Icon Register/User Plus -->
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                        <span>ƒêƒÉng k√Ω</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
    <!-- K·∫æT TH√öC SIDEBAR -->


    <!-- V√ôNG N·ªòI DUNG CH√çNH -->
    <main class="main-content">
        {% block content %}{% endblock content %}
    </main>

    {% block extra_js %}{% endblock %}

    <!-- =================== CHAT WIDGET N·ªîI =================== -->
    {% if user.is_authenticated %}
    <div class="chat-widget-container">
      <div class="chat-popup" id="chatPopup">
        <div class="chat-popup-header">
          <h4 id="chat-popup-title">Tin nh·∫Øn</h4>
          <div class="header-buttons">
            <button type="button" class="chat-action-btn" id="newMessageBtn" title="Tin nh·∫Øn m·ªõi">‚úèÔ∏è</button>
            <button type="button" class="chat-action-btn" id="closeChatBtn" style="font-size: 1.5rem; line-height: 1">&times;</button>
          </div>
        </div>
        <div class="chat-popup-body">
          <div id="recent-conversations-view">
            <div id="chatPopupBodyContent" class="p-3 text-center text-muted">ƒêang t·∫£i...</div>
          </div>
          <div id="search-users-view" style="display: none">
            <div class="search-header">
              <button class="btn btn-light btn-sm" id="backToRecentBtn">&larr;</button>
              <input type="text" class="form-control" id="searchInput" placeholder="T√¨m ki·∫øm ng∆∞·ªùi d√πng..."/>
            </div>
            <div id="searchResultsList"></div>
          </div>
        </div>
      </div>
      <button class="chat-open-button" id="openChatBtn">üí¨</button>
    </div>
    {% endif %}
    <!-- =================== H·∫æT CHAT WIDGET =================== -->

    <!-- =================== SCRIPT CHUNG (ƒê√£ t·ªëi ∆∞u v√† g·ªôp) =================== -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // === H√ÄM TI·ªÜN √çCH: L·∫§Y COOKIE CSRF ===
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }
        const csrftoken = getCookie("csrftoken");

        // =======================================================
        // === LOGIC REACTION CHO B√ÄI VI·∫æT (POST)
        // =======================================================
        function updateReactionStatsUI(postId, stats, total) {
            const statsContainer = document.getElementById(`reaction-stats-${postId}`);
            if (!statsContainer) return;
            if (total > 0) {
                let iconsHTML = '<div class="me-2">';
                if (stats.LIKE) iconsHTML += "<span>üëç</span>";
                if (stats.LOVE) iconsHTML += "<span>‚ù§Ô∏è</span>";
                if (stats.HAHA) iconsHTML += "<span>üòÇ</span>";
                if (stats.WOW) iconsHTML += "<span>üòÆ</span>";
                if (stats.SAD) iconsHTML += "<span>üò¢</span>";
                if (stats.ANGRY) iconsHTML += "<span>üò°</span>";
                iconsHTML += "</div>";
                statsContainer.innerHTML = iconsHTML + `<span id="reactions-count-${postId}">${total}</span>`;
            } else {
                statsContainer.innerHTML = `<span id="reactions-count-${postId}" class="text-muted">Ch∆∞a c√≥ c·∫£m x√∫c</span>`;
            }
        }

        
        // D√πng event delegation cho c√°c n√∫t reaction c·ªßa b√†i vi·∫øt
        document.body.addEventListener('click', function(event) {
            const reactionButton = event.target.closest(".reaction-btn[data-post-id]");
            if (reactionButton) {
                event.preventDefault();
                const postId = reactionButton.dataset.postId;
                const reactionType = reactionButton.dataset.reactionType;

                fetch(`/post/${postId}/react/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken,
                        "X-Requested-With": "XMLHttpRequest",
                    },
                    credentials: "same-origin",
                    body: JSON.stringify({ reaction_type: reactionType }),
                })
                .then((res) => res.json())
                // THAY B·∫∞NG ƒêO·∫†N N√ÄY
                .then((data) => {
                    if (data.status === "ok") {
                        updateReactionStatsUI(postId, data.reaction_stats, data.total_reactions);

                        // === B·∫ÆT ƒê·∫¶U N√ÇNG C·∫§P: C·∫¨P NH·∫¨T N·ªòI DUNG N√öT "TH√çCH" CH√çNH ===
                        const mainPostReactionButton = document.querySelector(`.reaction-btn[data-post-id='${postId}'][data-reaction-type='LIKE'].w-100`);

                        if (mainPostReactionButton) {
                            if (data.current_user_reaction) {
                                mainPostReactionButton.classList.add('text-primary', 'fw-bold');
                                let reactionText = 'üëç Th√≠ch'; // M·∫∑c ƒë·ªãnh
                                if (data.current_user_reaction === 'LIKE') reactionText = 'üëç Th√≠ch';
                                else if (data.current_user_reaction === 'LOVE') reactionText = '‚ù§Ô∏è Y√™u th√≠ch';
                                else if (data.current_user_reaction === 'HAHA') reactionText = 'üòÇ Haha';
                                else if (data.current_user_reaction === 'WOW') reactionText = 'üòÆ Wow';
                                else if (data.current_user_reaction === 'SAD') reactionText = 'üò¢ Bu·ªìn';
                                else if (data.current_user_reaction === 'ANGRY') reactionText = 'üò° Ph·∫´n n·ªô';
                                mainPostReactionButton.innerHTML = reactionText;
                            } else {
                                mainPostReactionButton.classList.remove('text-primary', 'fw-bold');
                                mainPostReactionButton.innerHTML = 'üëç Th√≠ch';
                            }
                        }
                        // === K·∫æT TH√öC N√ÇNG C·∫§P ===

                    } else {
                        alert(data.message || "C√≥ l·ªói x·∫£y ra.");
                    }
                })
                .catch((err) => console.error("Error:", err));
            }
        });

        document.querySelectorAll(".reaction-count").forEach(function (elem) {
          elem.addEventListener("click", function () {
            let postId = this.dataset.postId;
            fetch(`/post/${postId}/reactions/detail/`)
              .then((response) => response.json())
              .then((data) => {
                let html = "";
                for (let type in data) {
                  html += `<strong>${type}</strong>: ${data[type].join(", ")}<br>`;
                }
                const detailBox = document.getElementById("reactionDetailBox");
                const modal = document.getElementById("reactionModal");
                if (detailBox && modal) {
                    detailBox.innerHTML = html;
                    new bootstrap.Modal(modal).show();
                }
              });
          });
        });

        // =======================================================
        // === LOGIC CRUD & REPLY CHO B√åNH LU·∫¨N (COMMENT)
        // =======================================================
        document.body.addEventListener('submit', function(event) {
            // --- TH√äM B√åNH LU·∫¨N & TR·∫¢ L·ªúI B√åNH LU·∫¨N ---
            if (event.target.classList.contains('comment-form')) {
                event.preventDefault();
                const form = event.target;
                const url = form.action;
                const formData = new FormData(form);
                const contentInput = form.querySelector('input[name=content]');

                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        if (data.is_reply) {
                            // N·∫øu l√† reply, ch√®n v√†o container c·ªßa parent
                            const repliesContainer = document.getElementById(`replies-for-${data.parent_id}`);
                            repliesContainer.insertAdjacentHTML('beforeend', data.comment_html);
                            // ·∫®n form reply ƒëi sau khi g·ª≠i
                            form.closest('.reply-form-container').style.display = 'none';
                        } else {
                            // N·∫øu l√† comment g·ªëc, ch√®n v√†o danh s√°ch ch√≠nh
                            const commentList = form.closest('.comments-section').querySelector('.comment-list');
                            commentList.insertAdjacentHTML('beforeend', data.comment_html);
                        }
                        // X√≥a tr·∫Øng √¥ input
                        contentInput.value = '';
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            }

            // --- L∆ØU CH·ªàNH S·ª¨A B√åNH LU·∫¨N ---
            if (event.target.classList.contains('edit-comment-form')) {
                event.preventDefault();
                const form = event.target;
                const url = form.action;
                const formData = new FormData(form);
                const commentDiv = form.closest('[id^="comment-"]');

                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        commentDiv.outerHTML = data.comment_html;
                    } else {
                        alert(data.message);
                    }
                });
            }
        });

        document.body.addEventListener('click', function(event) {
            // --- X√ìA B√åNH LU·∫¨N (ƒê√É S·ª¨A L·ªñI) ---
            if (event.target.classList.contains('delete-comment-btn')) {
                event.preventDefault();
                if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y kh√¥ng?')) return;

                const commentId = event.target.dataset.commentId;
                // T·ª± t·∫°o URL ƒë√∫ng b·∫±ng c√°ch d√πng namespace
                const url = `/comment/${commentId}/delete/`; 

                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        const commentDiv = event.target.closest('[id^="comment-"]');
                        if (commentDiv) commentDiv.remove();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
            
            // --- M·ªû/ƒê√ìNG FORM TR·∫¢ L·ªúI ---
            if (event.target.classList.contains('reply-btn')) {
                event.preventDefault();
                const commentId = event.target.dataset.commentId;
                const replyFormContainer = document.getElementById(`reply-form-for-${commentId}`);
                
                if (replyFormContainer) {
                    const isHidden = replyFormContainer.style.display === 'none' || !replyFormContainer.style.display;
                    replyFormContainer.style.display = isHidden ? 'block' : 'none';
                    if (isHidden) {
                        replyFormContainer.querySelector('input[name="content"]').focus();
                    }
                }
            }

            // --- B·∫ÆT ƒê·∫¶U CH·ªàNH S·ª¨A B√åNH LU·∫¨N (L·∫•y form - ƒê√É S·ª¨A L·ªñI) ---
            if (event.target.classList.contains('edit-comment-btn')) {
                event.preventDefault();
                const commentId = event.target.dataset.commentId;
                // T·ª± t·∫°o URL ƒë√∫ng b·∫±ng c√°ch d√πng namespace
                const url = `/comment/${commentId}/get-edit-form/`;
                const commentContentWrapper = document.getElementById(`comment-${commentId}`).querySelector('.comment-content-wrapper');

                fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        commentContentWrapper.dataset.originalContent = commentContentWrapper.innerHTML;
                        commentContentWrapper.innerHTML = data.form_html;
                    } else {
                        alert(data.message);
                    }
                });
            }

            // --- H·ª¶Y CH·ªàNH S·ª¨A B√åNH LU·∫¨N ---
            if (event.target.classList.contains('cancel-edit-btn')) {
                const commentContentWrapper = event.target.closest('.comment-content-wrapper');
                if (commentContentWrapper.dataset.originalContent) {
                    commentContentWrapper.innerHTML = commentContentWrapper.dataset.originalContent;
                }
            }
        });
        
        // =======================================================
        // === LOGIC REACTION CHO B√åNH LU·∫¨N (COMMENT)
        // =======================================================
        function handleCommentReaction(event) {
            event.preventDefault();
            const button = event.target.closest('.comment-reaction-btn, .comment-reaction-choice-btn');
            if (!button) return;

            const commentId = button.dataset.commentId;
            const reactionType = button.dataset.reactionType;
            const url = `/comment/${commentId}/react/`;

            if (!commentId) return;

            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' },
                body: JSON.stringify({ reaction_type: reactionType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    const statsContainer = document.getElementById(`comment-reaction-stats-${commentId}`);
                    if (statsContainer) {
                        if (data.total_reactions > 0) {
                            let iconsHTML = '';
                            if (data.reaction_stats.LIKE) iconsHTML += '<span>üëç</span>';
                            if (data.reaction_stats.LOVE) iconsHTML += '<span>‚ù§Ô∏è</span>';
                            if (data.reaction_stats.HAHA) iconsHTML += '<span>üòÇ</span>';
                            if (data.reaction_stats.WOW) iconsHTML += '<span>üòÆ</span>';
                            if (data.reaction_stats.SAD) iconsHTML += '<span>üò¢</span>';
                            if (data.reaction_stats.ANGRY) iconsHTML += '<span>üò°</span>';
                            statsContainer.innerHTML = `<span class="ms-1">${iconsHTML} ${data.total_reactions}</span>`;
                        } else {
                            statsContainer.innerHTML = '';
                        }
                    }

                    const mainReactionButton = document.querySelector(`.comment-reaction-btn[data-comment-id='${commentId}']`);
                    if (mainReactionButton) {
                        if (data.current_user_reaction) {
                            mainReactionButton.classList.add('text-primary', 'fw-bold');
                            mainReactionButton.classList.remove('text-muted');
                            let reactionText = 'Th√≠ch';
                            if (data.current_user_reaction === 'LIKE') reactionText = 'üëç Th√≠ch';
                            else if (data.current_user_reaction === 'LOVE') reactionText = '‚ù§Ô∏è Y√™u th√≠ch';
                            else if (data.current_user_reaction === 'HAHA') reactionText = 'üòÇ Haha';
                            else if (data.current_user_reaction === 'WOW') reactionText = 'üòÆ Wow';
                            else if (data.current_user_reaction === 'SAD') reactionText = 'üò¢ Bu·ªìn';
                            else if (data.current_user_reaction === 'ANGRY') reactionText = 'üò° Ph·∫´n n·ªô';
                            mainReactionButton.innerHTML = reactionText;
                        } else {
                            mainReactionButton.classList.remove('text-primary', 'fw-bold');
                            mainReactionButton.classList.add('text-muted');
                            mainReactionButton.innerHTML = 'Th√≠ch';
                        }
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Comment Reaction Error:', error));
        }
        document.body.addEventListener('click', function(event) {
            if (event.target.closest('.comment-reaction-btn, .comment-reaction-choice-btn')) {
                handleCommentReaction(event);
            }
        });

        // =======================================================
        // === LOGIC TH√îNG B√ÅO (NOTIFICATION) - ƒê√É C·∫¨P NH·∫¨T
        // =======================================================
        {% if user.is_authenticated %}
        function loadNotifications() {
          fetch("/notifications/api/")
            .then((resp) => resp.json())
            .then((data) => {
              const list = document.getElementById("notif-list");
              const countBadge = document.getElementById("notif-count");
              
              // X√≥a c√°c th√¥ng b√°o c≈© m·ªôt c√°ch an to√†n
              const dividerLi = list.querySelector('.dropdown-divider').parentElement;
              let current = list.firstChild;
              while (current && current !== dividerLi) {
                  let next = current.nextSibling;
                  list.removeChild(current);
                  current = next;
              }

              if (!data.notifications || data.notifications.length === 0) {
                const noNotifItem = '<li><span class="dropdown-item text-muted">Kh√¥ng c√≥ th√¥ng b√°o n√†o</span></li>';
                dividerLi.insertAdjacentHTML('beforebegin', noNotifItem);
                
                countBadge.innerText = 0;
                countBadge.style.display = 'none';
              } else {
                countBadge.innerText = data.total_unread;
                countBadge.style.display = data.total_unread > 0 ? 'block' : 'none';

                data.notifications.forEach((n) => {
                  // Ph√¢n bi·ªát class cho th√¥ng b√°o ƒë√£ ƒë·ªçc (n·ªÅn x√°m) v√† ch∆∞a ƒë·ªçc (ch·∫•m xanh)
                  const statusClass = n.is_read ? 'notification-read' : 'notification-unread';
                  
                  const notifHtml = `
                    <li>
                      <a class="dropdown-item text-wrap ${statusClass}" style="white-space: normal;" href="${n.link}">
                        <strong>${n.sender}</strong> ${n.type}<br>
                        <small class="text-muted">${n.timestamp}</small>
                      </a>
                    </li>`;
                  dividerLi.insertAdjacentHTML('beforebegin', notifHtml);
                });
              }
            })
            .catch((err) => console.error("Load notifications error", err));
        }
        
        loadNotifications();
        setInterval(loadNotifications, 10000);
        {% endif %}
        
        // =======================================================
        // === LOGIC WIDGET TR√í CHUY·ªÜN (CHAT)
        // =======================================================
        {% if user.is_authenticated %}
        const openChatBtn = document.getElementById("openChatBtn");
        const closeChatBtn = document.getElementById("closeChatBtn");
        const chatPopup = document.getElementById("chatPopup");
        const chatPopupBodyContent = document.getElementById("chatPopupBodyContent");
        const chatPopupTitle = document.getElementById("chat-popup-title");
        const newMessageBtn = document.getElementById("newMessageBtn");
        const backToRecentBtn = document.getElementById("backToRecentBtn");
        const recentConversationsView = document.getElementById("recent-conversations-view");
        const searchUsersView = document.getElementById("search-users-view");
        const searchInput = document.getElementById("searchInput");
        const searchResultsList = document.getElementById("searchResultsList");

        let conversationsLoaded = false;

        openChatBtn.addEventListener("click", function () {
          chatPopup.style.display = "flex";
          if (!conversationsLoaded) {
            loadConversations();
          }
        });
        closeChatBtn.addEventListener("click", () => { chatPopup.style.display = "none"; });

        newMessageBtn.addEventListener("click", () => {
          recentConversationsView.style.display = "none";
          searchUsersView.style.display = "block";
          chatPopupTitle.innerText = "Tin nh·∫Øn m·ªõi";
          searchInput.focus();
        });
        backToRecentBtn.addEventListener("click", () => {
          searchUsersView.style.display = "none";
          recentConversationsView.style.display = "block";
          chatPopupTitle.innerText = "Tin nh·∫Øn";
          searchInput.value = "";
          searchResultsList.innerHTML = "";
        });

        function loadConversations() {
          fetch("{% url 'chat:api_get_conversations' %}")
            .then((response) => response.json())
            .then((data) => {
              chatPopupBodyContent.innerHTML = "";
              chatPopupBodyContent.className = "";
              if (data.conversations && data.conversations.length > 0) {
                data.conversations.forEach((conv) => {
                  chatPopupBodyContent.innerHTML += `
                    <a href="${conv.detail_url}" class="conversation-item">
                      <div class="flex-shrink-0 me-3">üë§</div>
                      <div class="w-100" style="overflow: hidden;">
                        <strong>${conv.other_participant.username}</strong>
                        <p class="last-message mb-0">${conv.last_message || "B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán"}</p>
                      </div>
                    </a>`;
                });
              } else {
                chatPopupBodyContent.innerHTML = '<p class="text-center text-muted p-3">Kh√¥ng c√≥ cu·ªôc tr√≤ chuy·ªán n√†o.</p>';
              }
              conversationsLoaded = true;
            })
            .catch((error) => {
              console.error("L·ªói khi t·∫£i tin nh·∫Øn:", error);
              chatPopupBodyContent.innerHTML = '<p class="text-center text-danger p-3">Kh√¥ng th·ªÉ t·∫£i tin nh·∫Øn.</p>';
            });
        }

        let searchTimeout;
        searchInput.addEventListener("keyup", function () {
          clearTimeout(searchTimeout);
          const query = searchInput.value.trim();

          if (query.length < 2) {
            searchResultsList.innerHTML = '<p class="text-center text-muted p-3">Nh·∫≠p √≠t nh·∫•t 2 k√Ω t·ª±.</p>';
            return;
          }
          searchResultsList.innerHTML = '<p class="text-center text-muted p-3">ƒêang t√¨m...</p>';

          searchTimeout = setTimeout(() => {
            fetch(`{% url 'chat:api_search_users' %}?q=${encodeURIComponent(query)}`)
              .then((response) => response.json())
              .then((data) => {
                searchResultsList.innerHTML = "";
                if (data.users && data.users.length > 0) {
                  data.users.forEach((user) => {
                    searchResultsList.innerHTML += `
                      <a href="${user.start_conversation_url}" class="conversation-item">
                        <div class="flex-shrink-0 me-3">üë§</div>
                        <div class="w-100"><strong>${user.full_name}</strong></div>
                      </a>`;
                  });
                } else {
                  searchResultsList.innerHTML = '<p class="text-center text-muted p-3">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng.</p>';
                }
              });
          }, 300);
        });
        {% endif %}
        
        // =======================================================
        // === LOGIC T·∫¢I TH√äM B√åNH LU·∫¨N
        // =======================================================
        document.body.addEventListener('click', function(event) {
            if (event.target.classList.contains('load-more-comments')) {
                event.preventDefault();
                
                const button = event.target;
                const spinner = button.nextElementSibling; // L·∫•y c√°i spinner b√™n c·∫°nh
                const postId = button.dataset.postId;
                const offset = button.dataset.offset;

                // Hi·ªÉn th·ªã loading v√† v√¥ hi·ªáu h√≥a n√∫t
                button.classList.add('d-none');
                spinner.classList.remove('d-none');

                fetch(`/post/${postId}/load-comments/?offset=${offset}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.html) {
                            const commentList = button.closest('.comments-section').querySelector('.comment-list');
                            commentList.insertAdjacentHTML('beforeend', data.html);
                        }

                        // C·∫≠p nh·∫≠t ho·∫∑c x√≥a n√∫t
                        if (data.has_more) {
                            button.dataset.offset = data.new_offset;
                            button.classList.remove('d-none');
                        } else {
                            button.parentElement.remove(); // X√≥a c·∫£ div b·ªçc ngo√†i n√∫t
                        }
                    })
                    .catch(error => console.error('Error loading comments:', error))
                    .finally(() => {
                        // Lu√¥n ·∫©n spinner sau khi xong
                        spinner.classList.add('d-none');
                    });
            }
        });
        // =======================================================
        // === LOGIC FOCUS V√ÄO √î B√åNH LU·∫¨N KHI CLICK N√öT COMMENT
        // =======================================================
        document.body.addEventListener('click', function(event) {
            // Ki·ªÉm tra xem ph·∫ßn t·ª≠ ƒë∆∞·ª£c click c√≥ ph·∫£i l√† n√∫t "B√¨nh lu·∫≠n" kh√¥ng
            const commentButton = event.target.closest('.comment-button');
            
            if (commentButton) {
                // NgƒÉn h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª <a> (l√† nh·∫£y l√™n ƒë·∫ßu trang)
                event.preventDefault();
                
                // L·∫•y ID c·ªßa b√†i vi·∫øt t·ª´ thu·ªôc t√≠nh data-post-id
                const postId = commentButton.dataset.postId;
                
                // T√¨m √¥ input t∆∞∆°ng ·ª©ng b·∫±ng ID m√† ch√∫ng ta ƒë√£ ƒë·∫∑t
                const commentInput = document.getElementById(`comment-input-${postId}`);
                
                // N·∫øu t√¨m th·∫•y, di chuy·ªÉn con tr·ªè chu·ªôt v√†o ƒë√≥
                if (commentInput) {
                    commentInput.focus();
                }
            }
        });
      });
    </script>

  </body>
</html>