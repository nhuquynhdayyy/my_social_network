<!-- posts/templates/posts/base.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MySocial</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- === CSS T·ªîNG H·ª¢P CHO TO√ÄN B·ªò TRANG === -->
    <style>
      /* Th√¥ng b√°o CH∆ØA ƒê·ªåC s·∫Ω c√≥ ch·∫•m xanh ·ªü ƒë·∫ßu */
      .notification-unread {
        position: relative;
        padding-left: 28px !important; /* T·∫°o kh√¥ng gian cho ch·∫•m xanh */
      }
      .notification-unread::before {
        content: '';
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        background-color: #0d6efd; /* M√†u xanh d∆∞∆°ng c·ªßa Bootstrap */
        border-radius: 50%;
      }

      /* Th√¥ng b√°o ƒê√É ƒê·ªåC c√≥ n·ªÅn x√°m */
      .notification-read {
        background-color: #f8f9fa; /* M√†u n·ªÅn x√°m nh·∫°t */
      }
      .notification-read:hover {
        background-color: #e9ecef;
      }

      /* CSS cho Chat Widget */
      .chat-widget-container {
        position: fixed;
        bottom: 25px;
        right: 25px;
        z-index: 1050;
      }
      .chat-open-button {
        background-color: #0d6efd;
        color: white;
        padding: 16px;
        border: none;
        cursor: pointer;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .chat-popup {
        display: none;
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 320px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        background-color: white;
        flex-direction: column;
      }
      .chat-popup-header {
        background-color: #0d6efd;
        color: white;
        padding: 10px 15px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .chat-popup-header h4 {
        margin: 0;
        font-size: 1.1rem;
      }
      .chat-popup-header .header-buttons {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .chat-popup-body {
        padding: 0;
        max-height: 400px;
        overflow-y: auto;
      }
      .chat-popup-body .conversation-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
        text-decoration: none;
        color: #212529;
        transition: background-color 0.2s;
      }
      .chat-popup-body .conversation-item:last-child {
        border-bottom: none;
      }
      .chat-popup-body .conversation-item:hover {
        background-color: #f1f1f1;
      }
      .chat-popup-body .conversation-item .last-message {
        font-size: 0.85rem;
        color: #6c757d;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .chat-action-btn {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 0;
        font-size: 1.2rem;
      }
      #search-users-view .search-header {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      #search-users-view input {
        border-radius: 20px;
      }
      
      /* CSS cho Reaction tr√™n B√¨nh lu·∫≠n */
      .comment-reaction-container {
        position: relative;
        padding-top: 1rem;
        margin-top: -1rem;
      }
      .comment-reaction-popup {
          display: none;
          position: absolute;
          bottom: 1.8rem;
          left: -10px;
          background-color: white;
          border-radius: 20px;
          padding: 5px 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          white-space: nowrap;
          z-index: 10;
          gap: 5px;
      }
      .comment-reaction-container:hover .comment-reaction-popup {
          display: flex;
      }
      .comment-reaction-popup .btn {
          font-size: 1.5rem;
          padding: 0;
          border: none;
          background: none;
          transition: transform 0.1s;
      }
      .comment-reaction-popup .btn:hover {
          transform: scale(1.2);
      }

      /* === CSS: CHO REACTION TR√äN B√ÄI VI·∫æT (POST) - ƒê√É S·ª¨A L·∫†I CHO M∆Ø·ª¢T === */
      .post-reaction-container {
        position: relative;
        /* T·∫†O V√ôNG ƒê·ªÜM V√î H√åNH ·ªû TR√äN ƒê·ªÇ B·∫ÆT S·ª∞ KI·ªÜN R√ä CHU·ªòT */
        padding-top: 1rem;
        /* K√âO CONTAINER V·ªÄ V·ªä TR√ç C≈®, TR√ÅNH X√î L·ªÜCH GIAO DI·ªÜN */
        margin-top: -1rem;
      }
      .post-reaction-popup {
          display: none;
          position: absolute;
          /* THAY ƒê·ªîI V·ªä TR√ç: Gi·ªëng h·ªát c·ªßa b√¨nh lu·∫≠n */
          bottom: 2.2rem; /* ƒêi·ªÅu ch·ªânh ƒë·ªÉ n·∫±m ngay tr√™n n√∫t "Th√≠ch" */
          left: 0;
          background-color: white;
          border-radius: 20px;
          padding: 5px 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          white-space: nowrap;
          z-index: 10;
          gap: 5px;
      }
      /* Khi di chu·ªôt v√†o container, hi·ªÉn th·ªã popup */
      .post-reaction-container:hover .post-reaction-popup {
          display: flex; 
      }
      .post-reaction-popup .btn {
          font-size: 1.8rem;
          padding: 0;
          border: none;
          background: none;
          transition: transform 0.1s;
      }
      .post-reaction-popup .btn:hover {
          transform: scale(1.2);
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold text-primary" href="{% url 'posts:home' %}">MySocial</a>
        <div class="d-flex align-items-center">
          {% if user.is_authenticated %}
          <a href="{% url 'accounts:friend_requests' %}" class="btn btn-outline-secondary position-relative me-3">L·ªùi m·ªùi</a>
          <a href="{% url 'chat:conversation_list' %}" class="btn btn-outline-info me-3">Tin nh·∫Øn</a>

          <div class="dropdown me-3">
            <button class="btn btn-outline-warning position-relative" id="notifDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              Th√¥ng b√°o
              <span id="notif-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notifDropdown" id="notif-list" style="min-width: 350px; max-height: 400px; overflow-y: auto;">
              <li><span class="dropdown-item text-muted">ƒêang t·∫£i...</span></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-center text-primary" href="{% url 'notifications:notification_list' %}">Xem t·∫•t c·∫£ th√¥ng b√°o</a></li>
            </ul>
          </div>

          <a href="{% url 'accounts:user_list' %}" class="btn btn-outline-primary me-3">T√¨m b·∫°n</a>

          <div class="dropdown ms-2">
              <a href="#" class="d-block link-dark text-decoration-none dropdown-toggle" id="dropdownUser" data-bs-toggle="dropdown" aria-expanded="false">
                <img src="{{ user.avatar.url }}" alt="{{ user.username }}" width="32" height="32" class="rounded-circle"/>
              </a>
              <ul class="dropdown-menu dropdown-menu-end text-small" aria-labelledby="dropdownUser">
                <li><span class="dropdown-item-text">Ch√†o, <strong>{{ user.username }}</strong></span></li>
                <li><hr class="dropdown-divider" /></li>
                <li><a class="dropdown-item" href="{% url 'accounts:profile' username=user.username %}">Trang c√° nh√¢n</a></li>
                <li><a class="dropdown-item" href="{% url 'accounts:profile_edit' username=user.username %}">Ch·ªânh s·ª≠a h·ªì s∆°</a></li>
                <li><hr class="dropdown-divider" /></li>
                <li><a class="dropdown-item text-danger" href="{% url 'accounts:logout' %}">ƒêƒÉng xu·∫•t</a></li>
              </ul>
            </div>

          {% else %}
          <a href="{% url 'accounts:login' %}" class="btn btn-outline-success me-2">ƒêƒÉng nh·∫≠p</a>
          <a href="{% url 'accounts:register' %}" class="btn btn-primary">ƒêƒÉng k√Ω</a>
          {% endif %}
        </div>
      </div>
    </nav>

    <main class="container mt-4">
      {% block content %}{% endblock content %}
    </main>

    {% block extra_js %}{% endblock %}

    <!-- =================== CHAT WIDGET N·ªîI =================== -->
    {% if user.is_authenticated %}
    <div class="chat-widget-container">
      <div class="chat-popup" id="chatPopup">
        <div class="chat-popup-header">
          <h4 id="chat-popup-title">Tin nh·∫Øn</h4>
          <div class="header-buttons">
            <button type="button" class="chat-action-btn" id="newMessageBtn" title="Tin nh·∫Øn m·ªõi">‚úèÔ∏è</button>
            <button type="button" class="chat-action-btn" id="closeChatBtn" style="font-size: 1.5rem; line-height: 1">&times;</button>
          </div>
        </div>
        <div class="chat-popup-body">
          <div id="recent-conversations-view">
            <div id="chatPopupBodyContent" class="p-3 text-center text-muted">ƒêang t·∫£i...</div>
          </div>
          <div id="search-users-view" style="display: none">
            <div class="search-header">
              <button class="btn btn-light btn-sm" id="backToRecentBtn">&larr;</button>
              <input type="text" class="form-control" id="searchInput" placeholder="T√¨m ki·∫øm ng∆∞·ªùi d√πng..."/>
            </div>
            <div id="searchResultsList"></div>
          </div>
        </div>
      </div>
      <button class="chat-open-button" id="openChatBtn">üí¨</button>
    </div>
    {% endif %}
    <!-- =================== H·∫æT CHAT WIDGET =================== -->

    <!-- =================== SCRIPT CHUNG (ƒê√£ t·ªëi ∆∞u v√† g·ªôp) =================== -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // === H√ÄM TI·ªÜN √çCH: L·∫§Y COOKIE CSRF ===
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }
        const csrftoken = getCookie("csrftoken");

        // =======================================================
        // === LOGIC REACTION CHO B√ÄI VI·∫æT (POST)
        // =======================================================
        function updateReactionStatsUI(postId, stats, total) {
            const statsContainer = document.getElementById(`reaction-stats-${postId}`);
            if (!statsContainer) return;
            if (total > 0) {
                let iconsHTML = '<div class="me-2">';
                if (stats.LIKE) iconsHTML += "<span>üëç</span>";
                if (stats.LOVE) iconsHTML += "<span>‚ù§Ô∏è</span>";
                if (stats.HAHA) iconsHTML += "<span>üòÇ</span>";
                if (stats.WOW) iconsHTML += "<span>üòÆ</span>";
                if (stats.SAD) iconsHTML += "<span>üò¢</span>";
                if (stats.ANGRY) iconsHTML += "<span>üò°</span>";
                iconsHTML += "</div>";
                statsContainer.innerHTML = iconsHTML + `<span id="reactions-count-${postId}">${total}</span>`;
            } else {
                statsContainer.innerHTML = `<span id="reactions-count-${postId}" class="text-muted">Ch∆∞a c√≥ c·∫£m x√∫c</span>`;
            }
        }

        
        // D√πng event delegation cho c√°c n√∫t reaction c·ªßa b√†i vi·∫øt
        document.body.addEventListener('click', function(event) {
            const reactionButton = event.target.closest(".reaction-btn[data-post-id]");
            if (reactionButton) {
                event.preventDefault();
                const postId = reactionButton.dataset.postId;
                const reactionType = reactionButton.dataset.reactionType;

                fetch(`/post/${postId}/react/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken,
                        "X-Requested-With": "XMLHttpRequest",
                    },
                    credentials: "same-origin",
                    body: JSON.stringify({ reaction_type: reactionType }),
                })
                .then((res) => res.json())
                // THAY B·∫∞NG ƒêO·∫†N N√ÄY
                .then((data) => {
                    if (data.status === "ok") {
                        updateReactionStatsUI(postId, data.reaction_stats, data.total_reactions);

                        // === B·∫ÆT ƒê·∫¶U N√ÇNG C·∫§P: C·∫¨P NH·∫¨T N·ªòI DUNG N√öT "TH√çCH" CH√çNH ===
                        const mainPostReactionButton = document.querySelector(`.reaction-btn[data-post-id='${postId}'][data-reaction-type='LIKE'].w-100`);

                        if (mainPostReactionButton) {
                            if (data.current_user_reaction) {
                                mainPostReactionButton.classList.add('text-primary', 'fw-bold');
                                let reactionText = 'üëç Th√≠ch'; // M·∫∑c ƒë·ªãnh
                                if (data.current_user_reaction === 'LIKE') reactionText = 'üëç Th√≠ch';
                                else if (data.current_user_reaction === 'LOVE') reactionText = '‚ù§Ô∏è Y√™u th√≠ch';
                                else if (data.current_user_reaction === 'HAHA') reactionText = 'üòÇ Haha';
                                else if (data.current_user_reaction === 'WOW') reactionText = 'üòÆ Wow';
                                else if (data.current_user_reaction === 'SAD') reactionText = 'üò¢ Bu·ªìn';
                                else if (data.current_user_reaction === 'ANGRY') reactionText = 'üò° Ph·∫´n n·ªô';
                                mainPostReactionButton.innerHTML = reactionText;
                            } else {
                                mainPostReactionButton.classList.remove('text-primary', 'fw-bold');
                                mainPostReactionButton.innerHTML = 'üëç Th√≠ch';
                            }
                        }
                        // === K·∫æT TH√öC N√ÇNG C·∫§P ===

                    } else {
                        alert(data.message || "C√≥ l·ªói x·∫£y ra.");
                    }
                })
                .catch((err) => console.error("Error:", err));
            }
        });

        document.querySelectorAll(".reaction-count").forEach(function (elem) {
          elem.addEventListener("click", function () {
            let postId = this.dataset.postId;
            fetch(`/post/${postId}/reactions/detail/`)
              .then((response) => response.json())
              .then((data) => {
                let html = "";
                for (let type in data) {
                  html += `<strong>${type}</strong>: ${data[type].join(", ")}<br>`;
                }
                const detailBox = document.getElementById("reactionDetailBox");
                const modal = document.getElementById("reactionModal");
                if (detailBox && modal) {
                    detailBox.innerHTML = html;
                    new bootstrap.Modal(modal).show();
                }
              });
          });
        });

        // =======================================================
        // === LOGIC CRUD & REPLY CHO B√åNH LU·∫¨N (COMMENT)
        // =======================================================
        document.body.addEventListener('submit', function(event) {
            // --- TH√äM B√åNH LU·∫¨N & TR·∫¢ L·ªúI B√åNH LU·∫¨N ---
            if (event.target.classList.contains('comment-form')) {
                event.preventDefault();
                const form = event.target;
                const url = form.action;
                const formData = new FormData(form);
                const contentInput = form.querySelector('input[name=content]');

                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        if (data.is_reply) {
                            // N·∫øu l√† reply, ch√®n v√†o container c·ªßa parent
                            const repliesContainer = document.getElementById(`replies-for-${data.parent_id}`);
                            repliesContainer.insertAdjacentHTML('beforeend', data.comment_html);
                            // ·∫®n form reply ƒëi sau khi g·ª≠i
                            form.closest('.reply-form-container').style.display = 'none';
                        } else {
                            // N·∫øu l√† comment g·ªëc, ch√®n v√†o danh s√°ch ch√≠nh
                            const commentList = form.closest('.comments-section').querySelector('.comment-list');
                            commentList.insertAdjacentHTML('beforeend', data.comment_html);
                        }
                        // X√≥a tr·∫Øng √¥ input
                        contentInput.value = '';
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            }

            // --- L∆ØU CH·ªàNH S·ª¨A B√åNH LU·∫¨N ---
            if (event.target.classList.contains('edit-comment-form')) {
                event.preventDefault();
                const form = event.target;
                const url = form.action;
                const formData = new FormData(form);
                const commentDiv = form.closest('[id^="comment-"]');

                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        commentDiv.outerHTML = data.comment_html;
                    } else {
                        alert(data.message);
                    }
                });
            }
        });

        document.body.addEventListener('click', function(event) {
            // --- X√ìA B√åNH LU·∫¨N (ƒê√É S·ª¨A L·ªñI) ---
            if (event.target.classList.contains('delete-comment-btn')) {
                event.preventDefault();
                if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y kh√¥ng?')) return;

                const commentId = event.target.dataset.commentId;
                // T·ª± t·∫°o URL ƒë√∫ng b·∫±ng c√°ch d√πng namespace
                const url = `/comment/${commentId}/delete/`; 

                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        const commentDiv = event.target.closest('[id^="comment-"]');
                        if (commentDiv) commentDiv.remove();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
            
            // --- M·ªû/ƒê√ìNG FORM TR·∫¢ L·ªúI ---
            if (event.target.classList.contains('reply-btn')) {
                event.preventDefault();
                const commentId = event.target.dataset.commentId;
                const replyFormContainer = document.getElementById(`reply-form-for-${commentId}`);
                
                if (replyFormContainer) {
                    const isHidden = replyFormContainer.style.display === 'none' || !replyFormContainer.style.display;
                    replyFormContainer.style.display = isHidden ? 'block' : 'none';
                    if (isHidden) {
                        replyFormContainer.querySelector('input[name="content"]').focus();
                    }
                }
            }

            // --- B·∫ÆT ƒê·∫¶U CH·ªàNH S·ª¨A B√åNH LU·∫¨N (L·∫•y form - ƒê√É S·ª¨A L·ªñI) ---
            if (event.target.classList.contains('edit-comment-btn')) {
                event.preventDefault();
                const commentId = event.target.dataset.commentId;
                // T·ª± t·∫°o URL ƒë√∫ng b·∫±ng c√°ch d√πng namespace
                const url = `/comment/${commentId}/get-edit-form/`;
                const commentContentWrapper = document.getElementById(`comment-${commentId}`).querySelector('.comment-content-wrapper');

                fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        commentContentWrapper.dataset.originalContent = commentContentWrapper.innerHTML;
                        commentContentWrapper.innerHTML = data.form_html;
                    } else {
                        alert(data.message);
                    }
                });
            }

            // --- H·ª¶Y CH·ªàNH S·ª¨A B√åNH LU·∫¨N ---
            if (event.target.classList.contains('cancel-edit-btn')) {
                const commentContentWrapper = event.target.closest('.comment-content-wrapper');
                if (commentContentWrapper.dataset.originalContent) {
                    commentContentWrapper.innerHTML = commentContentWrapper.dataset.originalContent;
                }
            }
        });
        
        // =======================================================
        // === LOGIC REACTION CHO B√åNH LU·∫¨N (COMMENT)
        // =======================================================
        function handleCommentReaction(event) {
            event.preventDefault();
            const button = event.target.closest('.comment-reaction-btn, .comment-reaction-choice-btn');
            if (!button) return;

            const commentId = button.dataset.commentId;
            const reactionType = button.dataset.reactionType;
            const url = `/comment/${commentId}/react/`;

            if (!commentId) return;

            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' },
                body: JSON.stringify({ reaction_type: reactionType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    const statsContainer = document.getElementById(`comment-reaction-stats-${commentId}`);
                    if (statsContainer) {
                        if (data.total_reactions > 0) {
                            let iconsHTML = '';
                            if (data.reaction_stats.LIKE) iconsHTML += '<span>üëç</span>';
                            if (data.reaction_stats.LOVE) iconsHTML += '<span>‚ù§Ô∏è</span>';
                            if (data.reaction_stats.HAHA) iconsHTML += '<span>üòÇ</span>';
                            if (data.reaction_stats.WOW) iconsHTML += '<span>üòÆ</span>';
                            if (data.reaction_stats.SAD) iconsHTML += '<span>üò¢</span>';
                            if (data.reaction_stats.ANGRY) iconsHTML += '<span>üò°</span>';
                            statsContainer.innerHTML = `<span class="ms-1">${iconsHTML} ${data.total_reactions}</span>`;
                        } else {
                            statsContainer.innerHTML = '';
                        }
                    }

                    const mainReactionButton = document.querySelector(`.comment-reaction-btn[data-comment-id='${commentId}']`);
                    if (mainReactionButton) {
                        if (data.current_user_reaction) {
                            mainReactionButton.classList.add('text-primary', 'fw-bold');
                            mainReactionButton.classList.remove('text-muted');
                            let reactionText = 'Th√≠ch';
                            if (data.current_user_reaction === 'LIKE') reactionText = 'üëç Th√≠ch';
                            else if (data.current_user_reaction === 'LOVE') reactionText = '‚ù§Ô∏è Y√™u th√≠ch';
                            else if (data.current_user_reaction === 'HAHA') reactionText = 'üòÇ Haha';
                            else if (data.current_user_reaction === 'WOW') reactionText = 'üòÆ Wow';
                            else if (data.current_user_reaction === 'SAD') reactionText = 'üò¢ Bu·ªìn';
                            else if (data.current_user_reaction === 'ANGRY') reactionText = 'üò° Ph·∫´n n·ªô';
                            mainReactionButton.innerHTML = reactionText;
                        } else {
                            mainReactionButton.classList.remove('text-primary', 'fw-bold');
                            mainReactionButton.classList.add('text-muted');
                            mainReactionButton.innerHTML = 'Th√≠ch';
                        }
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Comment Reaction Error:', error));
        }
        document.body.addEventListener('click', function(event) {
            if (event.target.closest('.comment-reaction-btn, .comment-reaction-choice-btn')) {
                handleCommentReaction(event);
            }
        });

        // =======================================================
        // === LOGIC TH√îNG B√ÅO (NOTIFICATION) - ƒê√É C·∫¨P NH·∫¨T
        // =======================================================
        {% if user.is_authenticated %}
        function loadNotifications() {
          fetch("/notifications/api/")
            .then((resp) => resp.json())
            .then((data) => {
              const list = document.getElementById("notif-list");
              const countBadge = document.getElementById("notif-count");
              
              // X√≥a c√°c th√¥ng b√°o c≈© m·ªôt c√°ch an to√†n
              const dividerLi = list.querySelector('.dropdown-divider').parentElement;
              let current = list.firstChild;
              while (current && current !== dividerLi) {
                  let next = current.nextSibling;
                  list.removeChild(current);
                  current = next;
              }

              if (!data.notifications || data.notifications.length === 0) {
                const noNotifItem = '<li><span class="dropdown-item text-muted">Kh√¥ng c√≥ th√¥ng b√°o n√†o</span></li>';
                dividerLi.insertAdjacentHTML('beforebegin', noNotifItem);
                
                countBadge.innerText = 0;
                countBadge.style.display = 'none';
              } else {
                countBadge.innerText = data.total_unread;
                countBadge.style.display = data.total_unread > 0 ? 'block' : 'none';

                data.notifications.forEach((n) => {
                  // Ph√¢n bi·ªát class cho th√¥ng b√°o ƒë√£ ƒë·ªçc (n·ªÅn x√°m) v√† ch∆∞a ƒë·ªçc (ch·∫•m xanh)
                  const statusClass = n.is_read ? 'notification-read' : 'notification-unread';
                  
                  const notifHtml = `
                    <li>
                      <a class="dropdown-item text-wrap ${statusClass}" style="white-space: normal;" href="${n.link}">
                        <strong>${n.sender}</strong> ${n.type}<br>
                        <small class="text-muted">${n.timestamp}</small>
                      </a>
                    </li>`;
                  dividerLi.insertAdjacentHTML('beforebegin', notifHtml);
                });
              }
            })
            .catch((err) => console.error("Load notifications error", err));
        }
        
        loadNotifications();
        setInterval(loadNotifications, 10000);
        {% endif %}
        
        // =======================================================
        // === LOGIC WIDGET TR√í CHUY·ªÜN (CHAT)
        // =======================================================
        {% if user.is_authenticated %}
        const openChatBtn = document.getElementById("openChatBtn");
        const closeChatBtn = document.getElementById("closeChatBtn");
        const chatPopup = document.getElementById("chatPopup");
        const chatPopupBodyContent = document.getElementById("chatPopupBodyContent");
        const chatPopupTitle = document.getElementById("chat-popup-title");
        const newMessageBtn = document.getElementById("newMessageBtn");
        const backToRecentBtn = document.getElementById("backToRecentBtn");
        const recentConversationsView = document.getElementById("recent-conversations-view");
        const searchUsersView = document.getElementById("search-users-view");
        const searchInput = document.getElementById("searchInput");
        const searchResultsList = document.getElementById("searchResultsList");

        let conversationsLoaded = false;

        openChatBtn.addEventListener("click", function () {
          chatPopup.style.display = "flex";
          if (!conversationsLoaded) {
            loadConversations();
          }
        });
        closeChatBtn.addEventListener("click", () => { chatPopup.style.display = "none"; });

        newMessageBtn.addEventListener("click", () => {
          recentConversationsView.style.display = "none";
          searchUsersView.style.display = "block";
          chatPopupTitle.innerText = "Tin nh·∫Øn m·ªõi";
          searchInput.focus();
        });
        backToRecentBtn.addEventListener("click", () => {
          searchUsersView.style.display = "none";
          recentConversationsView.style.display = "block";
          chatPopupTitle.innerText = "Tin nh·∫Øn";
          searchInput.value = "";
          searchResultsList.innerHTML = "";
        });

        function loadConversations() {
          fetch("{% url 'chat:api_get_conversations' %}")
            .then((response) => response.json())
            .then((data) => {
              chatPopupBodyContent.innerHTML = "";
              chatPopupBodyContent.className = "";
              if (data.conversations && data.conversations.length > 0) {
                data.conversations.forEach((conv) => {
                  chatPopupBodyContent.innerHTML += `
                    <a href="${conv.detail_url}" class="conversation-item">
                      <div class="flex-shrink-0 me-3">üë§</div>
                      <div class="w-100" style="overflow: hidden;">
                        <strong>${conv.other_participant.username}</strong>
                        <p class="last-message mb-0">${conv.last_message || "B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán"}</p>
                      </div>
                    </a>`;
                });
              } else {
                chatPopupBodyContent.innerHTML = '<p class="text-center text-muted p-3">Kh√¥ng c√≥ cu·ªôc tr√≤ chuy·ªán n√†o.</p>';
              }
              conversationsLoaded = true;
            })
            .catch((error) => {
              console.error("L·ªói khi t·∫£i tin nh·∫Øn:", error);
              chatPopupBodyContent.innerHTML = '<p class="text-center text-danger p-3">Kh√¥ng th·ªÉ t·∫£i tin nh·∫Øn.</p>';
            });
        }

        let searchTimeout;
        searchInput.addEventListener("keyup", function () {
          clearTimeout(searchTimeout);
          const query = searchInput.value.trim();

          if (query.length < 2) {
            searchResultsList.innerHTML = '<p class="text-center text-muted p-3">Nh·∫≠p √≠t nh·∫•t 2 k√Ω t·ª±.</p>';
            return;
          }
          searchResultsList.innerHTML = '<p class="text-center text-muted p-3">ƒêang t√¨m...</p>';

          searchTimeout = setTimeout(() => {
            fetch(`{% url 'chat:api_search_users' %}?q=${encodeURIComponent(query)}`)
              .then((response) => response.json())
              .then((data) => {
                searchResultsList.innerHTML = "";
                if (data.users && data.users.length > 0) {
                  data.users.forEach((user) => {
                    searchResultsList.innerHTML += `
                      <a href="${user.start_conversation_url}" class="conversation-item">
                        <div class="flex-shrink-0 me-3">üë§</div>
                        <div class="w-100"><strong>${user.full_name}</strong></div>
                      </a>`;
                  });
                } else {
                  searchResultsList.innerHTML = '<p class="text-center text-muted p-3">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng.</p>';
                }
              });
          }, 300);
        });
        {% endif %}

      });
    </script>

  </body>
</html>