<!-- posts/templates/posts/base.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MySocial</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="...bootstrap.bundle.min.js..."></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <!-- URL 'home' kh√¥ng c√≥ namespace v√¨ n√≥ n·∫±m trong URL g·ªëc -->
        <a class="navbar-brand" href="{% url 'home' %}">MySocial</a>
        <div class="d-flex">
          {% if user.is_authenticated %}
          <!-- N√öT L·ªúI M·ªúI K·∫æT B·∫†N -->
          <a
            href="{% url 'accounts:friend_requests' %}"
            class="btn btn-outline-secondary position-relative me-3"
          >
            L·ªùi m·ªùi 
          </a>

          <!-- N√öT LINK T·ªöI TRANG CHAT CH√çNH -->
          <a href="{% url 'chat:conversation_list' %}" class="btn btn-outline-info me-3">
            Tin nh·∫Øn
          </a>
          
          <a
            href="{% url 'accounts:user_list' %}"
            class="btn btn-outline-primary me-3"
            >T√¨m b·∫°n</a
          >

          <span class="navbar-text me-3">
            <a
              href="{% url 'accounts:profile' username=user.username %}"
              class="text-dark text-decoration-none"
            >
              Ch√†o, {{ user.username }}!
            </a>
          </span>
          <a href="{% url 'accounts:logout' %}" class="btn btn-outline-danger"
            >ƒêƒÉng xu·∫•t</a
          >
          {% else %}
          <a
            href="{% url 'accounts:login' %}"
            class="btn btn-outline-success me-2"
            >ƒêƒÉng nh·∫≠p</a
          >
          <a href="{% url 'accounts:register' %}" class="btn btn-primary"
            >ƒêƒÉng k√Ω</a
          >
          {% endif %}
        </div>
      </div>
    </nav>

    <main class="container mt-4">
      {% block content %} {% endblock content %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- === TH√äM ƒêO·∫†N SCRIPT SAU === -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // L·∫•y cookie theo t√™n (chu·∫©n Django docs)
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(
                  cookie.substring(name.length + 1)
                );
                break;
              }
            }
          }
          return cookieValue;
        }

        const csrftoken = getCookie("csrftoken");

        function updateReactionStatsUI(postId, stats, total) {
          const statsContainer = document.getElementById(
            `reaction-stats-${postId}`
          );
          if (!statsContainer) return;
          if (total > 0) {
            let iconsHTML = '<div class="me-2">';
            if (stats.LIKE) iconsHTML += "<span>üëç</span>";
            if (stats.LOVE) iconsHTML += "<span>‚ù§Ô∏è</span>";
            if (stats.HAHA) iconsHTML += "<span>üòÇ</span>";
            if (stats.WOW) iconsHTML += "<span>üòÆ</span>";
            if (stats.SAD) iconsHTML += "<span>üò¢</span>";
            if (stats.ANGRY) iconsHTML += "<span>üò°</span>";
            iconsHTML += "</div>";
            statsContainer.innerHTML =
              iconsHTML +
              `<span id="reactions-count-${postId}">${total}</span>`;
          } else {
            statsContainer.innerHTML = `<span id="reactions-count-${postId}" class="text-muted">Ch∆∞a c√≥ c·∫£m x√∫c</span>`;
          }
        }

        function highlightSelectedReaction(postId, selectedType) {
          const buttons = document.querySelectorAll(
            `.reaction-btn[data-post-id='${postId}']`
          );
          buttons.forEach((btn) => {
            if (btn.dataset.reactionType === selectedType) {
              btn.classList.add("fw-bold", "text-primary");
            } else {
              btn.classList.remove("fw-bold", "text-primary");
            }
          });
        }

        document.querySelectorAll(".reaction-btn").forEach((button) => {
          button.addEventListener("click", function (e) {
            e.preventDefault();
            const postId = this.dataset.postId;
            const reactionType = this.dataset.reactionType;

            fetch(`/post/${postId}/react/`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken, // t√™n header ph·∫£i ƒë√∫ng
                "X-Requested-With": "XMLHttpRequest", // optional nh∆∞ng n√™n c√≥
              },
              credentials: "same-origin", // g·ª≠i k√®m cookie csrftoken
              body: JSON.stringify({ reaction_type: reactionType }),
            })
              .then((res) => res.json())
              .then((data) => {
                if (data.status === "ok") {
                  updateReactionStatsUI(
                    postId,
                    data.reaction_stats,
                    data.total_reactions
                  );
                  highlightSelectedReaction(postId, data.current_user_reaction);
                } else {
                  alert(data.message || "C√≥ l·ªói x·∫£y ra.");
                }
              })
              .catch((err) => console.error("Error:", err));
          });
        });
        // === SCRIPT X·ª¨ L√ù TH√äM B√åNH LU·∫¨N ===
        document.querySelectorAll('.comment-form').forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault();

                const url = this.action;
                const formData = new FormData(this);
                const contentInput = this.querySelector('input[name=content]');

                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        // Th√™m HTML c·ªßa b√¨nh lu·∫≠n m·ªõi v√†o danh s√°ch
                        const commentList = this.closest('.comments-section').querySelector('.comment-list');
                        commentList.insertAdjacentHTML('beforeend', data.comment_html);
                        // X√≥a tr·∫Øng √¥ input
                        contentInput.value = '';
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });

        // === SCRIPT X·ª¨ L√ù X√ìA B√åNH LU·∫¨N ===
        // D√πng event delegation v√¨ c√°c n√∫t x√≥a ƒë∆∞·ª£c th√™m v√†o sau
        document.body.addEventListener('click', function(event) {
            if (event.target.classList.contains('delete-comment-btn')) {
                event.preventDefault();
                
                if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y kh√¥ng?')) {
                    return;
                }

                const url = event.target.href;

                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        // X√≥a b√¨nh lu·∫≠n kh·ªèi giao di·ªán
                        const commentDiv = event.target.closest('[id^="comment-"]');
                        if (commentDiv) {
                            commentDiv.remove();
                        }
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".reaction-count").forEach(function (elem) {
          elem.addEventListener("click", function () {
            let postId = this.dataset.postId;

            fetch(`/post/${postId}/reactions/detail/`)
              .then((response) => response.json())
              .then((data) => {
                let html = "";
                for (let type in data) {
                  html += `<strong>${type}</strong>: ${data[type].join(
                    ", "
                  )}<br>`;
                }
                document.getElementById("reactionDetailBox").innerHTML = html;
                new bootstrap.Modal(
                  document.getElementById("reactionModal")
                ).show();
              });
          });
        });
      });
    </script>

    {% block extra_js %}{% endblock %}

        {# ============== B·∫ÆT ƒê·∫¶U PH·∫¶N WIDGET CHAT N·ªîI (PHI√äN B·∫¢N N√ÇNG C·∫§P) ============== #}
        {% if user.is_authenticated %}
        <style>
            .chat-widget-container { position: fixed; bottom: 25px; right: 25px; z-index: 1050; }
            .chat-open-button { background-color: #0d6efd; color: white; padding: 16px; border: none; cursor: pointer; border-radius: 50%; width: 60px; height: 60px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; }
            .chat-popup { display: none; position: absolute; bottom: 80px; right: 0; width: 320px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); background-color: white; flex-direction: column; }
            .chat-popup-header { background-color: #0d6efd; color: white; padding: 10px 15px; border-top-left-radius: 10px; border-top-right-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
            .chat-popup-header h4 { margin: 0; font-size: 1.1rem; }
            .chat-popup-header .header-buttons { display: flex; align-items: center; gap: 10px; }
            .chat-popup-body { padding: 0; max-height: 400px; overflow-y: auto; }
            .chat-popup-body .conversation-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; text-decoration: none; color: #212529; transition: background-color 0.2s; }
            .chat-popup-body .conversation-item:last-child { border-bottom: none; }
            .chat-popup-body .conversation-item:hover { background-color: #f1f1f1; }
            .chat-popup-body .conversation-item .last-message { font-size: 0.85rem; color: #6c757d; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            .chat-action-btn { background: none; border: none; color: white; cursor: pointer; padding: 0; font-size: 1.2rem; }
            #search-users-view .search-header { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
            #search-users-view input { border-radius: 20px; }
        </style>
    
        <div class="chat-widget-container">
            <!-- C·ª≠a s·ªï Popup (·∫©n m·∫∑c ƒë·ªãnh) -->
            <div class="chat-popup" id="chatPopup">
                <div class="chat-popup-header">
                    <h4 id="chat-popup-title">Tin nh·∫Øn</h4>
                    <div class="header-buttons">
                        <button type="button" class="chat-action-btn" id="newMessageBtn" title="Tin nh·∫Øn m·ªõi">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg>
                        </button>
                        <button type="button" class="chat-action-btn" id="closeChatBtn" style="font-size: 1.5rem; line-height: 1;">&times;</button>
                    </div>
                </div>
                <div class="chat-popup-body">
                    <!-- M√†n h√¨nh 1: Danh s√°ch tin nh·∫Øn g·∫ßn ƒë√¢y (m·∫∑c ƒë·ªãnh) -->
                    <div id="recent-conversations-view">
                        <div id="chatPopupBodyContent" class="p-3 text-center text-muted">ƒêang t·∫£i...</div>
                    </div>
    
                    <!-- M√†n h√¨nh 2: T·∫°o tin nh·∫Øn m·ªõi (·∫©n) -->
                    <div id="search-users-view" style="display: none;">
                        <div class="search-header">
                            <button class="btn btn-light btn-sm" id="backToRecentBtn">&larr;</button>
                            <input type="text" class="form-control" id="searchInput" placeholder="T√¨m ki·∫øm ng∆∞·ªùi d√πng...">
                        </div>
                        <div id="searchResultsList"></div>
                    </div>
                </div>
            </div>
    
            <!-- N√∫t Tr√≤n ƒë·ªÉ m·ªü Popup -->
            <button class="chat-open-button" id="openChatBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-chat-dots-fill" viewBox="0 0 16 16"><path d="M16 8c0 3.866-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.584.296-1.925.864-4.181 1.234-.2.032-.352-.176-.273-.362.354-.836.674-1.95.77-2.966C.744 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7zM5 8a1 1 0 1 0-2 0 1 1 0 0 0 2 0zm4 0a1 1 0 1 0-2 0 1 1 0 0 0 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
            </button>
        </div>
    
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const openChatBtn = document.getElementById('openChatBtn');
            const closeChatBtn = document.getElementById('closeChatBtn');
            const chatPopup = document.getElementById('chatPopup');
            const chatPopupBodyContent = document.getElementById('chatPopupBodyContent');
            const chatPopupTitle = document.getElementById('chat-popup-title');
    
            // C√°c element cho m√†n h√¨nh m·ªõi
            const newMessageBtn = document.getElementById('newMessageBtn');
            const backToRecentBtn = document.getElementById('backToRecentBtn');
            const recentConversationsView = document.getElementById('recent-conversations-view');
            const searchUsersView = document.getElementById('search-users-view');
            const searchInput = document.getElementById('searchInput');
            const searchResultsList = document.getElementById('searchResultsList');
    
            let conversationsLoaded = false;
    
            // M·ªü/ƒë√≥ng popup
            openChatBtn.addEventListener('click', function() {
                chatPopup.style.display = 'flex';
                if (!conversationsLoaded) { loadConversations(); }
            });
            closeChatBtn.addEventListener('click', function() { chatPopup.style.display = 'none'; });
    
            // Chuy·ªÉn ƒë·ªïi gi·ªØa c√°c m√†n h√¨nh
            newMessageBtn.addEventListener('click', function() {
                recentConversationsView.style.display = 'none';
                searchUsersView.style.display = 'block';
                chatPopupTitle.innerText = 'Tin nh·∫Øn m·ªõi';
                searchInput.focus();
            });
            backToRecentBtn.addEventListener('click', function() {
                searchUsersView.style.display = 'none';
                recentConversationsView.style.display = 'block';
                chatPopupTitle.innerText = 'Tin nh·∫Øn';
                searchInput.value = '';
                searchResultsList.innerHTML = '';
            });
    
            // H√†m t·∫£i danh s√°ch cu·ªôc tr√≤ chuy·ªán
            function loadConversations() {
                fetch("{% url 'chat:api_get_conversations' %}")
                    .then(response => response.json())
                    .then(data => {
                        chatPopupBodyContent.innerHTML = ''; // X√≥a "ƒêang t·∫£i..."
                        chatPopupBodyContent.className = ''; // X√≥a class padding
                        if (data.conversations && data.conversations.length > 0) {
                            data.conversations.forEach(conv => {
                                chatPopupBodyContent.innerHTML += `
                                    <a href="${conv.detail_url}" class="conversation-item">
                                        <div class="flex-shrink-0 me-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-person-circle text-secondary" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/></svg>
                                        </div>
                                        <div class="w-100" style="overflow: hidden;">
                                            <strong>${conv.other_participant.username}</strong>
                                            <p class="last-message mb-0">${conv.last_message || 'B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán'}</p>
                                        </div>
                                    </a>`;
                            });
                        } else {
                            chatPopupBodyContent.innerHTML = '<p class="text-center text-muted p-3">Kh√¥ng c√≥ cu·ªôc tr√≤ chuy·ªán n√†o.</p>';
                        }
                        conversationsLoaded = true;
                    }).catch(error => {
                        console.error('L·ªói khi t·∫£i tin nh·∫Øn:', error);
                        chatPopupBodyContent.innerHTML = '<p class="text-center text-danger p-3">Kh√¥ng th·ªÉ t·∫£i tin nh·∫Øn.</p>';
                    });
            }
            
            // Logic t√¨m ki·∫øm ng∆∞·ªùi d√πng
            let searchTimeout;
            searchInput.addEventListener('keyup', function() {
                clearTimeout(searchTimeout);
                const query = searchInput.value.trim();
    
                if (query.length < 2) {
                    searchResultsList.innerHTML = '<p class="text-center text-muted p-3">Nh·∫≠p √≠t nh·∫•t 2 k√Ω t·ª± ƒë·ªÉ t√¨m ki·∫øm.</p>';
                    return;
                }
    
                searchResultsList.innerHTML = '<p class="text-center text-muted p-3">ƒêang t√¨m...</p>';
    
                // Debounce: Ch·ªù 300ms sau khi ng∆∞·ªùi d√πng ng·ª´ng g√µ m·ªõi g·ª≠i request
                searchTimeout = setTimeout(() => {
                    fetch(`{% url 'chat:api_search_users' %}?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            searchResultsList.innerHTML = '';
                            if (data.users && data.users.length > 0) {
                                data.users.forEach(user => {
                                    searchResultsList.innerHTML += `
                                        <a href="${user.start_conversation_url}" class="conversation-item">
                                            <div class="flex-shrink-0 me-3">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-person-circle text-secondary" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/></svg>
                                            </div>
                                            <div class="w-100"><strong>${user.full_name}</strong></div>
                                        </a>`;
                                });
                            } else {
                                searchResultsList.innerHTML = '<p class="text-center text-muted p-3">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o.</p>';
                            }
                        });
                }, 300);
            });
            
        });
        </script>
        {% endif %}
        {# ============== K·∫æT TH√öC PH·∫¶N WIDGET CHAT N·ªîI ============== #}
  </body>
</html>
