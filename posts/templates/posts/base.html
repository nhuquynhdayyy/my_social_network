<!-- posts/templates/posts/base.html (ƒê√É S·ª¨A L·ªñI HO√ÄN CH·ªàNH) -->
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>MySocial</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Th√™m Google Font cho Logo (Gi·ªëng Instagram) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">


    <!-- === CSS T·ªîNG H·ª¢P CHO TO√ÄN B·ªò TRANG === -->
    <style>
      body {
        background-color: #fafafa;
      }

      .modal-fullscreen-custom .modal-dialog {
            max-width: 90vw; /* ƒê·ªô r·ªông t·ªëi ƒëa 90% m√†n h√¨nh */
            width: 90vw;
            margin: 1.75rem auto; /* CƒÉn gi·ªØa */
        }

        .modal-fullscreen-custom .modal-content {
            height: 90vh; /* Chi·ªÅu cao c·ªë ƒë·ªãnh */
            border-radius: 0 4px 4px 0; /* Bo g√≥c nh·∫π */
            overflow: hidden;
        }

        .modal-fullscreen-custom .modal-body {
            padding: 0; /* B·ªè padding m·∫∑c ƒë·ªãnh */
            overflow: hidden; /* ·∫®n thanh cu·ªôn ngo√†i */
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cccccc;
            border-radius: 4px;
        }
        /* CƒÉn media m√†u ƒëen */
        .media-column {
            background-color: black;
        }

      .btn-interactive {
          background-color: transparent;
          border: none;
          color: #65676b; /* M√†u ch·ªØ x√°m c·ªßa Facebook */
          font-weight: 600;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px; /* Kho·∫£ng c√°ch gi·ªØa icon v√† ch·ªØ */
          border-radius: 6px;
      }
      .btn-interactive:hover {
          background-color: #f2f2f2;
          color: #65676b;
      }
      .interactive-icon {
          width: 18px;
          height: 18px;
          fill: currentColor;
      }

      /* CSS cho tr·∫°ng th√°i ƒë√£ reaction */
      .btn-interactive.reaction-active {
        color: #0866ff; /* M√†u xanh khi ƒë√£ Like */
      }
      .btn-interactive.reaction-active .reaction-icon-liked { color: #0866ff; }
      .btn-interactive.reaction-active .reaction-icon-loved { color: #f33e58; }
      .btn-interactive.reaction-active .reaction-icon-haha { color: #f7b125; }
      .btn-interactive.reaction-active .reaction-icon-wow { color: #f7b125; }
      .btn-interactive.reaction-active .reaction-icon-sad { color: #f7b125; }
      .btn-interactive.reaction-active .reaction-icon-angry { color: #e9710f; }
      
      /* C·∫≠p nh·∫≠t m√†u cho text khi ƒë√£ reaction */
      .reaction-active[data-reaction-type="LIKE"] { color: #0866ff; } /* Like - Xanh */
      .reaction-active[data-reaction-type="LOVE"] { color: #f33e58; } /* Love - ƒê·ªè */
      .reaction-active[data-reaction-type="HAHA"],
      .reaction-active[data-reaction-type="WOW"],
      .reaction-active[data-reaction-type="SAD"] { color: #f7b125; } /* Haha, Wow, Sad - V√†ng */
      .reaction-active[data-reaction-type="ANGRY"] { color: #e9710f; } /* Angry - Cam */
      
      .comment-input-wrapper {
          display: flex;
          align-items: center;
          padding: 8px 0;
      }

      .comment-input-ig, .comment-input-ig:focus {
          border: none;
          box-shadow: none; /* Lo·∫°i b·ªè hi·ªáu ·ª©ng focus m√†u xanh c·ªßa Bootstrap */
          background-color: transparent;
          padding-left: 0;
          font-size: 0.9rem;
      }

      .comment-input-ig::placeholder {
          color: #737373;
      }

      .comment-submit-btn {
          text-decoration: none;
          font-weight: 600;
          padding: 0;
          margin-left: auto; /* ƒê·∫©y n√∫t G·ª≠i v·ªÅ‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏ß‡∏≤ */
      }

      .reaction-tabs-container {
          padding: 0.5rem 1rem;
          border-bottom: 1px solid #dee2e6;
          display: flex;
          flex-wrap: wrap;
          gap: 0.5rem;
      }
      .reaction-tab {
          display: inline-flex;
          align-items: center;
          gap: 0.3rem;
          padding: 0.4rem 0.8rem;
          border: 1px solid transparent;
          border-radius: 1.5rem; /* Bo tr√≤n */
          background-color: #e4e6eb;
          color: #050505;
          font-weight: 600;
          cursor: pointer;
          transition: background-color 0.2s;
      }
      .reaction-tab:hover {
          background-color: #d8dbdf;
      }
      .reaction-tab.active {
          background-color: #e7f3ff;
          color: #0866ff;
          border-color: #0866ff;
      }
      .reaction-tab .badge {
          font-size: 0.8em;
      }

      .comment-content-wrapper {
          position: relative; /* T·∫°o khung tham chi·∫øu cho n√∫t 3 ch·∫•m */
          display: inline-flex;
          align-items: center; /* CƒÉn gi·ªØa c√°c item theo chi·ªÅu d·ªçc */
          max-width: 100%;
      }

      .comment-options-dropdown {
          position: absolute; /* L·∫•y wrapper l√†m tham chi·∫øu */
          top: 50%;
          left: 100%; /* ƒê·∫∑t n√∫t ·ªü b√™n ngo√†i bong b√≥ng 1 ch√∫t */
          margin-left: 8px; /* T·∫°o kho·∫£ng c√°ch gi·ªØa n√∫t v√† bong b√≥ng */
          transform: translateY(-50%); /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
          
          z-index: 10; /* ƒê·∫£m b·∫£o n√∫t n·ªïi l√™n tr√™n c√°c ph·∫ßn t·ª≠ kh√°c */
          /* M·∫∑c ƒë·ªãnh ·∫©n n√∫t ƒëi */
          opacity: 0;
          visibility: hidden;
          transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
      }

      /* KHI HOVER V√ÄO TO√ÄN B·ªò KHU V·ª∞C B√åNH LU·∫¨N */
      div[id^="comment-"]:hover .comment-options-dropdown {
          /* Hi·ªán n√∫t 3 ch·∫•m l√™n */
          opacity: 1;
          visibility: visible;
      }

      .replies-container {
          position: relative; /* B·∫Øt bu·ªôc ƒë·ªÉ l√†m khung tham chi·∫øu cho ƒë∆∞·ªùng k·∫ª d·ªçc */
          margin-left: 24px;  /* ƒê·∫©y kh·ªëi reply v√†o trong */
          padding-left: 28px; /* T·∫°o kh√¥ng gian cho ƒë∆∞·ªùng k·∫ª v√† c√°c nh√°nh */
      }

      .replies-container {
          /* B·ªè position v√† ::before ·ªü ƒë√¢y, ch·ªâ gi·ªØ l·∫°i padding/margin */
          padding-left: 28px;
          margin-left: 16px; 
      }

      /* √Åp d·ª•ng cho T·∫§T C·∫¢ b√¨nh lu·∫≠n con */
      .replies-container > div[id^="comment-"] {
          position: relative;
      }
      
      /* B∆∞·ªõc 1: V·∫Ω ƒë∆∞·ªùng k·∫ª "NH√ÅNH" ngang cho T·∫§T C·∫¢ b√¨nh lu·∫≠n con */
      .replies-container > div[id^="comment-"]::before {
          content: '';
          position: absolute;
          top: 16px;
          left: -20px;
          width: 12px;
          height: 2px;
          background-color: #e0e0e0;
      }

      /* B∆∞·ªõc 2: V·∫Ω ƒë∆∞·ªùng k·∫ª "TH√ÇN" d·ªçc cho c√°c b√¨nh lu·∫≠n con ·ªû GI·ªÆA (kh√¥ng ph·∫£i c√°i cu·ªëi) */
      .replies-container > div[id^="comment-"]:not(:last-child)::after {
          content: '';
          position: absolute;
          top: 0;
          left: -20px;
          width: 2px;
          height: 100%;
          background-color: #e0e0e0;
      }

      /* B∆∞·ªõc 3: V·∫Ω G√ìC CONG ch·ªØ L cho b√¨nh lu·∫≠n con CU·ªêI C√ôNG */
      .replies-container > div[id^="comment-"]:last-child::before {
          content: '';
          position: absolute;
          top: 0;
          left: -20px;
          width: 14px;
          height: 18px; /* K√©o d√†i ƒë·∫øn gi·ªØa avatar */
          
          /* B·ªè background v√† d√πng border ƒë·ªÉ v·∫Ω h√¨nh ch·ªØ L */
          background-color: transparent; 
          border-left: 2px solid #e0e0e0;
          border-bottom: 2px solid #e0e0e0;
          border-bottom-left-radius: 8px; /* Thu·ªôc t√≠nh bo tr√≤n g√≥c */
      }

      a.mentioned-user {
          font-weight: 600; /* T√¥ ƒë·∫≠m */
          color: #050505;   /* M√†u ch·ªØ ƒëen (ho·∫∑c m√†u b·∫°n th√≠ch) */
          text-decoration: none;
      }
      a.mentioned-user:hover {
          text-decoration: underline;
      }

      .privacy-icon {
          display: inline-block;
          vertical-align: middle; /* CƒÉn gi·ªØa icon v·ªõi d√≤ng ch·ªØ */
          margin-left: 4px; /* T·∫°o kho·∫£ng c√°ch nh·ªè */
      }
      .privacy-icon svg {
          width: 12px;
          height: 12px;
          fill: currentColor; /* Icon s·∫Ω c√≥ m√†u x√°m gi·ªëng ch·ªØ b√™n c·∫°nh */
      }

      .carousel-counter {
          position: absolute;
          top: 10px;
          right: 10px;
          background-color: rgba(0, 0, 0, 0.6); /* N·ªÅn ƒëen m·ªù */
          color: white;
          padding: 4px 10px;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: 500;
          z-index: 10; /* ƒê·∫£m b·∫£o n√≥ n·ªïi l√™n tr√™n ·∫£nh */
          pointer-events: none; /* Tr√°nh vi·ªác n√≥ c·∫£n tr·ªü click v√†o c√°c n√∫t kh√°c */
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 244px;
        background-color: #ffffff;
        border-right: 1px solid #dbdbdb;
        padding: 8px 12px 20px;
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease;
        z-index: 1000;
      }

      .sidebar-brand {
        font-family: 'Lobster', cursive;
        font-size: 2rem;
        text-decoration: none;
        color: #000000;
        padding: 25px 12px 35px;
      }

      .sidebar-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .sidebar-nav li a {
        display: flex;
        align-items: center;
        padding: 12px;
        margin: 4px 0;
        border-radius: 8px;
        text-decoration: none;
        color: #000000;
        font-weight: 500;
        transition: background-color 0.2s ease-in-out;
      }

      .sidebar-nav li a:hover {
        background-color: #f2f2f2;
      }

      .sidebar-nav .nav-icon {
        width: 24px;
        height: 24px;
        margin-right: 16px;
      }
      
      .sidebar-footer {
        margin-top: auto;
      }

      .main-content {
        margin-left: 244px;
        padding: 20px 0;
        transition: margin-left 0.3s ease;
        position: relative;
      }

      /* === B·∫ÆT ƒê·∫¶U CSS M·ªöI CHO SIDEBAR B√äN PH·∫¢I === */
      .right-sidebar {
        position: fixed; /* C·ªë ƒë·ªãnh khi cu·ªôn */
        top: 0;
        /* V·ªã tr√≠ c·ªßa n√≥ s·∫Ω ƒë∆∞·ª£c t√≠nh to√°n b·ªüi Bootstrap grid, 
           nh∆∞ng ch√∫ng ta c·∫ßn top: 0 v√† height: 100vh ƒë·ªÉ n√≥ chi·∫øm to√†n b·ªô chi·ªÅu cao */
        height: 100vh;
        padding-top: 30px; /* Th√™m kho·∫£ng ƒë·ªám ·ªü tr√™n */
        padding-left: 30px; /* Th√™m kho·∫£ng ƒë·ªám b√™n tr√°i */
        width: 320px; /* ƒê·∫∑t chi·ªÅu r·ªông c·ªë ƒë·ªãnh */
      }
      
      .online-indicator {
        position: absolute;
        bottom: 0;
        right: 12px;
        width: 10px;
        height: 10px;
        background-color: #31a24c; /* M√†u xanh online c·ªßa Facebook */
        border-radius: 50%;
        border: 2px solid #ffffff;
      }
      
      .contact-item:hover {
        background-color: #f2f2f2;
        border-radius: 8px;
      }
      /* === K·∫æT TH√öC CSS M·ªöI === */

      /* === CSS CHO HUY HI·ªÜU TH√îNG B√ÅO (B·ªä THI·∫æU) === */
        .notification-badge {
            position: absolute;
            top: 10px;
            left: 28px; /* ƒêi·ªÅu ch·ªânh v·ªã tr√≠ cho ph√π h·ª£p v·ªõi icon */
            background-color: #fa383e; /* M√†u ƒë·ªè c·ªßa Facebook */
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n ƒëi */
            justify-content: center;
            align-items: center;
            border: 2px solid white; /* T·∫°o vi·ªÅn tr·∫Øng gi·ªëng Facebook */
        }

        /* === CSS CHO TRANG TH√îNG B√ÅO (N√ÇNG C·∫§P) === */
        .notification-unread {
            background-color: #f0f2f5; /* M√†u n·ªÅn x√°m nh·∫°t gi·ªëng Facebook */
            border-left: 4px solid #0866ff; /* Th√™m m·ªôt ƒë∆∞·ªùng k·∫ª xanh b√™n tr√°i */
        }

        .notification-dot {
            min-width: 12px;
            height: 12px;
            background-color: #0866ff; /* M√†u xanh d∆∞∆°ng c·ªßa Facebook */
            border-radius: 50%;
        }
      
      /* === CSS CHO REACTION TR√äN B√åNH LU·∫¨N (ƒê√É B·ªä THI·∫æU) === */
      .comment-bubble {
          display: inline-block; /* ƒê√¢y l√† thu·ªôc t√≠nh quan tr·ªçng nh·∫•t! */
          background-color: #f0f2f5; /* M√†u n·ªÅn x√°m nh·∫°t c·ªßa Facebook */
          padding: 8px 12px;
          border-radius: 18px; /* Bo tr√≤n c√°c g√≥c */
          max-width: 100%; /* ƒê·∫£m b·∫£o kh√¥ng v∆∞·ª£t qu√° chi·ªÅu r·ªông c·ªßa th·∫ª cha */
          word-wrap: break-word; /* T·ª± ƒë·ªông xu·ªëng d√≤ng v·ªõi c√°c t·ª´ d√†i */
      }

      .comment-author {
          font-weight: 600;
          font-size: 0.85rem;
          color: #050505;
          text-decoration: none;
      }
      .comment-author:hover {
        text-decoration: underline;
      }

      .comment-content-text {
        color: #050505;
        font-size: 0.9rem;
        line-height: 1.3;
      }

      .comment-actions {
        padding-left: 12px;
        font-size: 0.8rem;
      }
      
      .comment-reaction-container {
          /* ƒê√¢y l√† d√≤ng quan tr·ªçng nh·∫•t, bi·∫øn container th√†nh khung tham chi·∫øu */
          position: relative;
          /* T·∫†O V√ôNG ƒê·ªÜM V√î H√åNH ·ªû TR√äN ƒê·ªÇ B·∫ÆT S·ª∞ KI·ªÜN R√ä CHU·ªòT */
          padding-top: 1rem;
          /* K√âO CONTAINER V·ªÄ V·ªä TR√ç C≈®, TR√ÅNH X√î L·ªÜCH GIAO DI·ªÜN */
          margin-top: -1rem;
      }

      .comment-reaction-popup {
          display: none; /* M·∫∑c ƒë·ªãnh ·∫©n ƒëi */
          position: absolute;
          bottom: 1.8rem; /* V·ªã tr√≠ ph√≠a tr√™n n√∫t "Th√≠ch" */
          left: -10px;
          background-color: white;
          border-radius: 20px;
          padding: 5px 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          white-space: nowrap;
          z-index: 1010; /* ƒê·∫∑t z-index cao h∆°n sidebar ƒë·ªÉ ch·∫Øc ch·∫Øn n·ªïi l√™n tr√™n */
          gap: 5px;
      }

      /* Khi di chu·ªôt v√†o container, hi·ªÉn th·ªã popup con c·ªßa n√≥ */
      .comment-reaction-container:hover .comment-reaction-popup {
          display: flex;
      }

      .comment-reaction-popup .btn {
          font-size: 1.5rem;
          padding: 0;
          border: none;
          background: none;
          transition: transform 0.1s;
      }

      .comment-reaction-popup .btn:hover {
          transform: scale(1.2);
      }

      /* === CSS: CHO REACTION TR√äN B√ÄI VI·∫æT (POST) - ƒê√É S·ª¨A L·∫†I CHO M∆Ø·ª¢T === */
      .post-reaction-container {
          position: relative;
          /* T·∫†O V√ôNG ƒê·ªÜM V√î H√åNH ·ªû TR√äN ƒê·ªÇ B·∫ÆT S·ª∞ KI·ªÜN R√ä CHU·ªòT */
          padding-top: 1rem;
          /* K√âO CONTAINER V·ªÄ V·ªä TR√ç C≈®, TR√ÅNH X√î L·ªÜCH GIAO DI·ªÜN */
          margin-top: -1rem;
      }

      .post-reaction-popup {
          display: none;
          position: absolute;
          bottom: 2.2rem; /* ƒêi·ªÅu ch·ªânh ƒë·ªÉ n·∫±m ngay tr√™n n√∫t "Th√≠ch" c·ªßa b√†i vi·∫øt */
          left: 0;
          background-color: white;
          border-radius: 20px;
          padding: 5px 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          white-space: nowrap;
          z-index: 1010;
          gap: 5px;
      }

      /* Khi di chu·ªôt v√†o container, hi·ªÉn th·ªã popup */
      .post-reaction-container:hover .post-reaction-popup {
          display: flex; 
      }

      .post-reaction-popup .btn {
          font-size: 1.8rem;
          padding: 0;
          border: none;
          background: none;
          transition: transform 0.1s;
      }

      .post-reaction-popup .btn:hover {
          transform: scale(1.2);
      }
      /* N√∫t m·ªü chat ch√≠nh (h√¨nh tr√≤n) */
      .chat-open-button {
          position: fixed;
          bottom: 25px;
          right: 25px;
          color: white;
          border: none;
          border-radius: 50%;
          width: 60px;
          height: 60px;
          font-size: 2rem;
          display: flex;
          justify-content: center;
          align-items: center;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          cursor: pointer;
          z-index: 1040;
          transition: transform 0.2s ease-in-out;
      }
      .chat-open-button:hover {
          transform: scale(1.1);
      }
      /* === CSS cho Chat Widget (B·ªä THI·∫æU) === */
      .chat-widget-container {
          position: fixed;
          bottom: 25px;
          right: 25px;
          z-index: 1050;
      }
      /* Khung popup ch√≠nh */
      .chat-popup {
          display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
          position: fixed; /* C·ªë ƒë·ªãnh so v·ªõi m√†n h√¨nh */
          bottom: 25px;
          right: 25px;
          width: 350px; /* R·ªông h∆°n m·ªôt ch√∫t */
          height: 500px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh */
          border-radius: 12px;
          box-shadow: 0 5px 20px rgba(0,0,0,0.2);
          background-color: white;
          flex-direction: column;
          z-index: 1050;
          overflow: hidden;
      }
      /* Header c·ªßa popup */
      .chat-popup-header {
          background-color: white;
          color: #000; /* Ch·ªØ m√†u ƒëen */
          padding: 15px;
          border-top-left-radius: 12px;
          border-top-right-radius: 12px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 1px solid #dbdbdb; /* ƒê∆∞·ªùng k·∫ª m·ªèng */
          flex-shrink: 0; /* Kh√¥ng cho header co l·∫°i */
      }
      .chat-popup-header h4 {
          margin: 0;
          font-size: 1.1rem;
          font-weight: 600; /* Ch·ªØ ƒë·∫≠m h∆°n */
      }
      .chat-popup-header .header-buttons {
          display: flex;
          align-items: center;
          gap: 10px;
      }
      /* Ph·∫ßn th√¢n (ch·ª©a danh s√°ch chat) */
      .chat-popup-body {
          padding: 0; /* X√≥a padding m·∫∑c ƒë·ªãnh */
          flex-grow: 1;
          overflow: hidden; /* Quan tr·ªçng: ƒë·ªÉ c√°c view con t·ª± cu·ªôn */
          position: relative;
      }
      .chat-view {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: white;
          transition: transform 0.3s ease-in-out;
          display: flex;
          flex-direction: column;
      }
      #recent-conversations-view {
          transform: translateX(0);
      }
      #chat-detail-view, #search-view {
          transform: translateX(100%); /* M·∫∑c ƒë·ªãnh ·∫©n b√™n ph·∫£i */
      }
      .chat-popup.show-detail #recent-conversations-view,
      .chat-popup.show-search #recent-conversations-view {
          transform: translateX(-100%); /* Tr∆∞·ª£t sang tr√°i v√† ·∫©n ƒëi */
      }
      .chat-popup.show-detail #chat-detail-view, .chat-popup.show-search #search-view {
          transform: translateX(0); /* Tr∆∞·ª£t v√†o t·ª´ ph·∫£i */
      }
      .conversations-list {
          overflow-y: auto;
          flex-grow: 1;
          padding: 8px 0;
      }
      /* N√∫t so·∫°n tin nh·∫Øn m·ªõi (n·ªïi b√™n trong) */
      .chat-compose-btn {
          position: absolute;
          bottom: 15px;
          right: 15px;
          background-color: #f0f2f5;
          border: none;
          border-radius: 50%;
          width: 50px;
          height: 50px;
          font-size: 1.5rem;
          display: flex;
          justify-content: center;
          align-items: center;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
          cursor: pointer;
          color: #000;
      }
      
      .conversation-item {
          display: flex; align-items: center; padding: 8px 15px; text-decoration: none;
          color: #212529; transition: background-color 0.2s;
      }
      .conversation-item:hover { background-color: #f9f9f9; }
      .conversation-item .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 12px; }
      /* T·ª´ng m·ª•c h·ªôi tho·∫°i */
      .chat-popup-body .conversation-item {
          display: flex;
          align-items: center;
          padding: 8px 15px;
          text-decoration: none;
          color: #212529;
          transition: background-color 0.2s;
      }
      .chat-popup-body .conversation-item:last-child {
          border-bottom: none;
      }
      .chat-popup-body .conversation-item:hover {
          background-color: #f9f9f9;
      }
      .conversation-item .avatar {
          width: 50px;
          height: 50px;
          border-radius: 50%;
          object-fit: cover; /* ƒê·∫£m b·∫£o ·∫£nh kh√¥ng b·ªã m√©o */
          margin-right: 12px;
      }
      .conversation-item .message-details {
          overflow: hidden;
      }
      .conversation-item .username {
          font-weight: 600;
          margin: 0;
      }
      .chat-popup-body .conversation-item .last-message {
          font-size: 0.85rem;
          color: #6c757d;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }
      .conversation-item .last-message {
          font-size: 0.875rem;
          color: #8e8e8e; /* M√†u x√°m c·ªßa Instagram */
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          margin: 0;
      }
      .chat-action-btn {
          background: none;
          border: none;
          color: #000; /* Icon m√†u ƒëen */
          cursor: pointer;
          padding: 0;
          font-size: 1.5rem;
          line-height: 1;
      }
      /* View t√¨m ki·∫øm */
      .search-header { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #dbdbdb; flex-shrink: 0; }
      #search-view-input { flex-grow: 1; border: 1px solid #dbdbdb; border-radius: 20px; padding: 8px 15px; }
      .search-results-list { flex-grow: 1; overflow-y: auto; }
      #search-users-view .search-header {
          padding: 10px;
          border-bottom: 1px solid #eee;
          display: flex;
          align-items: center;
          gap: 10px;
      }
      #search-users-view input {
          border-radius: 20px;
      }
        .chat-detail-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #dbdbdb;
            flex-shrink: 0;
        }
        .chat-back-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            margin-right: 10px;
            cursor: pointer;
        }
        .chat-detail-header .avatar {
            width: 32px;
            height: 32px;
        }
        .chat-detail-header .username {
            font-weight: 600;
        }

        .message-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        .message-bubble {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 18px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        .message-sent {
            background-color: #0095f6;
            color: white;
            align-self: flex-end; /* Tin nh·∫Øn c·ªßa m√¨nh n·∫±m b√™n ph·∫£i */
        }
        .message-received {
            background-color: #efefef;
            color: #000;
            align-self: flex-start; /* Tin nh·∫Øn c·ªßa ng∆∞·ªùi kh√°c n·∫±m b√™n tr√°i */
        }

        .message-form {
            display: flex;
            padding: 10px;
            border-top: 1px solid #dbdbdb;
            flex-shrink: 0;
        }
        .message-form input {
            flex-grow: 1;
            border: 1px solid #dbdbdb;
            border-radius: 20px;
            padding: 8px 15px;
            margin-right: 10px;
        }
        .message-form button {
            border-radius: 5px;
        }
    </style>
  </head>
  <body>
    <!-- B·ªçc to√†n b·ªô sidebar trong ƒëi·ªÅu ki·ªán user ƒë√£ ƒëƒÉng nh·∫≠p -->
    {% if user.is_authenticated %}
    <div class="sidebar">
      <!-- Ph·∫ßn logo -->
      <a class="sidebar-brand" href="{% url 'posts:home' %}">MySocial</a>
      
      <!-- Ph·∫ßn ƒëi·ªÅu h∆∞·ªõng ch√≠nh -->
      <nav class="sidebar-nav flex-grow-1">
        <ul>
          <li>
            <a href="{% url 'posts:home' %}">
              <svg class="nav-icon" aria-label="Home" fill="currentColor" viewBox="0 0 24 24"><path d="M22 23h-6.001a1 1 0 0 1-1-1v-5.455a2.997 2.997 0 0 0-2.2-2.822 2.997 2.997 0 0 0-3.6 2.822V22a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V11.543a1.002 1.002 0 0 1 .31-.724l10-9.543a1.001 1.001 0 0 1 1.38 0l10 9.543a1.002 1.002 0 0 1 .31.724V22a1 1 0 0 1-1 1Z"></path></svg>
              <span>Trang ch·ªß</span>
            </a>
          </li>
          <li>
            <a href="{% url 'accounts:user_list' %}">
              <svg class="nav-icon" aria-label="Search" fill="currentColor" viewBox="0 0 24 24"><path d="M19 10.5A8.5 8.5 0 1 1 10.5 2a8.5 8.5 0 0 1 8.5 8.5Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path><line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="16.511" x2="22" y1="16.511" y2="22"></line></svg>
              <span>T√¨m b·∫°n</span>
            </a>
          </li>
          <li>
            <a href="{% url 'accounts:friend_requests' %}">
              <svg class="nav-icon" aria-label="Friend Requests" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
              <span>L·ªùi m·ªùi</span>
            </a>
          </li>
          <li>
            <a href="{% url 'chat:conversation_list' %}">
              <svg class="nav-icon" aria-label="Messages" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
            </svg>
              <span>Tin nh·∫Øn</span>
            </a>
          </li>
          <li>
              <a href="{% url 'notifications:notification_list' %}" class="position-relative">
              <svg class="nav-icon" aria-label="Notifications" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
              <span>Th√¥ng b√°o</span>
              <span class="notification-badge" id="notif-count"></span>
            </a>
          </li>
           <li>
            <a href="{% url 'accounts:profile' username=user.username %}">
              <img src="{{ user.avatar.url }}" alt="{{ user.username }}" width="24" height="24" class="rounded-circle nav-icon"/>
              <span>Trang c√° nh√¢n</span>
            </a>
          </li>
        </ul>
      </nav>

      <!-- Ph·∫ßn ch√¢n sidebar: ƒêƒÉng xu·∫•t -->
      <div class="sidebar-footer">
        <nav class="sidebar-nav">
          <ul>
            <li>
              <a href="{% url 'accounts:logout' %}">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                <span>ƒêƒÉng xu·∫•t</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
    {% else %}
    <!-- === B·∫ÆT ƒê·∫¶U PH·∫¶N M·ªöI: SIDEBAR KHI CH∆ØA ƒêƒÇNG NH·∫¨P === -->
    <div class="sidebar">
        <a class="sidebar-brand" href="#">MySocial</a>
        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="{% url 'accounts:login' %}">
                        <!-- Icon Log In -->
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        <span>ƒêƒÉng nh·∫≠p</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'accounts:register' %}">
                        <!-- Icon Register/User Plus -->
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                        <span>ƒêƒÉng k√Ω</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
    <!-- K·∫æT TH√öC SIDEBAR -->


    <!-- V√ôNG N·ªòI DUNG CH√çNH -->
    <main class="main-content">
        {% block content %}{% endblock content %}
    </main>

    {% block extra_js %}{% endblock %}

    <!-- =================== CHAT WIDGET N·ªîI =================== -->
    {% if user.is_authenticated %}
    <div class="chat-widget-container">
      <div class="chat-popup" id="chatPopup">
        <!-- Header chung -->
        <div class="chat-popup-header">
          <h4 id="chat-view-title">Tin nh·∫Øn</h4>
          <button type="button" class="chat-action-btn" id="closeChatBtn">&times;</button>
        </div>

        <!-- Body ch·ª©a c√°c view -->
        <div class="chat-popup-body">
          
          <!-- VIEW 1: DANH S√ÅCH H·ªòI THO·∫†I -->
          <div class="chat-view" id="recent-conversations-view">
            <div class="conversations-list" id="chatPopupBodyContent">
                <p class="text-center text-muted p-5">ƒêang t·∫£i...</p>
            </div>
            <button class="chat-compose-btn" id="newMessageBtn" title="Tin nh·∫Øn m·ªõi">‚úèÔ∏è</button>
          </div>

          <!-- VIEW 2: CHI TI·∫æT CU·ªòC H·ªòI THO·∫†I -->
          <div class="chat-view" id="chat-detail-view">
            <div id="chat-detail-header" class="chat-detail-header"></div>
            <div id="message-list" class="message-list"></div>
            <form id="message-form" class="message-form">
              <input type="text" id="message-input" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
              <button type="submit" class="btn btn-primary btn-sm">G·ª≠i</button>
            </form>
          </div>

          <!-- VIEW 3: T√åM KI·∫æM NG∆Ø·ªúI D√ôNG M·ªöI -->
          <div class="chat-view" id="search-view">
            <div class="search-header">
              <button class="chat-back-btn" id="back-from-search-btn">‚Üê</button>
              <input type="text" id="search-view-input" placeholder="T√¨m ki·∫øm ng∆∞·ªùi d√πng..." autocomplete="off">
            </div>
            <div class="search-results-list" id="searchResultsList"></div>
          </div>

        </div>
      </div>
      <button class="chat-open-button" id="openChatBtn">üí¨</button>
    </div>
    {% endif %}
    <!-- =================== H·∫æT CHAT WIDGET =================== -->

    <!-- =================== MODAL HI·ªÇN TH·ªä DANH S√ÅCH REACTION =================== -->
    <div class="modal fade" id="reactionListModal" ...>
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="reactionListModalLabel">Nh·ªØng ng∆∞·ªùi ƒë√£ b√†y t·ªè c·∫£m x√∫c</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          
          <!-- TH√äM CONTAINER CHO C√ÅC TAB -->
          <div class="reaction-tabs-container" id="reactionTabsContainer">
              <!-- C√°c tab s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript -->
          </div>

          <!-- ƒê·ªîI T√äN ID ƒê·ªÇ D·ªÑ PH√ÇN BI·ªÜT -->
          <div class="modal-body" id="reactionUserListContainer">
            <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c t·∫£i b·∫±ng JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Chi Ti·∫øt B√†i Vi·∫øt -->
    <div class="modal fade modal-fullscreen-custom" id="postDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body" id="postDetailModalBody">
                    <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load qua AJAX -->
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- =================== SCRIPT CHUNG (ƒê√£ t·ªëi ∆∞u v√† g·ªôp) =================== -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
        
        const allCarousels = document.querySelectorAll('.carousel.slide');
        allCarousels.forEach(function(carousel) {
            carousel.addEventListener('slide.bs.carousel', function (event) {
                // 'event.target' l√† carousel ƒëang ho·∫°t ƒë·ªông
                // 'event.to' l√† ch·ªâ s·ªë (index) c·ªßa slide s·∫Øp ƒë∆∞·ª£c hi·ªÉn th·ªã (b·∫Øt ƒë·∫ßu t·ª´ 0)
                const counter = event.target.querySelector('.current-slide-number');
                if (counter) {
                    // C·∫≠p nh·∫≠t s·ªë hi·ªÉn th·ªã (c·ªông th√™m 1 v√¨ index b·∫Øt ƒë·∫ßu t·ª´ 0)
                    counter.textContent = event.to + 1;
                }
            });
        });

        // === LOGIC M·ªû MODAL CHI TI·∫æT B√ÄI VI·∫æT ===
        const postDetailModal = new bootstrap.Modal(document.getElementById('postDetailModal'));
        const postDetailModalBody = document.getElementById('postDetailModalBody');

        document.body.addEventListener('click', function(event) {
            // T√¨m xem ph·∫ßn t·ª≠ ƒë∆∞·ª£c click (ho·∫∑c cha c·ªßa n√≥) c√≥ class trigger modal kh√¥ng
            const trigger = event.target.closest('.open-post-modal');
            
            if (trigger) {
                event.preventDefault();
                const postId = trigger.dataset.postId;
                
                // 1. M·ªü modal v√† hi·ªÉn th·ªã loading
                postDetailModal.show();
                postDetailModalBody.innerHTML = `
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>`;

                // 2. Fetch n·ªôi dung t·ª´ server
                fetch(`/post/${postId}/modal/`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.text();
                    })
                    .then(html => {
                        postDetailModalBody.innerHTML = html;
                        
                        // Kh·ªüi t·∫°o l·∫°i c√°c th√†nh ph·∫ßn c·∫ßn thi·∫øt trong modal (n·∫øu c√≥)
                        // V√≠ d·ª•: Carousel Bootstrap t·ª± ch·∫°y, nh∆∞ng n·∫øu c·∫ßn init th·ªß c√¥ng th√¨ l√†m ·ªü ƒë√¢y
                    })
                    .catch(error => {
                        console.error('Error loading post detail:', error);
                        postDetailModalBody.innerHTML = '<p class="text-center text-danger mt-5">Kh√¥ng th·ªÉ t·∫£i b√†i vi·∫øt.</p>';
                    });
            }
        });

        // =======================================================
        // === LOGIC HI·ªÇN TH·ªä DANH S√ÅCH REACTION (MODAL)
        // =======================================================
        const reactionListModal = document.getElementById('reactionListModal');
        if (reactionListModal) {
            let allReactionsData = [];
            const tabsContainer = reactionListModal.querySelector('#reactionTabsContainer');
            const userListContainer = reactionListModal.querySelector('#reactionUserListContainer');

            // --- H√†m render danh s√°ch ng∆∞·ªùi d√πng ---
            function displayFilteredReactions(filterType) {
                const filteredReactions = filterType === 'ALL' 
                    ? allReactionsData 
                    : allReactionsData.filter(r => r.reaction_type === filterType);

                let html = '<ul class="list-unstyled mb-0">';
                if (filteredReactions.length > 0) {
                    filteredReactions.forEach(reaction => {
                        let reactionIcon = '';
                        if (reaction.reaction_type === 'LIKE') reactionIcon = 'üëç';
                        else if (reaction.reaction_type === 'LOVE') reactionIcon = '‚ù§Ô∏è';
                        else if (reaction.reaction_type === 'HAHA') reactionIcon = 'üòÇ';
                        else if (reaction.reaction_type === 'WOW') reactionIcon = 'üòÆ';
                        else if (reaction.reaction_type === 'SAD') reactionIcon = 'üò¢';
                        else if (reaction.reaction_type === 'ANGRY') reactionIcon = 'üò°';
                        
                        // === B·∫ÆT ƒê·∫¶U S·ª¨A ƒê·ªîI QUAN TR·ªåNG ===
                        // T·∫°o n√∫t "Nh·∫Øn tin" ch·ªâ khi is_friend l√† true
                        const messageButtonHtml = reaction.is_friend
                            ? `<a href="#" 
                                  class="btn btn-secondary btn-sm open-chat-from-modal-btn"
                                  data-conversation-id="${reaction.conversation_id}"
                                  data-username="${reaction.username}"
                                  data-avatar-url="${reaction.avatar_url}">
                                  Nh·∫Øn tin
                               </a>`
                            : ''; // N·∫øu kh√¥ng ph·∫£i b·∫°n b√®, chu·ªói r·ªóng
                        // === K·∫æT TH√öC S·ª¨A ƒê·ªîI ===

                        html += `
                            <li class="d-flex align-items-center mb-3">
                                <div class="position-relative">
                                    <a href="${reaction.profile_url}"><img src="${reaction.avatar_url}" class="rounded-circle me-3" width="40" height="40" alt="${reaction.username}" style="object-fit: cover;"></a>
                                    <span class="position-absolute bottom-0 start-0 translate-middle-y bg-white rounded-circle p-1" style="font-size: 0.9rem; line-height: 1;">${reactionIcon}</span>
                                </div>
                                <div class="flex-grow-1">
                                    <a href="${reaction.profile_url}" class="text-decoration-none text-dark fw-bold">${reaction.full_name}</a>
                                    ${reaction.mutual_friends_count > 0 ? `<div class="text-muted small">${reaction.mutual_friends_count} b·∫°n chung</div>` : ''}
                                </div>
                                ${messageButtonHtml}
                            </li>`;
                    });
                } else {
                    html += '<p class="text-center text-muted p-3">Kh√¥ng c√≥ ai b√†y t·ªè c·∫£m x√∫c n√†y.</p>';
                }
                html += '</ul>';
                userListContainer.innerHTML = html;
            }

            // --- S·ª± ki·ªán khi Modal b·∫Øt ƒë·∫ßu ƒë∆∞·ª£c hi·ªÉn th·ªã ---
            reactionListModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const postId = button.dataset.postId;
                const commentId = button.dataset.commentId;
                // Reset v√† hi·ªÉn th·ªã spinner
                tabsContainer.innerHTML = '';
                userListContainer.innerHTML = `<div class="text-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
                // X√°c ƒë·ªãnh URL API c·∫ßn g·ªçi
                let apiUrl = '';
                if (commentId) {
                    // N·∫øu c√≥ commentId -> G·ªçi API l·∫•y reaction c·ªßa comment
                    apiUrl = `/comment/${commentId}/reactions/`;
                } else if (postId) {
                    // N·∫øu c√≥ postId -> G·ªçi API l·∫•y reaction c·ªßa post
                    apiUrl = `/post/${postId}/reactions/`;
                }
                // G·ªçi API
                if (apiUrl) {
                    fetch(apiUrl)
                        .then(response => response.json())
                        .then(data => {
                            allReactionsData = data.reactions || [];
                            const counts = data.reaction_counts || {};
                            const totalReactions = allReactionsData.length;

                        // 1. T·∫°o HTML cho c√°c tab
                        let tabsHtml = `<button class="reaction-tab active" data-reaction-type="ALL">T·∫•t c·∫£ <span class="badge bg-secondary rounded-pill">${totalReactions}</span></button>`;
                        
                        const reactionOrder = ['LIKE', 'LOVE', 'HAHA', 'WOW', 'SAD', 'ANGRY'];
                        reactionOrder.forEach(type => {
                            if (counts[type]) {
                                let icon = '';
                                if (type === 'LIKE') icon = 'üëç'; else if (type === 'LOVE') icon = '‚ù§Ô∏è'; else if (type === 'HAHA') icon = 'üòÇ';
                                else if (type === 'WOW') icon = 'üòÆ'; else if (type === 'SAD') icon = 'üò¢'; else if (type === 'ANGRY') icon = 'üò°';
                                tabsHtml += `<button class="reaction-tab" data-reaction-type="${type}">${icon} <span class="badge bg-secondary rounded-pill">${counts[type]}</span></button>`;
                            }
                        });
                        tabsContainer.innerHTML = tabsHtml;

                        // 2. Hi·ªÉn th·ªã danh s√°ch "T·∫•t c·∫£" ban ƒë·∫ßu
                        displayFilteredReactions('ALL');
                    })
                    .catch(error => {
                        console.error('L·ªói khi t·∫£i danh s√°ch reaction:', error);
                        userListContainer.innerHTML = '<p class="text-center text-danger p-3">ƒê√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.</p>';
                    });
                }
            });

            // --- G·∫Øn s·ª± ki·ªán click cho c√°c tab (d√πng event delegation) ---
            tabsContainer.addEventListener('click', function(e) {
                const clickedTab = e.target.closest('.reaction-tab');
                if (clickedTab) {
                    // X√≥a class 'active' kh·ªèi t·∫•t c·∫£ c√°c tab
                    tabsContainer.querySelectorAll('.reaction-tab').forEach(tab => tab.classList.remove('active'));
                    // Th√™m class 'active' cho tab v·ª´a ƒë∆∞·ª£c click
                    clickedTab.classList.add('active');
                    // L·∫•y lo·∫°i reaction v√† l·ªçc danh s√°ch
                    const filterType = clickedTab.dataset.reactionType;
                    displayFilteredReactions(filterType);
                }
            });

            // === TH√äM M·ªöI: S·ª∞ KI·ªÜN CLICK CHO N√öT "NH·∫ÆN TIN" ===
            userListContainer.addEventListener('click', function(event) {
                const messageButton = event.target.closest('.open-chat-from-modal-btn');
                if (messageButton) {
                    event.preventDefault();
                    
                    // L·∫•y th√¥ng tin t·ª´ n√∫t b·∫•m
                    const convId = messageButton.dataset.conversationId;
                    const username = messageButton.dataset.username;
                    const avatarUrl = messageButton.dataset.avatarUrl;

                    // 1. ƒê√≥ng modal reaction
                    const modalInstance = bootstrap.Modal.getInstance(reactionListModal);
                    modalInstance.hide();
                    
                    // 2. M·ªü c·ª≠a s·ªï chat (s·ª≠ d·ª•ng l·∫°i h√†m ƒë√£ c√≥)
                    // ƒê·∫£m b·∫£o h√†m openConversation v√† c√°c bi·∫øn li√™n quan (chatPopup, openChatBtn)
                    // c√≥ th·ªÉ truy c·∫≠p ƒë∆∞·ª£c t·ª´ ƒë√¢y.
                    if (typeof openConversation === 'function') {
                        chatPopup.style.display = "flex";
                        openChatBtn.style.display = "none";
                        openConversation(convId, username, avatarUrl);
                    } else {
                        console.error("H√†m openConversation kh√¥ng t·ªìn t·∫°i.");
                    }
                }
            });
        }

        function handleCommentInputChange(event) {
            const inputField = event.target;
            const formWrapper = inputField.closest('.comment-input-wrapper');
            if (formWrapper) {
                const submitButton = formWrapper.querySelector('.comment-submit-btn');
                if (submitButton) {
                    // Hi·ªÉn th·ªã n√∫t n·∫øu c√≥ text (sau khi ƒë√£ lo·∫°i b·ªè kho·∫£ng tr·∫Øng)
                    if (inputField.value.trim().length > 0) {
                        submitButton.classList.remove('d-none');
                    } else {
                        submitButton.classList.add('d-none');
                    }
                }
            }
        }

        function handleCommentInputKeydown(event) {
            // Ch·ªâ x·ª≠ l√Ω khi nh·∫•n Enter v√† kh√¥ng nh·∫•n Shift
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // NgƒÉn h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa Enter (nh∆∞ xu·ªëng d√≤ng)
                
                const inputField = event.target;
                const formWrapper = inputField.closest('.comment-input-wrapper');
                if (formWrapper) {
                    const submitButton = formWrapper.querySelector('.comment-submit-btn');
                    if (submitButton && !submitButton.classList.contains('d-none')) {
                        // K√≠ch ho·∫°t s·ª± ki·ªán submit c·ªßa form
                        inputField.closest('form.comment-form').dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                    }
                }
            }
        }

        // D√πng event delegation ƒë·ªÉ √°p d·ª•ng cho t·∫•t c·∫£ c√°c √¥ b√¨nh lu·∫≠n
        document.body.addEventListener('input', function(event) {
            if (event.target.matches('.comment-input-ig')) {
                handleCommentInputChange(event);
            }
        });

        document.body.addEventListener('keydown', function(event) {
            if (event.target.matches('.comment-input-ig')) {
                handleCommentInputKeydown(event);
            }
        });

        // === H√ÄM TI·ªÜN √çCH: L·∫§Y COOKIE CSRF ===
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }
        const csrftoken = getCookie("csrftoken");

        // =======================================================
        // === LOGIC REACTION CHO B√ÄI VI·∫æT (POST)
        // =======================================================
        function updateReactionStatsUI(postId, stats, total) {
            const statsContainer = document.getElementById(`reaction-stats-${postId}`);
            if (!statsContainer) return;
            if (total > 0) {
                let iconsHTML = '<div class="me-2">';
                if (stats.LIKE) iconsHTML += "<span>üëç</span>";
                if (stats.LOVE) iconsHTML += "<span>‚ù§Ô∏è</span>";
                if (stats.HAHA) iconsHTML += "<span>üòÇ</span>";
                if (stats.WOW) iconsHTML += "<span>üòÆ</span>";
                if (stats.SAD) iconsHTML += "<span>üò¢</span>";
                if (stats.ANGRY) iconsHTML += "<span>üò°</span>";
                iconsHTML += "</div>";
                statsContainer.innerHTML = iconsHTML + `<span id="reactions-count-${postId}">${total}</span>`;
            } else {
                statsContainer.innerHTML = `<span id="reactions-count-${postId}" class="text-muted">Ch∆∞a c√≥ c·∫£m x√∫c</span>`;
            }
        }

        
        // D√πng event delegation cho c√°c n√∫t reaction c·ªßa b√†i vi·∫øt
        document.body.addEventListener('click', function(event) {
            const reactionButton = event.target.closest(".reaction-btn[data-post-id]");
            if (reactionButton) {
                event.preventDefault();
                const postId = reactionButton.dataset.postId;
                const reactionType = reactionButton.dataset.reactionType;

                fetch(`/post/${postId}/react/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken,
                        "X-Requested-With": "XMLHttpRequest",
                    },
                    credentials: "same-origin",
                    body: JSON.stringify({ reaction_type: reactionType }),
                })
                .then((res) => res.json())
                // THAY B·∫∞NG ƒêO·∫†N N√ÄY
                .then((data) => {
                    if (data.status === "ok") {
                        updateReactionStatsUI(postId, data.reaction_stats, data.total_reactions);

                        // === B·∫ÆT ƒê·∫¶U N√ÇNG C·∫§P: C·∫¨P NH·∫¨T N·ªòI DUNG N√öT "TH√çCH" CH√çNH ===
                        const mainPostReactionButton = document.querySelector(`.reaction-btn[data-post-id='${postId}'][data-reaction-type='LIKE'].w-100`);

                        if (mainPostReactionButton) {
                            if (data.current_user_reaction) {
                                mainPostReactionButton.classList.add('text-primary', 'fw-bold');
                                let reactionText = 'üëç Th√≠ch'; // M·∫∑c ƒë·ªãnh
                                if (data.current_user_reaction === 'LIKE') reactionText = 'üëç Th√≠ch';
                                else if (data.current_user_reaction === 'LOVE') reactionText = '‚ù§Ô∏è Y√™u th√≠ch';
                                else if (data.current_user_reaction === 'HAHA') reactionText = 'üòÇ Haha';
                                else if (data.current_user_reaction === 'WOW') reactionText = 'üòÆ Wow';
                                else if (data.current_user_reaction === 'SAD') reactionText = 'üò¢ Bu·ªìn';
                                else if (data.current_user_reaction === 'ANGRY') reactionText = 'üò° Ph·∫´n n·ªô';
                                mainPostReactionButton.innerHTML = reactionText;
                            } else {
                                mainPostReactionButton.classList.remove('text-primary', 'fw-bold');
                                mainPostReactionButton.innerHTML = 'üëç Th√≠ch';
                            }
                        }
                        // === K·∫æT TH√öC N√ÇNG C·∫§P ===

                    } else {
                        alert(data.message || "C√≥ l·ªói x·∫£y ra.");
                    }
                })
                .catch((err) => console.error("Error:", err));
            }
        });

        document.querySelectorAll(".reaction-count").forEach(function (elem) {
          elem.addEventListener("click", function () {
            let postId = this.dataset.postId;
            fetch(`/post/${postId}/reactions/detail/`)
              .then((response) => response.json())
              .then((data) => {
                let html = "";
                for (let type in data) {
                  html += `<strong>${type}</strong>: ${data[type].join(", ")}<br>`;
                }
                const detailBox = document.getElementById("reactionDetailBox");
                const modal = document.getElementById("reactionModal");
                if (detailBox && modal) {
                    detailBox.innerHTML = html;
                    new bootstrap.Modal(modal).show();
                }
              });
          });
        });

        // =======================================================
        // === LOGIC CRUD & REPLY CHO B√åNH LU·∫¨N (COMMENT)
        // =======================================================
        document.body.addEventListener('submit', function(event) {
            // --- TH√äM B√åNH LU·∫¨N & TR·∫¢ L·ªúI B√åNH LU·∫¨N (ƒê√É C·∫¨P NH·∫¨T CHO MODAL) ---
            if (event.target.classList.contains('comment-form')) {
                event.preventDefault();
                const form = event.target;
                const url = form.action;
                const formData = new FormData(form);
                const contentInput = form.querySelector('input[name=content]');

                // L·∫•y Post ID t·ª´ attribute data-post-id m√† ta v·ª´a th√™m ·ªü B∆∞·ªõc 1
                // N·∫øu kh√¥ng c√≥ (tr∆∞·ªùng h·ª£p ·ªü trang ch·ªß c≈©), ta th·ª≠ l·∫•y t·ª´ ID c·ªßa input
                let postId = form.dataset.postId; 
                if (!postId && contentInput.id) {
                    // Fallback: t√°ch ID t·ª´ chu·ªói "comment-input-123"
                    const parts = contentInput.id.split('-');
                    postId = parts[parts.length - 1];
                }

                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        
                        // === TR∆Ø·ªúNG H·ª¢P 1: L√Ä REPLY (TR·∫¢ L·ªúI B√åNH LU·∫¨N CON) ===
                        if (data.is_reply) {
                            const repliesContainer = document.getElementById(`replies-for-${data.parent_id}`);
                            if (repliesContainer) {
                                repliesContainer.insertAdjacentHTML('beforeend', data.comment_html);
                                form.closest('.reply-form-container').style.display = 'none';
                            }
                        } 
                        // === TR∆Ø·ªúNG H·ª¢P 2: L√Ä B√åNH LU·∫¨N G·ªêC (ROOT COMMENT) ===
                        else {
                            // A. X·ª≠ l√Ω hi·ªÉn th·ªã tr√™n MODAL (N·∫øu ƒëang m·ªü)
                            // T√¨m container trong modal d·ª±a v√†o ID ta ƒë√£ ƒë·∫∑t
                            const modalCommentList = document.getElementById(`modal-comments-list-${postId}`);
                            if (modalCommentList) {
                                modalCommentList.insertAdjacentHTML('beforeend', data.comment_html);
                                
                                // T·ª± ƒë·ªông cu·ªôn xu·ªëng b√¨nh lu·∫≠n m·ªõi nh·∫•t trong Modal
                                modalCommentList.scrollTo({
                                    top: modalCommentList.scrollHeight,
                                    behavior: 'smooth'
                                });
                            }

                            // B. X·ª≠ l√Ω hi·ªÉn th·ªã tr√™n TRANG CH·ª¶ (Home Feed) - ƒê·ªÉ ƒë·ªìng b·ªô d·ªØ li·ªáu
                            // Logic c≈©: t√¨m theo class cha
                            const homeSection = document.getElementById(`comments-section-${postId}`); 
                            // Ho·∫∑c t√¨m theo c√°ch c≈© n·∫øu b·∫°n ch∆∞a ƒë·∫∑t ID cho section trang ch·ªß
                            const oldStyleList = form.closest('.comments-section')?.querySelector('.comment-list');
                            
                            if (homeSection) {
                                const list = homeSection.querySelector('.comment-list');
                                if(list) list.insertAdjacentHTML('beforeend', data.comment_html);
                            } else if (oldStyleList) {
                                oldStyleList.insertAdjacentHTML('beforeend', data.comment_html);
                            }
                        }
                        
                        // X√≥a tr·∫Øng √¥ input sau khi g·ª≠i th√†nh c√¥ng
                        contentInput.value = '';
                        
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });

        document.body.addEventListener('click', function(event) {
            // --- X√ìA B√åNH LU·∫¨N (ƒê√É S·ª¨A L·ªñI) ---
            if (event.target.classList.contains('delete-comment-btn')) {
                event.preventDefault();
                if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y kh√¥ng?')) return;

                const commentId = event.target.dataset.commentId;
                // T·ª± t·∫°o URL ƒë√∫ng b·∫±ng c√°ch d√πng namespace
                const url = `/comment/${commentId}/delete/`; 

                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        const commentDiv = event.target.closest('[id^="comment-"]');
                        if (commentDiv) commentDiv.remove();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
            
            // --- M·ªû/ƒê√ìNG FORM TR·∫¢ L·ªúI ---
            if (event.target.classList.contains('reply-btn')) {
                event.preventDefault();
                const button = event.target;
                const commentId = button.dataset.commentId;
                const replyFormContainer = document.getElementById(`reply-form-for-${commentId}`);
                
                if (replyFormContainer) {
                    const isHidden = replyFormContainer.style.display === 'none' || !replyFormContainer.style.display;
                    replyFormContainer.style.display = isHidden ? 'block' : 'none';

                    if (isHidden) {
                        const replyInput = replyFormContainer.querySelector('input[name="content"]');
                        
                        // === B·∫ÆT ƒê·∫¶U PH·∫¶N TH√äM M·ªöI ===
                        // T√¨m th·∫ª div c·ªßa b√¨nh lu·∫≠n cha
                        const parentCommentDiv = button.closest('div[id^="comment-"]');
                        if (parentCommentDiv) {
                            // T√¨m t√™n t√°c gi·∫£ trong b√¨nh lu·∫≠n cha
                            const authorLink = parentCommentDiv.querySelector('.comment-author');
                            if(authorLink) {
                                const username = authorLink.textContent.trim();
                                // ƒêi·ªÅn @username v√†o √¥ tr·∫£ l·ªùi
                                replyInput.value = `@${username} `;
                            }
                        }
                        // === K·∫æT TH√öC PH·∫¶N TH√äM M·ªöI ===
                        
                        replyInput.focus();
                    }
                }
            }

            // --- B·∫ÆT ƒê·∫¶U CH·ªàNH S·ª¨A B√åNH LU·∫¨N (L·∫•y form - ƒê√É S·ª¨A L·ªñI) ---
            if (event.target.classList.contains('edit-comment-btn')) {
                event.preventDefault();
                const commentId = event.target.dataset.commentId;
                // T·ª± t·∫°o URL ƒë√∫ng b·∫±ng c√°ch d√πng namespace
                const url = `/comment/${commentId}/get-edit-form/`;
                const commentContentWrapper = document.getElementById(`comment-${commentId}`).querySelector('.comment-content-wrapper');

                fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        commentContentWrapper.dataset.originalContent = commentContentWrapper.innerHTML;
                        commentContentWrapper.innerHTML = data.form_html;
                    } else {
                        alert(data.message);
                    }
                });
            }

            // --- H·ª¶Y CH·ªàNH S·ª¨A B√åNH LU·∫¨N ---
            if (event.target.classList.contains('cancel-edit-btn')) {
                const commentContentWrapper = event.target.closest('.comment-content-wrapper');
                if (commentContentWrapper.dataset.originalContent) {
                    commentContentWrapper.innerHTML = commentContentWrapper.dataset.originalContent;
                }
            }
        });
        
        // =======================================================
        // === LOGIC REACTION CHO B√åNH LU·∫¨N (COMMENT)
        // =======================================================
        function handleCommentReaction(event) {
            event.preventDefault();
            const button = event.target.closest('.comment-reaction-btn, .comment-reaction-choice-btn');
            if (!button) return;

            const commentId = button.dataset.commentId;
            const reactionType = button.dataset.reactionType;
            const url = `/comment/${commentId}/react/`;

            if (!commentId) return;

            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' },
                body: JSON.stringify({ reaction_type: reactionType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    // 1. C·∫≠p nh·∫≠t v√πng hi·ªÉn th·ªã s·ªë l∆∞·ª£ng (Stats)
                    const statsContainer = document.getElementById(`comment-reaction-stats-${commentId}`);
                    if (statsContainer) {
                        if (data.total_reactions > 0) {
                            let iconsHTML = '';
                            // Logic ch·ªçn icon hi·ªÉn th·ªã (∆∞u ti√™n icon n√†o nhi·ªÅu ng∆∞·ªùi th·∫£ nh·∫•t - ·ªü ƒë√¢y demo hi·ªÉn th·ªã h·∫øt lo·∫°i c√≥ m·∫∑t)
                            if (data.reaction_stats.LIKE) iconsHTML += '<span>üëç</span>';
                            if (data.reaction_stats.LOVE) iconsHTML += '<span>‚ù§Ô∏è</span>';
                            if (data.reaction_stats.HAHA) iconsHTML += '<span>üòÇ</span>';
                            if (data.reaction_stats.WOW) iconsHTML += '<span>üòÆ</span>';
                            if (data.reaction_stats.SAD) iconsHTML += '<span>üò¢</span>';
                            if (data.reaction_stats.ANGRY) iconsHTML += '<span>üò°</span>';
                            
                            statsContainer.innerHTML = `<span class="d-flex align-items-center">${iconsHTML} <span class="ms-1 text-muted" style="font-size: 0.8rem;">${data.total_reactions}</span></span>`;
                            statsContainer.style.display = 'inline-block'; // Hi·ªán l√™n n·∫øu tr∆∞·ªõc ƒë√≥ b·ªã ·∫©n
                        } else {
                            statsContainer.innerHTML = '';
                            statsContainer.style.display = 'none'; // ·∫®n ƒëi n·∫øu kh√¥ng c√≤n like n√†o
                        }
                    }

                    // 2. C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t b·∫•m (M√†u xanh/x√°m)
                    const mainReactionButton = document.querySelector(`.comment-reaction-btn[data-comment-id='${commentId}']`);
                    if (mainReactionButton) {
                        if (data.current_user_reaction) {
                            mainReactionButton.classList.add('text-primary', 'fw-bold');
                            mainReactionButton.classList.remove('text-muted');
                            // C·∫≠p nh·∫≠t ch·ªØ n√∫t b·∫•m
                            let reactionText = 'Th√≠ch';
                            const map = {
                                'LIKE': 'üëç Th√≠ch', 'LOVE': '‚ù§Ô∏è Y√™u th√≠ch', 'HAHA': 'üòÇ Haha',
                                'WOW': 'üòÆ Wow', 'SAD': 'üò¢ Bu·ªìn', 'ANGRY': 'üò° Ph·∫´n n·ªô'
                            };
                            if (map[data.current_user_reaction]) reactionText = map[data.current_user_reaction];
                            mainReactionButton.innerHTML = reactionText;
                        } else {
                            mainReactionButton.classList.remove('text-primary', 'fw-bold');
                            mainReactionButton.classList.add('text-muted');
                            mainReactionButton.innerHTML = 'Th√≠ch';
                        }
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Comment Reaction Error:', error));
        }
        document.body.addEventListener('click', function(event) {
            if (event.target.closest('.comment-reaction-btn, .comment-reaction-choice-btn')) {
                handleCommentReaction(event);
            }
        });

        // =======================================================
        // === LOGIC TH√îNG B√ÅO (NOTIFICATION) - ƒê√É C·∫¨P NH·∫¨T
        // =======================================================
        {% if user.is_authenticated %}
        function updateNotificationBadge() {
        // URL c·ªßa API, s·ª≠ d·ª•ng template tag c·ªßa Django ƒë·ªÉ an to√†n h∆°n
        const apiUrl = "{% url 'notifications:get_notifications' %}"; 

        fetch(apiUrl)
            .then((resp) => resp.json())
            .then((data) => {
            const countBadge = document.getElementById("notif-count");
            
            if (!countBadge) return; // D·ª´ng l·∫°i n·∫øu kh√¥ng t√¨m th·∫•y element

            const unreadCount = data.total_unread;

            if (unreadCount > 0) {
                // N·∫øu c√≥ th√¥ng b√°o ch∆∞a ƒë·ªçc
                countBadge.innerText = unreadCount > 9 ? '9+' : unreadCount;
                countBadge.style.display = 'flex'; // Hi·ªÉn th·ªã huy hi·ªáu
            } else {
                // N·∫øu kh√¥ng c√≥ th√¥ng b√°o ch∆∞a ƒë·ªçc
                countBadge.style.display = 'none'; // ·∫®n huy hi·ªáu ƒëi
            }
            })
            .catch((err) => console.error("L·ªói khi t·∫£i th√¥ng b√°o:", err));
        }

        // Ch·∫°y h√†m l·∫ßn ƒë·∫ßu khi trang v·ª´a t·∫£i xong
        document.addEventListener("DOMContentLoaded", function() {
            updateNotificationBadge(); 
        });

        // T·ª± ƒë·ªông c·∫≠p nh·∫≠t s·ªë th√¥ng b√°o m·ªói 20 gi√¢y
        setInterval(updateNotificationBadge, 20000); 

        {% endif %}
        
        // =======================================================
        // === LOGIC WIDGET TR√í CHUY·ªÜN (PHI√äN B·∫¢N HO√ÄN CH·ªàNH) ===
        // =======================================================
        {% if user.is_authenticated %}
        const openChatBtn = document.getElementById("openChatBtn");
        const closeChatBtn = document.getElementById("closeChatBtn");
        const chatPopup = document.getElementById("chatPopup");
        const chatPopupBodyContent = document.getElementById("chatPopupBodyContent");
        const newMessageBtn = document.getElementById("newMessageBtn");
        const backFromSearchBtn = document.getElementById("back-from-search-btn");
        const searchInput = document.getElementById('search-view-input');
        const searchResultsList = document.getElementById('searchResultsList');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messageList = document.getElementById('message-list');

        let conversationsLoaded = false;
        let currentConversationId = null;

        // --- M·ªü/ƒê√≥ng Widget ---
        openChatBtn.addEventListener("click", () => {
          chatPopup.style.display = "flex";
          openChatBtn.style.display = "none";
          if (!conversationsLoaded) loadConversations();
        });

        closeChatBtn.addEventListener("click", () => { 
          chatPopup.style.display = "none"; 
          openChatBtn.style.display = "flex";
          switchToView('list'); // S·ª¨A L·ªñI: Reset v·ªÅ view ban ƒë·∫ßu khi ƒë√≥ng
          currentConversationId = null;
        });
        
        function switchToView(viewName) {
            chatPopup.classList.remove('show-detail', 'show-search');
            if (viewName === 'detail') {
                chatPopup.classList.add('show-detail');
            } else if (viewName === 'search') {
                chatPopup.classList.add('show-search');
                searchInput.value = ''; // X√≥a input c≈©
                searchResultsList.innerHTML = '<p class="text-center text-muted p-3">Nh·∫≠p √≠t nh·∫•t 2 k√Ω t·ª±.</p>';
                searchInput.focus();
            }
            // N·∫øu viewName l√† 'list' ho·∫∑c kh√¥ng c√≥, n√≥ s·∫Ω t·ª± ƒë·ªông quay v·ªÅ list
        }

        newMessageBtn.addEventListener("click", () => switchToView('search'));
        backFromSearchBtn.addEventListener("click", () => switchToView('list'));

        // --- M·ªü cu·ªôc h·ªôi tho·∫°i chi ti·∫øt ---
        chatPopupBodyContent.addEventListener('click', (event) => {
            const conversationItem = event.target.closest('.conversation-item');
            if (conversationItem) {
                event.preventDefault();
                const convId = conversationItem.dataset.conversationId;
                const username = conversationItem.dataset.username;
                const avatarUrl = conversationItem.dataset.avatarUrl;
                openConversation(convId, username, avatarUrl);
            }
        });

        function openConversation(convId, username, avatarUrl) {
            currentConversationId = convId;
            switchToView('detail'); // D√πng h√†m qu·∫£n l√Ω view

            const detailHeader = document.getElementById('chat-detail-header');
            detailHeader.innerHTML = `
                <button class="chat-back-btn" id="chat-back-btn">‚Üê</button>
                <img src="${avatarUrl}" class="avatar" alt="${username}">
                <span class="username ms-2">${username}</span>
            `;
            loadMessages(convId);

            // G·∫Øn s·ª± ki·ªán cho n√∫t back m·ªõi ƒë∆∞·ª£c t·∫°o ra
            detailHeader.querySelector('#chat-back-btn').addEventListener('click', () => {
                switchToView('list');
                currentConversationId = null;
            }, { once: true });
        }

        function loadMessages(convId) {
            const messageList = document.getElementById('message-list');
            messageList.innerHTML = '<p class="text-center text-muted p-3">ƒêang t·∫£i tin nh·∫Øn...</p>';
            
            fetch(`/chat/api/conversation/${convId}/messages/`) 
            .then(res => res.json())
            .then(data => {
                messageList.innerHTML = '';

                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        appendMessage(msg.text, msg.author_id);
                    });
                } else {
                    messageList.innerHTML = '<p class="text-center text-muted p-3">Ch∆∞a c√≥ tin nh·∫Øn n√†o. <br> H√£y b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán!</p>';
                }
                scrollToBottom();
            })
            .catch(error => {
                console.error("L·ªói t·∫£i tin nh·∫Øn:", error);
                messageList.innerHTML = '<p class="text-center text-danger p-3">Kh√¥ng th·ªÉ t·∫£i tin nh·∫Øn.</p>';
            });
        }
        
        function appendMessage(text, authorId) {
            const noMessagesP = messageList.querySelector('p');
            if (noMessagesP) noMessagesP.remove();

            const bubbleClass = authorId === {{ user.id }} ? 'message-sent' : 'message-received';
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message-bubble', bubbleClass);
            messageDiv.textContent = text; // D√πng textContent ƒë·ªÉ an to√†n h∆°n
            messageList.appendChild(messageDiv);
        }

        function scrollToBottom() {
            messageList.scrollTop = messageList.scrollHeight;
        }
        
        // G·∫Øn s·ª± ki·ªán click cho c·∫£ danh s√°ch h·ªôi tho·∫°i
        chatPopupBodyContent.addEventListener('click', (event) => {
            const conversationItem = event.target.closest('.conversation-item');
            if (conversationItem) {
                event.preventDefault();
                const convId = conversationItem.dataset.conversationId;
                const username = conversationItem.dataset.username;
                const avatarUrl = conversationItem.dataset.avatarUrl;
                if (convId) {
                    openConversation(convId, username, avatarUrl);
                }
            }
        });

        // --- Load danh s√°ch h·ªôi tho·∫°i ban ƒë·∫ßu ---
        function loadConversations() {
          fetch("{% url 'chat:api_get_conversations' %}")
            .then(res => res.json())
            .then(data => {
              chatPopupBodyContent.innerHTML = "";
              if (data.conversations && data.conversations.length > 0) {
                data.conversations.forEach(conv => {
                  const avatarUrl = conv.other_participant.avatar_url || '/static/images/default_avatar.png'; // Thay b·∫±ng ƒë∆∞·ªùng d·∫´n ·∫£nh m·∫∑c ƒë·ªãnh c·ªßa b·∫°n
                  
                  // S·ª¨A D√íNG "data-conversation-id" B√äN D∆Ø·ªöI
                  chatPopupBodyContent.innerHTML += `
                    <a href="#" class="conversation-item" 
                      data-conversation-id="${conv.conversation_id}" 
                      data-username="${conv.other_participant.username}"
                      data-avatar-url="${avatarUrl}">
                      <img src="${avatarUrl}" class="avatar" alt="${conv.other_participant.username}">
                      <div class="message-details">
                        <p class="username">${conv.other_participant.username}</p>
                        <p class="last-message">${conv.last_message || "B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán"}</p>
                      </div>
                    </a>`;
                });
              } else {
                chatPopupBodyContent.innerHTML = '<p class="text-center text-muted p-5">Kh√¥ng c√≥ cu·ªôc tr√≤ chuy·ªán n√†o.</p>';
              }
              conversationsLoaded = true;
            });
        }

        // --- B·ªï sung logic g·ª≠i tin nh·∫Øn (quan tr·ªçng) ---
        messageForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const text = messageInput.value.trim();
            if (!text || !currentConversationId) return;

            const formData = new FormData();
            formData.append('text', text);

            fetch(`/chat/api/message/send/${currentConversationId}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    appendMessage(data.text, {{ user.id }});
                    scrollToBottom();
                    messageInput.value = '';
                } else {
                    alert("G·ª≠i tin nh·∫Øn th·∫•t b·∫°i.");
                }
            })
            .catch(err => console.error("L·ªói g·ª≠i tin nh·∫Øn:", err));
        });
        
        // ... (Ph·∫ßn code t√¨m ki·∫øm ng∆∞·ªùi d√πng v√† g·ª≠i tin nh·∫Øn gi·ªØ nguy√™n)
        let searchTimeout;
        searchInput.addEventListener("keyup", function () {
            clearTimeout(searchTimeout);
            const query = searchInput.value.trim();
            if (query.length < 2) {
                searchResultsList.innerHTML = '<p class="text-center text-muted p-3">Nh·∫≠p √≠t nh·∫•t 2 k√Ω t·ª±.</p>';
                return;
            }
            searchResultsList.innerHTML = '<p class="text-center text-muted p-3">ƒêang t√¨m...</p>';
            searchTimeout = setTimeout(() => {
                fetch(`{% url 'chat:api_search_users' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    searchResultsList.innerHTML = "";
                    if (data.users && data.users.length > 0) {
                        data.users.forEach(user => {
                            searchResultsList.innerHTML += `
                                <a href="${user.start_conversation_url}" class="conversation-item">
                                    <img src="${user.avatar_url || '/static/images/default_avatar.png'}" class="avatar" alt="${user.username}">
                                    <div class="message-details">
                                        <p class="username">${user.full_name}</p>
                                    </div>
                                </a>`;
                        });
                    } else {
                        searchResultsList.innerHTML = '<p class="text-center text-muted p-3">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng.</p>';
                    }
                });
            }, 300);
        });
        {% endif %}
        
        // =======================================================
        // === LOGIC T·∫¢I TH√äM B√åNH LU·∫¨N
        // =======================================================
        document.body.addEventListener('click', function(event) {
            if (event.target.classList.contains('load-more-comments')) {
                event.preventDefault();
                
                const button = event.target;
                const spinner = button.nextElementSibling; // L·∫•y c√°i spinner b√™n c·∫°nh
                const postId = button.dataset.postId;
                const offset = button.dataset.offset;

                // Hi·ªÉn th·ªã loading v√† v√¥ hi·ªáu h√≥a n√∫t
                button.classList.add('d-none');
                spinner.classList.remove('d-none');

                fetch(`/post/${postId}/load-comments/?offset=${offset}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.html) {
                            const commentList = button.closest('.comments-section').querySelector('.comment-list');
                            commentList.insertAdjacentHTML('beforeend', data.html);
                        }

                        // C·∫≠p nh·∫≠t ho·∫∑c x√≥a n√∫t
                        if (data.has_more) {
                            button.dataset.offset = data.new_offset;
                            button.classList.remove('d-none');
                        } else {
                            button.parentElement.remove(); // X√≥a c·∫£ div b·ªçc ngo√†i n√∫t
                        }
                    })
                    .catch(error => console.error('Error loading comments:', error))
                    .finally(() => {
                        // Lu√¥n ·∫©n spinner sau khi xong
                        spinner.classList.add('d-none');
                    });
            }
        });
        // =======================================================
        // === LOGIC FOCUS V√ÄO √î B√åNH LU·∫¨N KHI CLICK N√öT COMMENT
        // =======================================================
        document.body.addEventListener('click', function(event) {
            // Ki·ªÉm tra xem ph·∫ßn t·ª≠ ƒë∆∞·ª£c click c√≥ ph·∫£i l√† n√∫t "B√¨nh lu·∫≠n" kh√¥ng
            const commentButton = event.target.closest('.comment-button');
            
            if (commentButton) {
                // NgƒÉn h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª <a> (l√† nh·∫£y l√™n ƒë·∫ßu trang)
                event.preventDefault();
                
                // L·∫•y ID c·ªßa b√†i vi·∫øt t·ª´ thu·ªôc t√≠nh data-post-id
                const postId = commentButton.dataset.postId;
                
                // T√¨m √¥ input t∆∞∆°ng ·ª©ng b·∫±ng ID m√† ch√∫ng ta ƒë√£ ƒë·∫∑t
                const commentInput = document.getElementById(`comment-input-${postId}`);
                
                // N·∫øu t√¨m th·∫•y, di chuy·ªÉn con tr·ªè chu·ªôt v√†o ƒë√≥
                if (commentInput) {
                    commentInput.focus();
                }
            }
        });
      });
    </script>

  </body>
</html>