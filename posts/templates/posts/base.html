<!-- posts/templates/posts/base.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MySocial</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="...bootstrap.bundle.min.js..."></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <!-- URL 'home' kh√¥ng c√≥ namespace v√¨ n√≥ n·∫±m trong URL g·ªëc -->
        <a class="navbar-brand" href="{% url 'home' %}">MySocial</a>
        <div class="d-flex">
          {% if user.is_authenticated %}
          <!-- N√öT L·ªúI M·ªúI K·∫æT B·∫†N -->
          <a
            href="{% url 'accounts:friend_requests' %}"
            class="btn btn-outline-secondary position-relative me-3"
          >
            L·ªùi m·ªùi {% if unread_notifications_count > 0 %}
            <span
              class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
            >
              {{ unread_notifications_count }}
            </span>
            {% endif %}
          </a>
          <!-- S·ª¨A ·ªû ƒê√ÇY -->
          <a
            href="{% url 'accounts:user_list' %}"
            class="btn btn-outline-primary me-3"
            >T√¨m b·∫°n</a
          >

          <span class="navbar-text me-3">
            <!-- S·ª¨A ·ªû ƒê√ÇY -->
            <a
              href="{% url 'accounts:profile' username=user.username %}"
              class="text-dark text-decoration-none"
            >
              Ch√†o, {{ user.username }}!
            </a>
          </span>
          <!-- S·ª¨A ·ªû ƒê√ÇY -->
          <a href="{% url 'accounts:logout' %}" class="btn btn-outline-danger"
            >ƒêƒÉng xu·∫•t</a
          >
          {% else %}
          <!-- S·ª¨A ·ªû ƒê√ÇY -->
          <a
            href="{% url 'accounts:login' %}"
            class="btn btn-outline-success me-2"
            >ƒêƒÉng nh·∫≠p</a
          >
          <!-- S·ª¨A ·ªû ƒê√ÇY -->
          <a href="{% url 'accounts:register' %}" class="btn btn-primary"
            >ƒêƒÉng k√Ω</a
          >
          {% endif %}
        </div>
      </div>
    </nav>

    <main class="container mt-4">
      {% block content %} {% endblock content %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- === TH√äM ƒêO·∫†N SCRIPT SAU === -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // L·∫•y cookie theo t√™n (chu·∫©n Django docs)
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(
                  cookie.substring(name.length + 1)
                );
                break;
              }
            }
          }
          return cookieValue;
        }

        const csrftoken = getCookie("csrftoken");

        function updateReactionStatsUI(postId, stats, total) {
          const statsContainer = document.getElementById(
            `reaction-stats-${postId}`
          );
          if (!statsContainer) return;
          if (total > 0) {
            let iconsHTML = '<div class="me-2">';
            if (stats.LIKE) iconsHTML += "<span>üëç</span>";
            if (stats.LOVE) iconsHTML += "<span>‚ù§Ô∏è</span>";
            if (stats.HAHA) iconsHTML += "<span>üòÇ</span>";
            if (stats.WOW) iconsHTML += "<span>üòÆ</span>";
            if (stats.SAD) iconsHTML += "<span>üò¢</span>";
            if (stats.ANGRY) iconsHTML += "<span>üò°</span>";
            iconsHTML += "</div>";
            statsContainer.innerHTML =
              iconsHTML +
              `<span id="reactions-count-${postId}">${total}</span>`;
          } else {
            statsContainer.innerHTML = `<span id="reactions-count-${postId}" class="text-muted">Ch∆∞a c√≥ c·∫£m x√∫c</span>`;
          }
        }

        function highlightSelectedReaction(postId, selectedType) {
          const buttons = document.querySelectorAll(
            `.reaction-btn[data-post-id='${postId}']`
          );
          buttons.forEach((btn) => {
            if (btn.dataset.reactionType === selectedType) {
              btn.classList.add("fw-bold", "text-primary");
            } else {
              btn.classList.remove("fw-bold", "text-primary");
            }
          });
        }

        document.querySelectorAll(".reaction-btn").forEach((button) => {
          button.addEventListener("click", function (e) {
            e.preventDefault();
            const postId = this.dataset.postId;
            const reactionType = this.dataset.reactionType;

            fetch(`/post/${postId}/react/`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken, // t√™n header ph·∫£i ƒë√∫ng
                "X-Requested-With": "XMLHttpRequest", // optional nh∆∞ng n√™n c√≥
              },
              credentials: "same-origin", // g·ª≠i k√®m cookie csrftoken
              body: JSON.stringify({ reaction_type: reactionType }),
            })
              .then((res) => res.json())
              .then((data) => {
                if (data.status === "ok") {
                  updateReactionStatsUI(
                    postId,
                    data.reaction_stats,
                    data.total_reactions
                  );
                  highlightSelectedReaction(postId, data.current_user_reaction);
                } else {
                  alert(data.message || "C√≥ l·ªói x·∫£y ra.");
                }
              })
              .catch((err) => console.error("Error:", err));
          });
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".reaction-count").forEach(function (elem) {
          elem.addEventListener("click", function () {
            let postId = this.dataset.postId;

            fetch(`/post/${postId}/reactions/detail/`)
              .then((response) => response.json())
              .then((data) => {
                let html = "";
                for (let type in data) {
                  html += `<strong>${type}</strong>: ${data[type].join(
                    ", "
                  )}<br>`;
                }
                document.getElementById("reactionDetailBox").innerHTML = html;
                new bootstrap.Modal(
                  document.getElementById("reactionModal")
                ).show();
              });
          });
        });
      });
    </script>
  </body>
</html>
